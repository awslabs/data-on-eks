<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-benchmarks/spark-operator-benchmark/running-the-benchmark" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.8.1"><title data-rh=true>Running Spark Benchmark Tests on Amazon EKS | Data on EKS</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://awslabs.github.io/data-on-eks/docs/benchmarks/spark-operator-benchmark/running-the-benchmark><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Running Spark Benchmark Tests on Amazon EKS | Data on EKS"><meta data-rh=true name=description content="The following guide provides instructions on how to execute the TPCDS benchmark tests for Spark."><meta data-rh=true property=og:description content="The following guide provides instructions on how to execute the TPCDS benchmark tests for Spark."><link data-rh=true rel=icon href=/data-on-eks/img/header-icon.png><link data-rh=true rel=canonical href=https://awslabs.github.io/data-on-eks/docs/benchmarks/spark-operator-benchmark/running-the-benchmark><link data-rh=true rel=alternate href=https://awslabs.github.io/data-on-eks/docs/benchmarks/spark-operator-benchmark/running-the-benchmark hreflang=en><link data-rh=true rel=alternate href=https://awslabs.github.io/data-on-eks/docs/benchmarks/spark-operator-benchmark/running-the-benchmark hreflang=x-default><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://awslabs.github.io/data-on-eks/docs/category/spark-benchmarks","name":"Spark Benchmarks","position":1},{"@type":"ListItem","item":"https://awslabs.github.io/data-on-eks/docs/benchmarks/spark-operator-benchmark/running-the-benchmark","name":"Running the Benchmarks","position":2}]}</script><link rel=stylesheet href=/data-on-eks/assets/css/styles.c8db921d.css><script src=/data-on-eks/assets/js/runtime~main.d9f1c0dc.js defer></script><script src=/data-on-eks/assets/js/main.825e5795.js defer></script><body class=navigation-with-keyboard><svg xmlns=http://www.w3.org/2000/svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/data-on-eks/><div class=navbar__logo><img src=/data-on-eks/img/header-icon.png alt="DoEKS Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src=/data-on-eks/img/header-icon.png alt="DoEKS Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href=/data-on-eks/docs/blueprints/data-analytics>Blueprints</a><a class="navbar__item navbar__link" href=/data-on-eks/docs/bestpractices/intro>Best Practices</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/data-on-eks/docs/benchmarks/emr-on-eks>Benchmarks</a><a class="navbar__item navbar__link" href=/data-on-eks/docs/resources/intro>Resources</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href=https://github.com/awslabs/data-on-eks target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill=currentColor d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"/></svg></button></div><div class=navbarSearchContainer_Bca1><div class=navbar__search><span aria-label="expand searchbar" role=button class=search-icon tabindex=0></span><input id=search_input_react type=search placeholder=Loading... aria-label=Search class="navbar__search-input search-bar" disabled></div></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/data-on-eks/docs/benchmarks/emr-on-eks>EMR on EKS Benchmarks</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/data-on-eks/docs/category/spark-benchmarks>Spark Benchmarks</a><button aria-label="Collapse sidebar category 'Spark Benchmarks'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/data-on-eks/docs/benchmarks/spark-operator-benchmark/spark-operator-eks-benchmark>Introduction to Spark Benchmarks</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/data-on-eks/docs/benchmarks/spark-operator-benchmark/data-generation>Data Generation</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/data-on-eks/docs/benchmarks/spark-operator-benchmark/running-the-benchmark>Running the Benchmarks</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/data-on-eks/docs/benchmarks/spark-operator-benchmark/graviton-r-data>Gravtion R-series Results</a></ul><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/data-on-eks/docs/benchmarks/spark-operator-eks-benchmark>Kubeflow Spark Operator Benchmarks</a></ul></nav><button type=button title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width=20 height=20 aria-hidden=true class=collapseSidebarButtonIcon_kv0_><g fill=#7a7a7a><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"/><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"/></g></svg></button></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/data-on-eks/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class=breadcrumbs__item><a class=breadcrumbs__link href=/data-on-eks/docs/category/spark-benchmarks><span>Spark Benchmarks</span></a><li class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link>Running the Benchmarks</span></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Running Spark Benchmark Tests on Amazon EKS</h1></header>
<p>The following guide provides instructions on how to execute the TPCDS benchmark tests for Spark.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=deploying-the-benchmark-toolkit>Deploying the Benchmark toolkit<a href=#deploying-the-benchmark-toolkit class=hash-link aria-label="Direct link to Deploying the Benchmark toolkit" title="Direct link to Deploying the Benchmark toolkit">​</a></h2>
<p>In this <a href=https://github.com/awslabs/data-on-eks/tree/main/analytics/terraform/spark-k8s-operator target=_blank rel="noopener noreferrer">example</a>, you will provision the following resources required to run Spark Jobs with open source Spark Operator.</p>
<p>This example deploys an EKS Cluster running the Spark K8s Operator into a new VPC.</p>
<ul>
<li>Creates a new sample VPC, 2 Private Subnets, 2 Public Subnets, and 2 subnets in the RFC6598 space (100.64.0.0/10) for EKS Pods.</li>
<li>Creates Internet gateway for Public Subnets and NAT Gateway for Private Subnets</li>
<li>Creates EKS Cluster Control plane with public endpoint (for demo reasons only) with Managed Node Groups for benchmarking and core services, and Karpenter NodePools for Spark workloads.</li>
<li>Deploys Metrics server, Spark-operator, Apache Yunikorn, Karpenter, Cluster Autoscaler, Grafana, AMP and Prometheus server.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=prerequisites>Prerequisites<a href=#prerequisites class=hash-link aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h3>
<p>Ensure that you have installed the following tools on your machine.</p>
<ol>
<li><a href=https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html target=_blank rel="noopener noreferrer">aws cli</a></li>
<li><a href=https://Kubernetes.io/docs/tasks/tools/ target=_blank rel="noopener noreferrer">kubectl</a></li>
<li><a href=https://learn.hashicorp.com/tutorials/terraform/install-cli target=_blank rel="noopener noreferrer">terraform</a></li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=deploy>Deploy<a href=#deploy class=hash-link aria-label="Direct link to Deploy" title="Direct link to Deploy">​</a></h3>
<p>Clone the repository.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token function" style=color:#d73a49>git</span><span class="token plain"> clone https://github.com/awslabs/data-on-eks.git</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> data-on-eks</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style=color:#36acaa>DOEKS_HOME</span><span class="token operator" style=color:#393A34>=</span><span class="token variable" style=color:#36acaa>$(</span><span class="token variable builtin class-name" style=color:#36acaa>pwd</span><span class="token variable" style=color:#36acaa>)</span><br></span></code></pre></div></div>
<p>If DOEKS_HOME is ever unset, you can always set it manually using <code>export DATA_ON_EKS=$(pwd)</code> from your data-on-eks directory.</p>
<p>Navigate into the following directory and run <code>install.sh</code> script.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token variable" style=color:#36acaa>${DOEKS_HOME}</span><span class="token plain">/analytics/terraform/spark-k8s-operator</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>chmod</span><span class="token plain"> +x install.sh</span><br></span><span class=token-line style=color:#393A34><span class="token plain">./install.sh</span><br></span></code></pre></div></div>
<p>Now create an S3_BUCKET variable that holds the name of the bucket created
during the install. This bucket will be used in later examples to store output
data. If S3_BUCKET is ever unset, you can run the following commands again.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style=color:#36acaa>S3_BUCKET</span><span class="token operator" style=color:#393A34>=</span><span class="token variable" style=color:#36acaa>$(</span><span class="token variable" style=color:#36acaa>terraform output </span><span class="token variable parameter variable" style=color:#36acaa>-raw</span><span class="token variable" style=color:#36acaa> s3_bucket_id_spark_history_server</span><span class="token variable" style=color:#36acaa>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token variable" style=color:#36acaa>$S3_BUCKET</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=create-the-test-dataset-for-running-the-tpcds-benchmark>Create the Test Dataset for Running the TPCDS Benchmark<a href=#create-the-test-dataset-for-running-the-tpcds-benchmark class=hash-link aria-label="Direct link to Create the Test Dataset for Running the TPCDS Benchmark" title="Direct link to Create the Test Dataset for Running the TPCDS Benchmark">​</a></h3>
<p>The Benchmark requires an S3 bucket with input data to query and save the results back to.
If you don't have a data set in S3 you can use this same cluster to <a href=/data-on-eks/docs/benchmarks/spark-operator-benchmark/data-generation>run the Data Generation job</a> to create one.</p>
<p>Once you have an S3 bucket with the example data set, you can run the benchmark Job</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=running-the-tpcds-benchmark>Running the TPCDS Benchmark<a href=#running-the-tpcds-benchmark class=hash-link aria-label="Direct link to Running the TPCDS Benchmark" title="Direct link to Running the TPCDS Benchmark">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=scale-up-the-worker-nodes>Scale up the worker nodes<a href=#scale-up-the-worker-nodes class=hash-link aria-label="Direct link to Scale up the worker nodes" title="Direct link to Scale up the worker nodes">​</a></h3>
<p>For these benchmarks we are not measuring the scaling speed but are focusing on the performance of the Spark SQL queries and the job runtime. To ensure the job is not interrupted by scaling activities or Spot interruptions we recommend using a Managed Node Group for the benchmarks, and scaling the capacity up before submitting the jobs</p>
<p>The blueprint <a href=https://github.com/awslabs/data-on-eks/blob/main/analytics/terraform/spark-k8s-operator/eks.tf#L120-L207 target=_blank rel="noopener noreferrer">creates two Managed Node Groups</a> that we use for these benchmarks:</p>
<ul>
<li><code>spark_benchmark_ebs</code> - This nodegroup is configured for instances without NVMe storage such as r6g or c5</li>
<li><code>spark_benchmark_ssd</code> - This nodegroup will setup a RAID over NVMe devices available on the instances. This is perfect for instances with NVMe storage like r6gd, and c5d.
These nodegroups are scaled to 0 by default to save on costs, but you can configure the instance type you would like to benchmark on and then set the <code>min_size</code> and <code>desired_size</code> for the node group.</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 12 16"><path fill-rule=evenodd d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"/></svg></span>tip</div><div class=admonitionContent_BuS1><p>The number of nodes required varies based on the size of the instance and the resource requests of the executot Pods used in the benchmark. Currently the benchmark requests 36 executors, each requesting 5vCPU and 26Gi memory, for a total of 180vCPU and 936Gi memory. This will fit on six r6g.12xlarge instances. You can compare the benchmark manifest against the instance types you'd like to use to find the required number of EC2 instances.</div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=set-the-s3-bucket-for-inputoutput>Set the S3 Bucket for input/output<a href=#set-the-s3-bucket-for-inputoutput class=hash-link aria-label="Direct link to Set the S3 Bucket for input/output" title="Direct link to Set the S3 Bucket for input/output">​</a></h3>
<p>You will need to replace the <em>&lt;S3_BUCKET></em> placeholders in the benchmark file with the name of the bucket
created earlier. You can get that value by running <code>echo $S3_BUCKET</code>.</p>
<p>To do this automatically you can run the following, which will create a .old
backup file and do the replacement for you.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token variable" style=color:#36acaa>${DOEKS_HOME}</span><span class="token plain">/analytics/terraform/spark-k8s-operator/examples/benchmark</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token function" style=color:#d73a49>sed</span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>-i.old</span><span class="token plain"> s/</span><span class="token punctuation" style=color:#393A34>\</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">S3_BUCKET</span><span class="token punctuation" style=color:#393A34>\</span><span class="token operator" style=color:#393A34>></span><span class="token plain">/</span><span class="token variable" style=color:#36acaa>${S3_BUCKET}</span><span class="token plain">/g ./tpcds-benchmark-1t-ebs.yaml</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=submit-the-benchmark-job>Submit the Benchmark Job<a href=#submit-the-benchmark-job class=hash-link aria-label="Direct link to Submit the Benchmark Job" title="Direct link to Submit the Benchmark Job">​</a></h3>
<p>Then to begin the data generation execute the command below</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">kubectl apply </span><span class="token parameter variable" style=color:#36acaa>-f</span><span class="token plain"> tpcds-benchmark-1t-ebs.yaml</span><br></span></code></pre></div></div>
<p>Once you apply the <code>tpcds-benchmark-1t-ebs.yaml</code> manifest, you should see the the driver and executor Pods coming up. It takes about an hour to finish the execution of a single iteration of the benchmark queries.</p>
<p>You can monitor the status of the job by checking the Spark driver Pod execution status and logs</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">kubectl get pod </span><span class="token parameter variable" style=color:#36acaa>-n</span><span class="token plain"> spark-team-a</span><br></span></code></pre></div></div>
<p>Output:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">NAME                             READY   STATUS    RESTARTS   AGE     IP               NODE                             NOMINATED NODE   READINESS GATES</span><br></span><span class=token-line style=color:#393A34><span class="token plain">benchmark-exec-ebs-exec-1        </span><span class="token number" style=color:#36acaa>1</span><span class="token plain">/1     Running   </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">          75s     </span><span class="token number" style=color:#36acaa>100.64</span><span class="token plain">.251.188   ip-100-64-219-156.ec2.internal   </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><span class="token plain">           </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">benchmark-exec-ebs-exec-10       </span><span class="token number" style=color:#36acaa>1</span><span class="token plain">/1     Running   </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">          73s     </span><span class="token number" style=color:#36acaa>100.64</span><span class="token plain">.213.1     ip-100-64-146-124.ec2.internal   </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><span class="token plain">           </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>..</span><span class="token plain">.</span><br></span><span class=token-line style=color:#393A34><span class="token plain">benchmark-exec-ebs-exec-8        </span><span class="token number" style=color:#36acaa>1</span><span class="token plain">/1     Running   </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">          74s     </span><span class="token number" style=color:#36acaa>100.64</span><span class="token plain">.202.23    ip-100-64-219-156.ec2.internal   </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><span class="token plain">           </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">benchmark-exec-ebs-exec-9        </span><span class="token number" style=color:#36acaa>1</span><span class="token plain">/1     Running   </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">          73s     </span><span class="token number" style=color:#36acaa>100.64</span><span class="token plain">.238.20    ip-100-64-175-12.ec2.internal    </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><span class="token plain">           </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">tpcds-benchmark-1tb-ebs-driver   </span><span class="token number" style=color:#36acaa>1</span><span class="token plain">/1     Running   </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">          2m33s   </span><span class="token number" style=color:#36acaa>100.64</span><span class="token plain">.228.162   ip-100-64-213-174.ec2.internal   </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><span class="token plain">           </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><br></span></code></pre></div></div>
<p>The benchmark is also configured to export metrics and logs so you can review the benchmark using the <a href=https://awslabs.github.io/data-on-eks/docs/blueprints/data-analytics/observability-spark-on-eks#spark-history-server target=_blank rel="noopener noreferrer">Spark Observability tools explained here</a>.</p>
<p>To get an idea how far along the benchmark is, you can use the Spark Web UI to review which query is currently being executed.
Port forward to the Benchmark Driver to see the UI:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">kubectl port-forward </span><span class="token parameter variable" style=color:#36acaa>-n</span><span class="token plain"> spark-team-a service/tpcds-benchmark-1tb-ebs-ui-svc </span><span class="token number" style=color:#36acaa>4040</span><span class="token plain">:4040</span><br></span></code></pre></div></div>
<p>Then open browser and enter localhost:4040. You can review the jobs that are running and that have completed. The benchmark will run the SQL queries sequentially so you can estimate how far along the job is by checking the query number.</p>
<p><img decoding=async loading=lazy alt="Spark web UI with TPCDS query numbers" src=/data-on-eks/assets/images/benchmark-sql-page-529b6e0fa019cde646852e384deacbf0.png width=1875 height=816 class=img_ev3q></p>
<p>Once the benchmark has completed you can scale the Nodgroup back to zero to save costs, and you can delete the remaining SparkApplication with the commands below:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token variable" style=color:#36acaa>${DOEKS_HOME}</span><span class="token plain">/analytics/terraform/spark-k8s-operator/examples/benchmark</span><br></span><span class=token-line style=color:#393A34><span class="token plain">kubectl delete </span><span class="token parameter variable" style=color:#36acaa>-f</span><span class="token plain"> tpcds-benchmark-1t-ebs.yaml</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=reviewing-the-results>Reviewing the Results<a href=#reviewing-the-results class=hash-link aria-label="Direct link to Reviewing the Results" title="Direct link to Reviewing the Results">​</a></h2>
<p>When the benchmark completes it will place the results from the benchmark in the S3 bucket specified in the manifest file (default: <code>s3a://&lt;S3_BUCKET>/TPCDS-TEST-1T-RESULT</code>). You can navigate to the S3 console for the corresponding S3 bucket and enter the directory:</p>
<p><img decoding=async loading=lazy alt="S3 bucket showing directories for results" src=/data-on-eks/assets/images/results-s3-root-c9a5664477255a57420745904b1ee487.png width=1348 height=197 class=img_ev3q></p>
<p>When you enter the results directory you will see a list of folders which correspond to the timestamps the job was run:</p>
<p><img decoding=async loading=lazy alt="S3 bucket showing timestamp directories for results" src=/data-on-eks/assets/images/results-s3-timestamps-1ad4e85f033ea51abf608c691306b4b7.png width=1539 height=218 class=img_ev3q></p>
<p>You can find the latest result by selecting the timestamp that's largest, or find the folder that corresponds to the time of your test.
Inside this folder you will see a file with a name like <code>part-00000-000000000-0000-0000-0000-000000000-0000.json</code>, this file includes the full spark configuration used for the job.
<img decoding=async loading=lazy alt="S3 bucket showing results files" src=/data-on-eks/assets/images/results-s3-result-folder-3904057523744189c691fd08818c5652.png width=1537 height=234 class=img_ev3q></p>
<p>Inside the subfolder named <code>summary.csv</code>, the <code>part-00000-000000000-0000-0000-0000-000000000-0000.csv</code> file includes the results of the benchmark.
<img decoding=async loading=lazy alt="S3 bucket showing results files" src=/data-on-eks/assets/images/results-s3-csv-e6aa521269467368520ace241d3752ea.png width=1537 height=228 class=img_ev3q></p>
<p>If you open this csv file you will see 4 columns of data which show the time taken to process each query. The file does not include column headers, the columns from left to right are:</p>
<ul>
<li>the TPCDS Query number</li>
<li>the median time that it took to process that query</li>
<li>the minimum time that it took to process that query</li>
<li>the maximum time that it took to process that query</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 12 16"><path fill-rule=evenodd d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"/></svg></span>tip</div><div class=admonitionContent_BuS1><p>If the benchmark ran for a single iiteration (as is the default) then all three columns will display the same times.</div></div>
<p>This image shows the output for 3 iterations with column headers added for clarity:
<img decoding=async loading=lazy alt="S3 bucket showing results files" src=/data-on-eks/assets/images/results-data-exmp-26dc8e629f884bf73bd2c65b0d20814b.png width=575 height=283 class=img_ev3q></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=cost-considerations>Cost Considerations<a href=#cost-considerations class=hash-link aria-label="Direct link to Cost Considerations" title="Direct link to Cost Considerations">​</a></h2>
<p>When utilizing c5d instances for data generation, it's important to keep cost implications in mind. These compute-optimized instances with local NVMe storage offer high performance but can be more expensive than standard c5 instances. To optimize costs, it's crucial to carefully monitor usage and scale resources appropriately. The local NVMe storage provides fast I/O, but data persistence is not guaranteed, so you should factor in the cost of data transfer and backup solutions. Spot instances can offer significant savings for interruptible workloads. Additionally, reserving instances for long-term, predictable usage can lead to substantial discounts. Also, it's essential to terminate these instances when they're no longer needed by adjusting the nodegroup's minimum and desired size to 0. This practice helps avoid unnecessary costs from idle resources.</p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 16 16"><path fill-rule=evenodd d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"/></svg></span>caution</div><div class=admonitionContent_BuS1><p>To avoid unwanted charges to your AWS account, delete all the AWS resources created during this deployment</div></div>
<p>This script will cleanup the environment using <code>-target</code> option to ensure all the resources are deleted in correct order.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token variable" style=color:#36acaa>${DOEKS_HOME}</span><span class="token plain">/analytics/terraform/spark-k8s-operator </span><span class="token operator" style=color:#393A34>&&</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>chmod</span><span class="token plain"> +x cleanup.sh</span><br></span><span class=token-line style=color:#393A34><span class="token plain">./cleanup.sh</span><br></span></code></pre></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/awslabs/data-on-eks/blob/main/website/docs/benchmarks/spark-operator-benchmark/running-the-benchmark.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/data-on-eks/docs/benchmarks/spark-operator-benchmark/data-generation><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Data Generation</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/data-on-eks/docs/benchmarks/spark-operator-benchmark/graviton-r-data><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Gravtion R-series Results</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#deploying-the-benchmark-toolkit class="table-of-contents__link toc-highlight">Deploying the Benchmark toolkit</a><ul><li><a href=#prerequisites class="table-of-contents__link toc-highlight">Prerequisites</a><li><a href=#deploy class="table-of-contents__link toc-highlight">Deploy</a><li><a href=#create-the-test-dataset-for-running-the-tpcds-benchmark class="table-of-contents__link toc-highlight">Create the Test Dataset for Running the TPCDS Benchmark</a></ul><li><a href=#running-the-tpcds-benchmark class="table-of-contents__link toc-highlight">Running the TPCDS Benchmark</a><ul><li><a href=#scale-up-the-worker-nodes class="table-of-contents__link toc-highlight">Scale up the worker nodes</a><li><a href=#set-the-s3-bucket-for-inputoutput class="table-of-contents__link toc-highlight">Set the S3 Bucket for input/output</a><li><a href=#submit-the-benchmark-job class="table-of-contents__link toc-highlight">Submit the Benchmark Job</a></ul><li><a href=#reviewing-the-results class="table-of-contents__link toc-highlight">Reviewing the Results</a><li><a href=#cost-considerations class="table-of-contents__link toc-highlight">Cost Considerations</a></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Get Started</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/data-on-eks/docs/introduction/intro>Docs</a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Get Involved</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://github.com/awslabs/data-on-eks target=_blank rel="noopener noreferrer" class=footer__link-item>Github<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Built with ❤️ at AWS  <br> © 2025 Amazon.com, Inc. or its affiliates. All Rights Reserved</div></div></div></footer><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "7fbc7ab02fae4767b1af2588eba0cdf2"}'></script></div>