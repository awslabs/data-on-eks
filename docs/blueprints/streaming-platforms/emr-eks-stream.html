<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-blueprints/streaming-platforms/emr-eks-stream" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">EMR on EKS with Spark Streaming | Data on EKS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://awslabs.github.io/data-on-eks/docs/blueprints/streaming-platforms/emr-eks-stream"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="EMR on EKS with Spark Streaming | Data on EKS"><meta data-rh="true" name="description" content="DEPRECATION NOTICE"><meta data-rh="true" property="og:description" content="DEPRECATION NOTICE"><link data-rh="true" rel="icon" href="/data-on-eks/img/header-icon.png"><link data-rh="true" rel="canonical" href="https://awslabs.github.io/data-on-eks/docs/blueprints/streaming-platforms/emr-eks-stream"><link data-rh="true" rel="alternate" href="https://awslabs.github.io/data-on-eks/docs/blueprints/streaming-platforms/emr-eks-stream" hreflang="en"><link data-rh="true" rel="alternate" href="https://awslabs.github.io/data-on-eks/docs/blueprints/streaming-platforms/emr-eks-stream" hreflang="x-default"><link rel="stylesheet" href="/data-on-eks/assets/css/styles.1b422cd7.css">
<script src="/data-on-eks/assets/js/runtime~main.d052eb71.js" defer="defer"></script>
<script src="/data-on-eks/assets/js/main.2dc5a053.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/data-on-eks/"><div class="navbar__logo"><img src="/data-on-eks/img/header-icon.png" alt="DoEKS Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/data-on-eks/img/header-icon.png" alt="DoEKS Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/data-on-eks/docs/introduction/intro">Introduction</a><a class="navbar__item navbar__link" href="/data-on-eks/docs/gen-ai">Gen AI</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/data-on-eks/docs/blueprints/amazon-emr-on-eks">Blueprints</a><a class="navbar__item navbar__link" href="/data-on-eks/docs/bestpractices/intro">Best Practices</a><a class="navbar__item navbar__link" href="/data-on-eks/docs/benchmarks/emr-on-eks">Benchmarks</a><a class="navbar__item navbar__link" href="/data-on-eks/docs/resources/intro">Resources</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/awslabs/data-on-eks" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/data-on-eks/docs/category/aiml-on-eks">AI/ML on EKS</a><button aria-label="Expand sidebar category &#x27;AI/ML on EKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/data-on-eks/docs/category/data-analytics-on-eks">Data Analytics on EKS</a><button aria-label="Expand sidebar category &#x27;Data Analytics on EKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/data-on-eks/docs/category/amazon-emr-on-eks">Amazon EMR on EKS</a><button aria-label="Expand sidebar category &#x27;Amazon EMR on EKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/data-on-eks/docs/category/streaming-platforms-on-eks">Streaming Platforms on EKS</a><button aria-label="Collapse sidebar category &#x27;Streaming Platforms on EKS&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-on-eks/docs/blueprints/streaming-platforms">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/data-on-eks/docs/blueprints/streaming-platforms/emr-eks-stream">EMR on EKS with Spark Streaming</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-on-eks/docs/blueprints/streaming-platforms/emr-eks-flink">EMR on EKS with Flink Streaming</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-on-eks/docs/blueprints/streaming-platforms/flink">Flink Operator on EKS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-on-eks/docs/blueprints/streaming-platforms/kafka">Kafka on EKS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-on-eks/docs/blueprints/streaming-platforms/nifi">Apache NiFi on EKS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-on-eks/docs/blueprints/streaming-platforms/spark-streaming">Spark Streaming from Kafka in EKS</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/data-on-eks/docs/category/job-schedulers-on-eks">Job Schedulers on EKS</a><button aria-label="Expand sidebar category &#x27;Job Schedulers on EKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/data-on-eks/docs/category/distributed-databases-on-eks">Distributed Databases on EKS</a><button aria-label="Expand sidebar category &#x27;Distributed Databases on EKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/data-on-eks/docs/blueprints/troubleshooting">Troubleshooting</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/data-on-eks/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/data-on-eks/docs/category/streaming-platforms-on-eks"><span itemprop="name">Streaming Platforms on EKS</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">EMR on EKS with Spark Streaming</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p><strong>DEPRECATION NOTICE</strong></p><p>This blueprint will be deprecated and eventually removed from this GitHub repository on <strong>October 27, 2024</strong>. No bugs will be fixed, and no new features will be added. The decision to deprecate is based on the lack of demand and interest in this blueprint, as well as the difficulty in allocating resources to maintain a blueprint that is not actively used by any users or customers.</p><p>If you are using this blueprint in production, please add yourself to the <a href="https://github.com/awslabs/data-on-eks/blob/main/ADOPTERS.md" target="_blank" rel="noopener noreferrer">adopters.md</a> page and raise an issue in the repository. This will help us reconsider and possibly retain and continue to maintain the blueprint. Otherwise, you can make a local copy or use existing tags to access it.</p></div></div>
<header><h1>EMR on EKS with Spark Streaming</h1></header>
<p>This is a project developed in Python <a href="https://docs.aws.amazon.com/cdk/latest/guide/home.html" target="_blank" rel="noopener noreferrer">CDK</a>.
It includes sample data, Kafka producer simulator, and a consumer example that can be run with EMR on EC2 or EMR on EKS. Additionally, we have added few Kinesis examples for difference use cases.</p>
<p>The infrastructure deployment includes the following:</p>
<ul>
<li>A new S3 bucket to store sample data and stream job code</li>
<li>An EKS cluster v1.24 in a new VPC across 2 AZs<!-- -->
<ul>
<li>The Cluster has 2 default managed node groups: the OnDemand nodegroup scales from 1 to 5, SPOT instance nodegroup can scale from 1 to 30.</li>
<li>It also has a Fargate profile labelled with the value <code>serverless</code></li>
</ul>
</li>
<li>An EMR virtual cluster in the same VPC<!-- -->
<ul>
<li>The virtual cluster links to <code>emr</code> namespace</li>
<li>The namespace accommodates two types of Spark jobs, ie. run on managed node group or serverless job on Fargate</li>
<li>All EMR on EKS configuration are done, including fine-grained access controls for pods by the AWS native solution IAM roles for service accounts</li>
</ul>
</li>
<li>A MSK Cluster in the same VPC with 2 brokers in total. Kafka version is 2.8.1<!-- -->
<ul>
<li>A Cloud9 IDE as the command line environment in the demo.</li>
<li>Kafka Client tool will be installed on the Cloud9 IDE</li>
</ul>
</li>
<li>An EMR on EC2 cluster with managed scaling enabled.<!-- -->
<ul>
<li>1 primary and 1 core nodes with r5.xlarge.</li>
<li>configured to run one Spark job at a time.</li>
<li>can scale from 1 to 10 core + task nodes</li>
<li>mounted EFS for checkpointing test/demo (a bootstrap action)</li>
</ul>
</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="spark-examples---read-stream-from-msk">Spark examples - read stream from MSK<a href="#spark-examples---read-stream-from-msk" class="hash-link" aria-label="Direct link to Spark examples - read stream from MSK" title="Direct link to Spark examples - read stream from MSK">​</a></h2>
<p>Spark consumer applications reading from Amazon MSK:</p>
<ul>
<li><a href="#1-submit-a-job-with-emr-on-eks">1. Run a job with EMR on EKS</a></li>
<li><a href="#2-emr-on-eks-with-fargate">2. Same job with Fargate on EMR on EKS</a></li>
<li><a href="#3-optional-submit-step-to-emr-on-ec2">3. Same job with EMR on EC2</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="spark-examples---read-stream-from-kinesis">Spark examples - read stream from Kinesis<a href="#spark-examples---read-stream-from-kinesis" class="hash-link" aria-label="Direct link to Spark examples - read stream from Kinesis" title="Direct link to Spark examples - read stream from Kinesis">​</a></h2>
<ul>
<li><a href="#1-optional-build-custom-docker-image">1. (Optional) Build a custom docker image</a></li>
<li><a href="#2-use-kinesis-sql-connector">2. Run a job with kinesis-sql connector</a></li>
<li><a href="#3-use-sparks-dstream">3. Run a job with Spark&#x27;s DStream</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="deploy-infrastructure">Deploy Infrastructure<a href="#deploy-infrastructure" class="hash-link" aria-label="Direct link to Deploy Infrastructure" title="Direct link to Deploy Infrastructure">​</a></h2>
<p>The provisioning takes about 30 minutes to complete.
Two ways to deploy:</p>
<ol>
<li>AWS CloudFormation template (CFN)</li>
<li><a href="https://docs.aws.amazon.com/cdk/latest/guide/home.html" target="_blank" rel="noopener noreferrer">AWS Cloud Development Kit (AWS CDK)</a>.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cloudformation-deployment">CloudFormation Deployment<a href="#cloudformation-deployment" class="hash-link" aria-label="Direct link to CloudFormation Deployment" title="Direct link to CloudFormation Deployment">​</a></h3>
<table><thead><tr><th>Region</th><th>Launch Template</th></tr></thead><tbody><tr><td>---------------------------</td><td>-----------------------</td></tr><tr><td><strong>US East (N. Virginia)</strong></td><td><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/quickcreate?stackName=emr-stream-demo&amp;templateURL=https://blogpost-sparkoneks-us-east-1.s3.amazonaws.com/emr-stream-demo/v2.0.0/emr-stream-demo.template" target="_blank" rel="noopener noreferrer"><img decoding="async" loading="lazy" alt="Deploy to AWS" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJYAAAAeCAMAAAD5PBdlAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAKhQTFRF+tyz+den98aA/fDf/vXq+dGb++bK9sJ2+MyP9bha++G+/OPD/OvV/OzX/vr198eD9r1o+tqu/vv1/vr19rxm9bhZ+dmt//79//79+dWj+dOe98Fz98F0/vbs+dCX/OXG9bdY//37/OvT++G9++PD+dWi/vz4//38+t63/vPk+MyL++fN//36/vz5++bK///+/vPl/vjv/fHh/e7a+MuK98Z/////9LJM3blaNgAAAnlJREFUeNrMmIly2jAQhiUsjSXXjN0KGALkaK4maeue/Hr/N+uubFM7GMi0DGjHYyQf0jf/HpYQqO3nbB2F/X5yjCMC1OXax2Mz12Dd3/iYbOkC1thHZktHWG4SG5Z/IKzZ9uVrdO3j4uRchLUt1gte2eT0WJfbF9/j8fbdxm6B0emxxkNYHzogo9iwpi/XP6rYsEbPmANXsWFNEwr2+WoLqwpZIAaGkgMTKN3vl1B8Mt4bHsNC24yGq+xbsRahOPgdWMj/DUsqFN4ngp9PmM1mqvSFyvZjXWyqwpyP5yEsml4D2msFp30KRbrKgGWJOTFWoaQJGTzw03MbdZXOiUAQUZLBckPxLen2Y33t1qvxQuzA8hkyTXNlMCkT5tCMlZAUOVJuZuyooFZKvaKR0jhLB4tkUTrDsglk6cHYAqZtbHHT78ISqFiTAnnK0UK/xFKwQpqmIf841TqRpalP9DJJ5UhVGJ34SlhmlxRcSXEIa1MguOn3qBVWRlDMQIokhGVQhSapphu3EVaWb7xkwyvsQVEJLxPT+I6cXx4Di2LLqHqoAbW8hEM6oJZU4YWUuuTBFFXlg2CUm/q/sZpMlMRn2GM0JLH+ja3CW4ekCXHZja0Q3p7SzoDi3Su+WqmCxT+s1gU+9b7U33bULek4A0mtvJ+JdCtvq0XFmeiaTDS1hMKVNuSpCH1e870ltiZ9KnyZ7qvIaStM55JQzh61ygfPre546QDUS4i7/euaASwJaH98rK3m6b+J7hXWvNVmNT8nFvqbscdOTH0/J9bnHd9E/Drb3uOGkzOmvWttT4zllpFRXdW7aheXXg/tfxC4j2cLux4Tzx8BBgBEE3DEesAT9AAAAABJRU5ErkJgggo=" width="150" height="30" class="img_ev3q"></a></td></tr></tbody></table>
<ul>
<li>To launch in a different AWS Region, check out the following customization section, or use the CDK deployment option.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="customization">Customization<a href="#customization" class="hash-link" aria-label="Direct link to Customization" title="Direct link to Customization">​</a></h3>
<p>You can customize the solution, such as set to a different region, then generate the CFN templates in your required region:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export BUCKET_NAME_PREFIX=&lt;my-bucket-name&gt; # bucket where customized code will reside</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export AWS_REGION=&lt;your-region&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export SOLUTION_NAME=emr-stream-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export VERSION=v2.0.0 # version number for the customized code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cd data-on-eks/analytics/cdk/stream-emr-on-eks</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./deployment/build-s3-dist.sh $BUCKET_NAME_PREFIX $SOLUTION_NAME $VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create the bucket where customized code will reside</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws s3 mb s3://$BUCKET_NAME_PREFIX-$AWS_REGION --region $AWS_REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Upload deployment assets to the S3 bucket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws s3 cp ./deployment/global-s3-assets/ s3://$BUCKET_NAME_PREFIX-$AWS_REGION/$SOLUTION_NAME/$VERSION/ --recursive --acl bucket-owner-full-control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws s3 cp ./deployment/regional-s3-assets/ s3://$BUCKET_NAME_PREFIX-$AWS_REGION/$SOLUTION_NAME/$VERSION/ --recursive --acl bucket-owner-full-control</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo -e &quot;\nIn web browser, paste the URL to launch the template: https://console.aws.amazon.com/cloudformation/home?region=$AWS_REGION#/stacks/quickcreate?stackName=emr-stream-demo&amp;templateURL=https://$BUCKET_NAME_PREFIX-$AWS_REGION.s3.amazonaws.com/$SOLUTION_NAME/$VERSION/emr-stream-demo.template\n&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cdk-deployment">CDK Deployment<a href="#cdk-deployment" class="hash-link" aria-label="Direct link to CDK Deployment" title="Direct link to CDK Deployment">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h4>
<p>Install the following tools:</p>
<ol>
<li><a href="https://www.python.org/downloads/" target="_blank" rel="noopener noreferrer">Python 3.6 +</a>.</li>
<li><a href="https://nodejs.org/en/" target="_blank" rel="noopener noreferrer">Node.js 10.3.0 +</a></li>
<li><a href="https://docs.aws.amazon.com/cli/latest/userguide/install-macos.html#install-macosos-bundled" target="_blank" rel="noopener noreferrer">AWS CLI</a>. Configure the CLI by <code>aws configure</code>.</li>
<li><a href="https://cdkworkshop.com/15-prerequisites/500-toolkit.html" target="_blank" rel="noopener noreferrer">CDK toolkit</a></li>
<li><a href="https://cdkworkshop.com/20-typescript/20-create-project/500-deploy.html" target="_blank" rel="noopener noreferrer">One-off CDK bootstrap</a> for the first time deployment.</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="deploy">Deploy<a href="#deploy" class="hash-link" aria-label="Direct link to Deploy" title="Direct link to Deploy">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">python3 -m venv .env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">source .env/bin/activate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pip install -r requirements.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cdk deploy</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="post-deployment">Post-deployment<a href="#post-deployment" class="hash-link" aria-label="Direct link to Post-deployment" title="Direct link to Post-deployment">​</a></h2>
<p>The following <code>post-deployment.sh</code> is executable in Linux, not for Mac OSX. Modify the script if needed.</p>
<ol>
<li>Open the &quot;Kafka Client&quot; IDE in Cloud9 console. Create one if the Cloud9 IDE doesn&#x27;t exist.</li>
</ol>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">VPC prefix: &#x27;emr-stream-demo&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Instance Type: &#x27;t3.small&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>
<p><a href="https://catalog.us-east-1.prod.workshops.aws/workshops/d90c2f2d-a84b-4e80-b4f9-f5cee0614426/en-US/30-emr-serverless/31-set-up-env#setup-cloud9-ide" target="_blank" rel="noopener noreferrer">Attach the IAM role that contains <code>Cloud9Admin</code> to your IDE</a>.</p>
</li>
<li>
<p>Turn off AWS managed temporary credentials in Cloud9:</p>
</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl &quot;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip&quot; -o &quot;awscliv2.zip&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unzip awscliv2.zip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo ./aws/install --update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/usr/local/bin/aws cloud9 update-environment  --environment-id $C9_PID --managed-credentials-action DISABLE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rm -vf ${HOME}/.aws/credentials</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="4">
<li>Run the script to configure the cloud9 IDE environment:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl https://raw.githubusercontent.com/aws-samples/stream-emr-on-eks/main/deployment/app_code/post-deployment.sh | bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="5">
<li>Wait for 5 mins, then check the <a href="https://console.aws.amazon.com/msk/" target="_blank" rel="noopener noreferrer">MSK cluster</a> status. Make sure it is <code>active</code> before sending data to the cluster.</li>
<li>Launching a new terminal window in Cloud9, send the sample data to MSK:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">wget https://github.com/xuite627/workshop_flink1015-1/raw/master/dataset/nycTaxiRides.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zcat nycTaxiRides.gz | split -l 10000 --filter=&quot;kafka_2.12-2.8.1/bin/kafka-console-producer.sh --broker-list ${MSK_SERVER} --topic taxirides ; sleep 0.2&quot;  &gt; /dev/null</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="6">
<li>Launching the 3rd terminal window and monitor the source MSK topic:</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kafka_2.12-2.8.1/bin/kafka-console-consumer.sh \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--bootstrap-server ${MSK_SERVER} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--topic taxirides \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--from-beginning</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="msk-integration">MSK integration<a href="#msk-integration" class="hash-link" aria-label="Direct link to MSK integration" title="Direct link to MSK integration">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-submit-a-job-with-emr-on-eks">1. Submit a job with EMR on EKS<a href="#1-submit-a-job-with-emr-on-eks" class="hash-link" aria-label="Direct link to 1. Submit a job with EMR on EKS" title="Direct link to 1. Submit a job with EMR on EKS">​</a></h3>
<ul>
<li><a href="https://github.com/aws-samples/stream-emr-on-eks/blob/main/deployment/app_code/job/msk_consumer.py" target="_blank" rel="noopener noreferrer">Sample job</a> to consume data stream in MSK</li>
<li>Submit the job:</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws emr-containers start-job-run \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--virtual-cluster-id $VIRTUAL_CLUSTER_ID \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name msk_consumer \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--execution-role-arn $EMR_ROLE_ARN \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--release-label emr-5.33.0-latest \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--job-driver &#x27;{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;sparkSubmitJobDriver&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;entryPoint&quot;: &quot;s3://&#x27;$S3BUCKET&#x27;/app_code/job/msk_consumer.py&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;entryPointArguments&quot;:[&quot;&#x27;$MSK_SERVER&#x27;&quot;,&quot;s3://&#x27;$S3BUCKET&#x27;/stream/checkpoint/emreks&quot;,&quot;emreks_output&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;sparkSubmitParameters&quot;: &quot;--conf spark.jars.packages=org.apache.spark:spark-sql-kafka-0-10_2.11:2.4.7 --conf spark.cleaner.referenceTracking.cleanCheckpoints=true --conf spark.executor.instances=2 --conf spark.executor.memory=2G --conf spark.driver.memory=2G --conf spark.executor.cores=2&quot;}}&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--configuration-overrides &#x27;{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;applicationConfiguration&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;classification&quot;: &quot;spark-defaults&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;properties&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;spark.kubernetes.driver.podTemplateFile&quot;:&quot;s3://&#x27;$S3BUCKET&#x27;/app_code/job/driver_template.yaml&quot;,&quot;spark.kubernetes.executor.podTemplateFile&quot;:&quot;s3://&#x27;$S3BUCKET&#x27;/app_code/job/executor_template.yaml&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;monitoringConfiguration&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;s3MonitoringConfiguration&quot;: {&quot;logUri&quot;: &quot;s3://&#x27;${S3BUCKET}&#x27;/elasticmapreduce/emreks-log/&quot;}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verify-the-job-is-running">Verify the job is running:<a href="#verify-the-job-is-running" class="hash-link" aria-label="Direct link to Verify the job is running:" title="Direct link to Verify the job is running:">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># can see the job pod in EKS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get po -n emr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># verify in EMR console</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># in Cloud9, run the consumer tool to check if any data comeing through in the target Kafka topic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kafka_2.12-2.8.1/bin/kafka-console-consumer.sh --bootstrap-server ${MSK_SERVER} --topic emreks_output --from-beginning</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cancel-the-long-running-job-can-get-job-id-from-the-job-submission-output-or-in-emr-console">Cancel the long-running job (can get job id from the job submission output or in EMR console)<a href="#cancel-the-long-running-job-can-get-job-id-from-the-job-submission-output-or-in-emr-console" class="hash-link" aria-label="Direct link to Cancel the long-running job (can get job id from the job submission output or in EMR console)" title="Direct link to Cancel the long-running job (can get job id from the job submission output or in EMR console)">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws emr-containers cancel-job-run --virtual-cluster-id $VIRTUAL_CLUSTER_ID  --id &lt;YOUR_JOB_ID&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-emr-on-eks-with-fargate">2. EMR on EKS with Fargate<a href="#2-emr-on-eks-with-fargate" class="hash-link" aria-label="Direct link to 2. EMR on EKS with Fargate" title="Direct link to 2. EMR on EKS with Fargate">​</a></h3>
<p>Run the <a href="https://github.com/aws-samples/stream-emr-on-eks/blob/main/deployment/app_code/job/msk_consumer.py" target="_blank" rel="noopener noreferrer">same job</a> on the same EKS cluster, but with the serverless option - Fargate compute choice.</p>
<p>To ensure it is picked up by Fargate not by the managed nodegroup on EC2, we will tag the Spark job by a <code>serverless</code> label, which has setup in a Fargate profile previously:</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">conf spark.kubernetes.driver.label.type=serverless</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">conf spark.kubernetes.executor.label.type=serverless</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Submit the job to Fargate:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws emr-containers start-job-run \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--virtual-cluster-id $VIRTUAL_CLUSTER_ID \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name msk_consumer_fg \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--execution-role-arn $EMR_ROLE_ARN \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--release-label emr-5.33.0-latest \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--job-driver &#x27;{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;sparkSubmitJobDriver&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;entryPoint&quot;: &quot;s3://&#x27;$S3BUCKET&#x27;/app_code/job/msk_consumer.py&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;entryPointArguments&quot;:[&quot;&#x27;$MSK_SERVER&#x27;&quot;,&quot;s3://&#x27;$S3BUCKET&#x27;/stream/checkpoint/emreksfg&quot;,&quot;emreksfg_output&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;sparkSubmitParameters&quot;: &quot;--conf spark.jars.packages=org.apache.spark:spark-sql-kafka-0-10_2.11:2.4.7 --conf spark.cleaner.referenceTracking.cleanCheckpoints=true --conf spark.executor.instances=2 --conf spark.executor.memory=2G --conf spark.driver.memory=2G --conf spark.executor.cores=2 --conf spark.kubernetes.driver.label.type=serverless --conf spark.kubernetes.executor.label.type=serverless&quot;}}&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--configuration-overrides &#x27;{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;monitoringConfiguration&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;s3MonitoringConfiguration&quot;: {&quot;logUri&quot;: &quot;s3://&#x27;${S3BUCKET}&#x27;/elasticmapreduce/emreksfg-log/&quot;}}}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verify-the-job-is-running-on-eks-fargate">Verify the job is running on EKS Fargate<a href="#verify-the-job-is-running-on-eks-fargate" class="hash-link" aria-label="Direct link to Verify the job is running on EKS Fargate" title="Direct link to Verify the job is running on EKS Fargate">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl get po -n emr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># verify in EMR console</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># in Cloud9, run the consumer tool to check if any data comeing through in the target Kafka topic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kafka_2.12-2.8.1/bin/kafka-console-consumer.sh \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--bootstrap-server ${MSK_SERVER} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--topic emreksfg_output \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--from-beginning</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-optional-submit-step-to-emr-on-ec2">3. (Optional) Submit step to EMR on EC2<a href="#3-optional-submit-step-to-emr-on-ec2" class="hash-link" aria-label="Direct link to 3. (Optional) Submit step to EMR on EC2" title="Direct link to 3. (Optional) Submit step to EMR on EC2">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cluster_id=$(aws emr list-clusters --cluster-states WAITING --query &#x27;Clusters[?Name==`emr-stream-demo`].Id&#x27; --output text)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MSK_SERVER=$(echo $MSK_SERVER | cut -d&#x27;,&#x27; -f 2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws emr add-steps \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--cluster-id $cluster_id \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--steps Type=spark,Name=emrec2_stream,Args=[--deploy-mode,cluster,--conf,spark.cleaner.referenceTracking.cleanCheckpoints=true,--conf,spark.executor.instances=2,--conf,spark.executor.memory=2G,--conf,spark.driver.memory=2G,--conf,spark.executor.cores=2,--packages,org.apache.spark:spark-sql-kafka-0-10_2.12:3.0.1,s3://$S3BUCKET/app_code/job/msk_consumer.py,$MSK_SERVER,s3://$S3BUCKET/stream/checkpoint/emrec2,emrec2_output],ActionOnFailure=CONTINUE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verify">Verify<a href="#verify" class="hash-link" aria-label="Direct link to Verify" title="Direct link to Verify">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># verify in EMR console</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># in Cloud9, run the consumer tool to check if any data comeing through in the target Kafka topic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kafka_2.12-2.8.1/bin/kafka-console-consumer.sh \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--bootstrap-server ${MSK_SERVER} \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--topic emrec2_output \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--from-beginning</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="kinesis-integration">Kinesis integration<a href="#kinesis-integration" class="hash-link" aria-label="Direct link to Kinesis integration" title="Direct link to Kinesis integration">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-optional-build-custom-docker-image">1. (Optional) Build custom docker image<a href="#1-optional-build-custom-docker-image" class="hash-link" aria-label="Direct link to 1. (Optional) Build custom docker image" title="Direct link to 1. (Optional) Build custom docker image">​</a></h3>
<p>We will create &amp; delete a kinesis test stream on the fly via boto3, so a custom EMR on EKS docker image to include the Python library is needed. The custom docker image is not compulsory, if you don&#x27;t need the boto3 and kinesis-sql connector.</p>
<p>Build a image based on EMR on EKS 6.5:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export AWS_REGION=$(aws configure list | grep region | awk &#x27;{print $2}&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ACCOUNT_ID=$(aws sts get-caller-identity --output text --query Account)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ECR_URL=$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 895885662937.dkr.ecr.us-west-2.amazonaws.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker build -t emr6.5_custom .</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># create ECR repo in current account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws ecr create-repository --repository-name emr6.5_custom_boto3 --image-scanning-configuration scanOnPush=true --region $AWS_REGION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># push to ECR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker tag emr6.5_custom $ECR_URL/emr6.5_custom_boto3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker push $ECR_URL/emr6.5_custom_boto3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-use-kinesis-sql-connector">2. Use kinesis-sql connector<a href="#2-use-kinesis-sql-connector" class="hash-link" aria-label="Direct link to 2. Use kinesis-sql connector" title="Direct link to 2. Use kinesis-sql connector">​</a></h3>
<p>This demo uses the <code>com.qubole.spark/spark-sql-kinesis_2.12/1.2.0-spark_3.0</code> connector to interact with Kinesis.</p>
<p>To enable the job-level access control, ie. the <a href="https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html" target="_blank" rel="noopener noreferrer">IRSA feature</a>, we have forked the <a href="https://github.com/aws-samples/kinesis-sql" target="_blank" rel="noopener noreferrer">kinesis-sql git repo</a> and recompiled a new jar after upgraded the AWS java SDK. The custom docker build above will pick up the upgraded connector automatically.</p>
<ul>
<li><a href="https://github.com/aws-samples/stream-emr-on-eks/blob/main/deployment/app_code/job/qubole-kinesis.py" target="_blank" rel="noopener noreferrer">Sample job</a> to consume data stream in Kinesis</li>
<li>Submit the job:</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export AWS_REGION=$(aws configure list | grep region | awk &#x27;{print $2}&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ACCOUNT_ID=$(aws sts get-caller-identity --output text --query Account)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ECR_URL=$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws emr-containers start-job-run \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--virtual-cluster-id $VIRTUAL_CLUSTER_ID \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name kinesis-demo \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--execution-role-arn $EMR_ROLE_ARN \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--release-label emr-6.5.0-latest \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--job-driver &#x27;{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;sparkSubmitJobDriver&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;entryPoint&quot;: &quot;s3://&#x27;$S3BUCKET&#x27;/app_code/job/qubole-kinesis.py&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;entryPointArguments&quot;:[&quot;&#x27;${AWS_REGION}&#x27;&quot;,&quot;s3://&#x27;${S3BUCKET}&#x27;/qubolecheckpoint&quot;,&quot;s3://&#x27;${S3BUCKET}&#x27;/qubole-kinesis-output&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;sparkSubmitParameters&quot;: &quot;--conf spark.cleaner.referenceTracking.cleanCheckpoints=true&quot;}}&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--configuration-overrides &#x27;{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;applicationConfiguration&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;classification&quot;: &quot;spark-defaults&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;properties&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;spark.kubernetes.container.image&quot;: &quot;&#x27;${ECR_URL}&#x27;/emr6.5_custom_boto3:latest&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;monitoringConfiguration&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;s3MonitoringConfiguration&quot;: {&quot;logUri&quot;: &quot;s3://&#x27;${S3BUCKET}&#x27;/elasticmapreduce/kinesis-fargate-log/&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-use-sparks-dstream">3. Use Spark&#x27;s DStream<a href="#3-use-sparks-dstream" class="hash-link" aria-label="Direct link to 3. Use Spark&#x27;s DStream" title="Direct link to 3. Use Spark&#x27;s DStream">​</a></h3>
<p>This demo uses the <code>spark-streaming-kinesis-asl_2.12</code> library to read from Kinesis. Check out the <a href="https://spark.apache.org/docs/latest/streaming-kinesis-integration.html" target="_blank" rel="noopener noreferrer">Spark&#x27;s official document</a>. The Spark syntax is slightly different from the spark-sql-kinesis approach. It operates at RDD level.</p>
<ul>
<li><a href="https://github.com/aws-samples/stream-emr-on-eks/blob/main/deployment/app_code/job/pyspark-kinesis.py" target="_blank" rel="noopener noreferrer">Sample job</a> to consume data stream from Kinesis</li>
<li>Submit the job:</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">export AWS_REGION=$(aws configure list | grep region | awk &#x27;{print $2}&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ACCOUNT_ID=$(aws sts get-caller-identity --output text --query Account)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export ECR_URL=$ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws emr-containers start-job-run \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--virtual-cluster-id $VIRTUAL_CLUSTER_ID \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--name kinesis-demo \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--execution-role-arn $EMR_ROLE_ARN \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--release-label emr-6.5.0-latest \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--job-driver &#x27;{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;sparkSubmitJobDriver&quot;:{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;entryPoint&quot;: &quot;s3://&#x27;$S3BUCKET&#x27;/app_code/job/pyspark-kinesis.py&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;entryPointArguments&quot;:[&quot;&#x27;${AWS_REGION}&#x27;&quot;,&quot;s3://&#x27;$S3BUCKET&#x27;/asloutput/&quot;],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;sparkSubmitParameters&quot;: &quot;--jars https://repo1.maven.org/maven2/org/apache/spark/spark-streaming-kinesis-asl_2.12/3.1.2/spark-streaming-kinesis-asl_2.12-3.1.2.jar,https://repo1.maven.org/maven2/com/amazonaws/amazon-kinesis-client/1.12.0/amazon-kinesis-client-1.12.0.jar&quot;}}&#x27; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--configuration-overrides &#x27;{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;applicationConfiguration&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;classification&quot;: &quot;spark-defaults&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;properties&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;spark.kubernetes.container.image&quot;: &quot;&#x27;${ECR_URL}&#x27;/emr6.5_custom_boto3:latest&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;monitoringConfiguration&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;s3MonitoringConfiguration&quot;: {&quot;logUri&quot;: &quot;s3://&#x27;${S3BUCKET}&#x27;/elasticmapreduce/kinesis-fargate-log/&quot;}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}&#x27;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="useful-commands">Useful commands<a href="#useful-commands" class="hash-link" aria-label="Direct link to Useful commands" title="Direct link to Useful commands">​</a></h2>
<ul>
<li><code>kubectl get pod -n emr</code>               list running Spark jobs</li>
<li><code>kubectl delete pod --all -n emr</code>      delete all Spark jobs</li>
<li><code>kubectl logs &lt;pod name&gt; -n emr</code>       check logs against a pod in the emr namespace</li>
<li><code>kubectl get node --label-columns=eks.amazonaws.com/capacityType,topology.kubernetes.io/zone</code> check EKS compute capacity types and AZ distribution.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="clean-up">Clean up<a href="#clean-up" class="hash-link" aria-label="Direct link to Clean up" title="Direct link to Clean up">​</a></h2>
<p>Run the clean-up script with:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl https://raw.githubusercontent.com/aws-samples/stream-emr-on-eks/main/deployment/app_code/delete_all.sh | bash</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Go to the <a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1" target="_blank" rel="noopener noreferrer">CloudFormation console</a>, manually delete the remaining resources if needed.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/awslabs/data-on-eks/blob/main/website/docs/blueprints/streaming-platforms/emr-eks-stream.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/data-on-eks/docs/blueprints/streaming-platforms"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Introduction</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/data-on-eks/docs/blueprints/streaming-platforms/emr-eks-flink"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">EMR on EKS with Flink Streaming</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#spark-examples---read-stream-from-msk" class="table-of-contents__link toc-highlight">Spark examples - read stream from MSK</a></li><li><a href="#spark-examples---read-stream-from-kinesis" class="table-of-contents__link toc-highlight">Spark examples - read stream from Kinesis</a></li><li><a href="#deploy-infrastructure" class="table-of-contents__link toc-highlight">Deploy Infrastructure</a><ul><li><a href="#cloudformation-deployment" class="table-of-contents__link toc-highlight">CloudFormation Deployment</a></li><li><a href="#customization" class="table-of-contents__link toc-highlight">Customization</a></li><li><a href="#cdk-deployment" class="table-of-contents__link toc-highlight">CDK Deployment</a></li></ul></li><li><a href="#post-deployment" class="table-of-contents__link toc-highlight">Post-deployment</a></li><li><a href="#msk-integration" class="table-of-contents__link toc-highlight">MSK integration</a><ul><li><a href="#1-submit-a-job-with-emr-on-eks" class="table-of-contents__link toc-highlight">1. Submit a job with EMR on EKS</a></li><li><a href="#verify-the-job-is-running" class="table-of-contents__link toc-highlight">Verify the job is running:</a></li><li><a href="#cancel-the-long-running-job-can-get-job-id-from-the-job-submission-output-or-in-emr-console" class="table-of-contents__link toc-highlight">Cancel the long-running job (can get job id from the job submission output or in EMR console)</a></li><li><a href="#2-emr-on-eks-with-fargate" class="table-of-contents__link toc-highlight">2. EMR on EKS with Fargate</a></li><li><a href="#verify-the-job-is-running-on-eks-fargate" class="table-of-contents__link toc-highlight">Verify the job is running on EKS Fargate</a></li><li><a href="#3-optional-submit-step-to-emr-on-ec2" class="table-of-contents__link toc-highlight">3. (Optional) Submit step to EMR on EC2</a></li><li><a href="#verify" class="table-of-contents__link toc-highlight">Verify</a></li></ul></li><li><a href="#kinesis-integration" class="table-of-contents__link toc-highlight">Kinesis integration</a><ul><li><a href="#1-optional-build-custom-docker-image" class="table-of-contents__link toc-highlight">1. (Optional) Build custom docker image</a></li><li><a href="#2-use-kinesis-sql-connector" class="table-of-contents__link toc-highlight">2. Use kinesis-sql connector</a></li><li><a href="#3-use-sparks-dstream" class="table-of-contents__link toc-highlight">3. Use Spark&#39;s DStream</a></li></ul></li><li><a href="#useful-commands" class="table-of-contents__link toc-highlight">Useful commands</a></li><li><a href="#clean-up" class="table-of-contents__link toc-highlight">Clean up</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Get Started</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/data-on-eks/docs/introduction/intro">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Get Involved</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/awslabs/data-on-eks" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Built with ❤️ at AWS  <br> © 2024 Amazon.com, Inc. or its affiliates. All Rights Reserved</div></div></div></footer></div>
</body>
</html>