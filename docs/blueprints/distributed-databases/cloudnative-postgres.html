<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-blueprints/distributed-databases/cloudnative-postgres" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.8.1"><title data-rh=true>Deploying PostgreSQL Database on EKS using CloudNativePG Operator | Data on EKS</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://awslabs.github.io/data-on-eks/docs/blueprints/distributed-databases/cloudnative-postgres><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Deploying PostgreSQL Database on EKS using CloudNativePG Operator | Data on EKS"><meta data-rh=true name=description content=Introduction><meta data-rh=true property=og:description content=Introduction><link data-rh=true rel=icon href=/data-on-eks/img/header-icon.png><link data-rh=true rel=canonical href=https://awslabs.github.io/data-on-eks/docs/blueprints/distributed-databases/cloudnative-postgres><link data-rh=true rel=alternate href=https://awslabs.github.io/data-on-eks/docs/blueprints/distributed-databases/cloudnative-postgres hreflang=en><link data-rh=true rel=alternate href=https://awslabs.github.io/data-on-eks/docs/blueprints/distributed-databases/cloudnative-postgres hreflang=x-default><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://awslabs.github.io/data-on-eks/docs/category/distributed-databases-on-eks","name":"Distributed Databases on EKS","position":1},{"@type":"ListItem","item":"https://awslabs.github.io/data-on-eks/docs/blueprints/distributed-databases/cloudnative-postgres","name":"CloudNativePG PostgreSQL","position":2}]}</script><link rel=stylesheet href=/data-on-eks/assets/css/styles.03e7d5c7.css><script src=/data-on-eks/assets/js/runtime~main.34aecab1.js defer></script><script src=/data-on-eks/assets/js/main.231d25c0.js defer></script><body class=navigation-with-keyboard><svg xmlns=http://www.w3.org/2000/svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/data-on-eks/><div class=navbar__logo><img src=/data-on-eks/img/header-icon.png alt="DoEKS Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src=/data-on-eks/img/header-icon.png alt="DoEKS Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/data-on-eks/docs/blueprints/data-analytics>Blueprints</a><a class="navbar__item navbar__link" href=/data-on-eks/docs/bestpractices/intro>Best Practices</a><a class="navbar__item navbar__link" href=/data-on-eks/docs/benchmarks/emr-on-eks>Benchmarks</a><a class="navbar__item navbar__link" href=/data-on-eks/docs/resources/intro>Resources</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href=https://github.com/awslabs/data-on-eks target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill=currentColor d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"/></svg></button></div><div class=navbarSearchContainer_Bca1><div class=navbar__search><span aria-label="expand searchbar" role=button class=search-icon tabindex=0></span><input id=search_input_react type=search placeholder=Loading... aria-label=Search class="navbar__search-input search-bar" disabled></div></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/data-on-eks/docs/category/data-analytics-on-eks>Data Analytics on EKS</a><button aria-label="Expand sidebar category 'Data Analytics on EKS'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/data-on-eks/docs/category/amazon-emr-on-eks>Amazon EMR on EKS</a><button aria-label="Expand sidebar category 'Amazon EMR on EKS'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/data-on-eks/docs/category/streaming-platforms-on-eks>Streaming Platforms on EKS</a><button aria-label="Expand sidebar category 'Streaming Platforms on EKS'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/data-on-eks/docs/category/job-schedulers-on-eks>Job Schedulers on EKS</a><button aria-label="Expand sidebar category 'Job Schedulers on EKS'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/data-on-eks/docs/category/distributed-databases-on-eks>Distributed Databases on EKS</a><button aria-label="Collapse sidebar category 'Distributed Databases on EKS'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/data-on-eks/docs/blueprints/distributed-databases>Introduction</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/data-on-eks/docs/blueprints/distributed-databases/cloudnative-postgres>CloudNativePG PostgreSQL</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/data-on-eks/docs/blueprints/distributed-databases/pinot>Apache Pinot</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/data-on-eks/docs/blueprints/distributed-databases/trino>Trino on EKS</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/data-on-eks/docs/blueprints/distributed-databases/clickhouse>ClickHouse</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/data-on-eks/docs/blueprints/distributed-databases/aerospike>Aerospike</a></ul><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/data-on-eks/docs/blueprints/troubleshooting>Troubleshooting</a></ul></nav><button type=button title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width=20 height=20 aria-hidden=true class=collapseSidebarButtonIcon_kv0_><g fill=#7a7a7a><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"/><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"/></g></svg></button></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/data-on-eks/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class=breadcrumbs__item><a class=breadcrumbs__link href=/data-on-eks/docs/category/distributed-databases-on-eks><span>Distributed Databases on EKS</span></a><li class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link>CloudNativePG PostgreSQL</span></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Deploying PostgreSQL Database on EKS using CloudNativePG Operator</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=introduction>Introduction<a href=#introduction class=hash-link aria-label="Direct link to Introduction" title="Direct link to Introduction">​</a></h2>
<p><strong>CloudNativePG</strong> is an open source
<a href=https://kubernetes.io/docs/concepts/extend-kubernetes/operator/ target=_blank rel="noopener noreferrer">operator</a>
designed to manage <a href=https://www.postgresql.org/ target=_blank rel="noopener noreferrer">PostgreSQL</a> workloads <a href=https://kubernetes.io target=_blank rel="noopener noreferrer">Kubernetes</a>.</p>
<p>It defines a new Kubernetes resource called <code>Cluster</code> representing a PostgreSQL
cluster made up of a single primary and an optional number of replicas that co-exist
in a chosen Kubernetes namespace for High Availability and offloading of
read-only queries.</p>
<p>Applications that reside in the same Kubernetes cluster can access the
PostgreSQL database using a service which is solely managed by the operator,
without having to worry about changes of the primary role following a failover
or a switchover. Applications that reside outside the Kubernetes cluster, need
to configure a Service or Ingress object to expose the Postgres via TCP.
Web applications can take advantage of the native connection pooler based on PgBouncer.</p>
<p>CloudNativePG was originally built by <a href=https://www.enterprisedb.com target=_blank rel="noopener noreferrer">EDB</a>, then
released open source under Apache License 2.0 and submitted for CNCF Sandbox in April 2022.
The <a href=https://github.com/cloudnative-pg/cloudnative-pg target=_blank rel="noopener noreferrer">source code repository is in Github</a>.</p>
<p>More details about the project will be found on this <a href=https://cloudnative-pg.io target=_blank rel="noopener noreferrer">link</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=deploying-the-solution>Deploying the Solution<a href=#deploying-the-solution class=hash-link aria-label="Direct link to Deploying the Solution" title="Direct link to Deploying the Solution">​</a></h2>
<p>Let's go through the deployment steps</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=prerequisites>Prerequisites<a href=#prerequisites class=hash-link aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h3>
<p>Ensure that you have installed the following tools on your machine.</p>
<ol>
<li><a href=https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html target=_blank rel="noopener noreferrer">aws cli</a></li>
<li><a href=https://Kubernetes.io/docs/tasks/tools/ target=_blank rel="noopener noreferrer">kubectl</a></li>
<li><a href=https://learn.hashicorp.com/tutorials/terraform/install-cli target=_blank rel="noopener noreferrer">terraform</a></li>
<li><a href=https://formulae.brew.sh/formula/libpq target=_blank rel="noopener noreferrer">psql</a></li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=deploy-the-eks-cluster-with-cloudnativepg-operator>Deploy the EKS Cluster with CloudNativePG Operator<a href=#deploy-the-eks-cluster-with-cloudnativepg-operator class=hash-link aria-label="Direct link to Deploy the EKS Cluster with CloudNativePG Operator" title="Direct link to Deploy the EKS Cluster with CloudNativePG Operator">​</a></h3>
<p>First, clone the repository</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token function" style=color:#d73a49>git</span><span class="token plain"> clone https://github.com/awslabs/data-on-eks.git</span><br></span></code></pre></div></div>
<p>Navigate into cloudnative-postgres folder and run <code>install.sh</code> script. By default the script deploys EKS cluster to <code>us-west-2</code> region. Update <code>variables.tf</code> to change the region. This is also the time to update any other input variables or make any other changes to the terraform template.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token builtin class-name">cd</span><span class="token plain"> data-on-eks/distributed-databases/cloudnative-postgres</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">./install.sh</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=verify-deployment>Verify Deployment<a href=#verify-deployment class=hash-link aria-label="Direct link to Verify Deployment" title="Direct link to Verify Deployment">​</a></h3>
<p>Verify the Amazon EKS Cluster</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">aws eks describe-cluster </span><span class="token parameter variable" style=color:#36acaa>--name</span><span class="token plain"> cnpg-on-eks</span><br></span></code></pre></div></div>
<p>Update local kubeconfig so we can access kubernetes cluster</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">aws eks update-kubeconfig </span><span class="token parameter variable" style=color:#36acaa>--name</span><span class="token plain"> cnpg-on-eks </span><span class="token parameter variable" style=color:#36acaa>--region</span><span class="token plain"> us-west-2</span><br></span></code></pre></div></div>
<p>First, lets verify that we have worker nodes running in the cluster.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">kubectl get nodes</span><br></span><span class=token-line style=color:#393A34><span class="token plain">NAME                                        STATUS   ROLES    AGE     VERSION</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ip-10-1-10-192.us-west-2.compute.internal   Ready    </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><span class="token plain">   4d17h   v1.25.6-eks-48e63af</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ip-10-1-10-249.us-west-2.compute.internal   Ready    </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><span class="token plain">   4d17h   v1.25.6-eks-48e63af</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ip-10-1-11-38.us-west-2.compute.internal    Ready    </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><span class="token plain">   4d17h   v1.25.6-eks-48e63af</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ip-10-1-12-195.us-west-2.compute.internal   Ready    </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><span class="token plain">   4d17h   v1.25.6-eks-48e63af</span><br></span></code></pre></div></div>
<p>Next, lets verify all the pods are running.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">kubectl get pods </span><span class="token parameter variable" style=color:#36acaa>--namespace</span><span class="token operator" style=color:#393A34>=</span><span class="token plain">monitoring</span><br></span><span class=token-line style=color:#393A34><span class="token plain">NAME                                                        READY   STATUS    RESTARTS        AGE</span><br></span><span class=token-line style=color:#393A34><span class="token plain">alertmanager-kube-prometheus-stack-alertmanager-0           </span><span class="token number" style=color:#36acaa>2</span><span class="token plain">/2     Running   </span><span class="token number" style=color:#36acaa>1</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">4d17h ago</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain">   4d17h</span><br></span><span class=token-line style=color:#393A34><span class="token plain">kube-prometheus-stack-grafana-7f8b9dc64b-sb27n              </span><span class="token number" style=color:#36acaa>3</span><span class="token plain">/3     Running   </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">               4d17h</span><br></span><span class=token-line style=color:#393A34><span class="token plain">kube-prometheus-stack-kube-state-metrics-5979d9d98c-r9fxn   </span><span class="token number" style=color:#36acaa>1</span><span class="token plain">/1     Running   </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">               60m</span><br></span><span class=token-line style=color:#393A34><span class="token plain">kube-prometheus-stack-operator-554b6f9965-zqszr             </span><span class="token number" style=color:#36acaa>1</span><span class="token plain">/1     Running   </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">               60m</span><br></span><span class=token-line style=color:#393A34><span class="token plain">prometheus-kube-prometheus-stack-prometheus-0               </span><span class="token number" style=color:#36acaa>2</span><span class="token plain">/2     Running   </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">               4d17h</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">kubectl get pods </span><span class="token parameter variable" style=color:#36acaa>--namespace</span><span class="token operator" style=color:#393A34>=</span><span class="token plain">cnpg-system</span><br></span><span class=token-line style=color:#393A34><span class="token plain">NAME                                          READY   STATUS    RESTARTS   AGE</span><br></span><span class=token-line style=color:#393A34><span class="token plain">cnpg-on-eks-cloudnative-pg-587d5d8fc5-65z9j   </span><span class="token number" style=color:#36acaa>1</span><span class="token plain">/1     Running   </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">          4d17h</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=deploy-a-postgresql-cluster>Deploy a PostgreSQL cluster<a href=#deploy-a-postgresql-cluster class=hash-link aria-label="Direct link to Deploy a PostgreSQL cluster" title="Direct link to Deploy a PostgreSQL cluster">​</a></h3>
<p>First of all, we need to create a storageclass using the <code>ebs-csi-driver</code>, a demo namespace and kubernetes secrets for login/password for database authentication <code>app-auth</code>. Check examples folder for all kubernetes manifests.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=storage>Storage<a href=#storage class=hash-link aria-label="Direct link to Storage" title="Direct link to Storage">​</a></h4>
<p>For running a highly scalable and durable self-managed PostgreSQL database on Kubernetes with Amazon EKS and EC2, it is recommended to use Amazon Elastic Block Store (EBS) volumes that provide high performance and fault tolerance. The preferred EBS volume types for this use case are:</p>
<p>1.Provisioned IOPS SSD (io2 or io1):</p>
<ul>
<li>Designed for I/O-intensive workloads such as databases.</li>
<li>Offers consistent and low-latency performance.</li>
<li>Allows you to provision a specific number of IOPS (input/output operations per second) according to your requirements.</li>
<li>Provides up to 64,000 IOPS per volume and 1,000 MB/s throughput, making it suitable for demanding database workloads.</li>
</ul>
<p>2.General Purpose SSD (gp3 or gp2):</p>
<ul>
<li>Suitable for most workloads and offers a balance between performance and cost.</li>
<li>Provides a baseline performance of 3,000 IOPS and 125 MB/s throughput per volume, which can be increased if needed (up to 16,000 IOPS and 1,000 MB/s for gp3).</li>
<li>Recommended for less I/O-intensive database workloads or when cost is a primary concern.</li>
</ul>
<p>You can find both storageclass template in <code>examples</code> folder.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">kubectl create </span><span class="token parameter variable" style=color:#36acaa>-f</span><span class="token plain"> examples/storageclass.yaml</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">kubectl create </span><span class="token parameter variable" style=color:#36acaa>-f</span><span class="token plain"> examples/auth-prod.yaml</span><br></span></code></pre></div></div>
<p>As with any other deployment in Kubernetes, to deploy a PostgreSQL cluster you need to apply a configuration file that defines your desired <code>Cluster</code>. CloudNativePG operator offers two type of Bootstrapping a new database:</p>
<ol>
<li>Bootstrap an empty cluster</li>
<li>Bootstrap From another cluster.</li>
</ol>
<p>In this first example, we are going to create a new empty database cluster using <code>initdb</code>flags. We are going to use the template below by modifying the IAM role for IRSA configuration <em>1</em> and S3 bucket for backup restore process and WAL archiving <em>2</em>. The Terraform could already created this use <code>terraform output</code> to extract these parameters:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token builtin class-name">cd</span><span class="token plain"> data-on-eks/distributed-databases/cloudnative-postgres</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">terraform output</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">barman_backup_irsa </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"arn:aws:iam::&lt;your_account_id>:role/cnpg-on-eks-prod-irsa"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">barman_s3_bucket </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"XXXX-cnpg-barman-bucket"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">configure_kubectl </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"aws eks --region us-west-2 update-kubeconfig --name cnpg-on-eks"</span><br></span></code></pre></div></div>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token punctuation" style=color:#393A34>---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>apiVersion</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> postgresql.cnpg.io/v1</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>kind</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> Cluster</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>metadata</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>name</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> prod</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>namespace</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> demo</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>spec</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>description</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"Cluster Demo for DoEKS"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic># Choose your PostGres Database Version</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>imageName</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> ghcr.io/cloudnative</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">pg/postgresql</span><span class="token punctuation" style=color:#393A34>:</span><span class="token number" style=color:#36acaa>15.2</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic># Number of Replicas</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>instances</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>3</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>startDelay</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>300</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>stopDelay</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>300</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>replicationSlots</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>highAvailability</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token key atrule" style=color:#00a4db>enabled</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#36acaa>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>updateInterval</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>300</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>primaryUpdateStrategy</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> unsupervised</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>serviceAccountTemplate</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic># For backup and restore, we use IRSA for barman tool.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic># You will find this IAM role on terraform outputs.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>metadata</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token key atrule" style=color:#00a4db>annotations</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token key atrule" style=color:#00a4db>eks.amazonaws.com/role-arn</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> arn</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain">aws</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain">iam</span><span class="token punctuation" style=color:#393A34>:</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain">&lt;&lt;account_id</span><span class="token punctuation" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>></span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain">role/cnpg</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">on</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">eks</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">prod</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">irsa </span><span class="token comment" style=color:#999988;font-style:italic>#1</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>postgresql</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>parameters</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token key atrule" style=color:#00a4db>shared_buffers</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> 256MB</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token key atrule" style=color:#00a4db>pg_stat_statements.max</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'10000'</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token key atrule" style=color:#00a4db>pg_stat_statements.track</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> all</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token key atrule" style=color:#00a4db>auto_explain.log_min_duration</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'10s'</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>pg_hba</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token comment" style=color:#999988;font-style:italic># - hostssl app all all cert</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> host app app all password</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>logLevel</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> debug</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>storage</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>storageClass</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> ebs</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">sc</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>size</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> 1Gi</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>walStorage</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>storageClass</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> ebs</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">sc</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>size</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> 1Gi</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>monitoring</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>enablePodMonitor</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#36acaa>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>bootstrap</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>initdb</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic># Deploying a new cluster</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token key atrule" style=color:#00a4db>database</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> WorldDB</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token key atrule" style=color:#00a4db>owner</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> app</span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token key atrule" style=color:#00a4db>secret</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token key atrule" style=color:#00a4db>name</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> app</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">auth</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>backup</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>barmanObjectStore</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic># For backup, we S3 bucket to store data.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic># On this Blueprint, we create an S3 check the terraform output for it.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token key atrule" style=color:#00a4db>destinationPath</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> s3</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain">//&lt;your</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">s3</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">barman</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">bucket</span><span class="token punctuation" style=color:#393A34>></span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic>#2</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token key atrule" style=color:#00a4db>s3Credentials</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token key atrule" style=color:#00a4db>inheritFromIAMRole</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#36acaa>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token key atrule" style=color:#00a4db>wal</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token key atrule" style=color:#00a4db>compression</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> gzip</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token key atrule" style=color:#00a4db>maxParallel</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>8</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>retentionPolicy</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"30d"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>resources</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token comment" style=color:#999988;font-style:italic># m5large: m5xlarge 2vCPU, 8GI RAM</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>requests</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token key atrule" style=color:#00a4db>memory</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"512Mi"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token key atrule" style=color:#00a4db>cpu</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>limits</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token key atrule" style=color:#00a4db>memory</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"1Gi"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token key atrule" style=color:#00a4db>cpu</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>affinity</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>enablePodAntiAffinity</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#36acaa>true</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>topologyKey</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> failure</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">domain.beta.kubernetes.io/zone</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>nodeMaintenanceWindow</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>inProgress</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#36acaa>false</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>reusePVC</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token boolean important" style=color:#36acaa>false</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span></code></pre></div></div>
<p>Once updated, you can apply your template.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">kubectl create </span><span class="token parameter variable" style=color:#36acaa>-f</span><span class="token plain"> examples/prod-cluster.yaml</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span></code></pre></div></div>
<p>Verify that CloudNatvicePG operator has created three pods: one primary and two standby.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">kubectl get pods,svc </span><span class="token parameter variable" style=color:#36acaa>-n</span><span class="token plain"> demo</span><br></span><span class=token-line style=color:#393A34><span class="token plain">NAME         READY   STATUS    RESTARTS   AGE</span><br></span><span class=token-line style=color:#393A34><span class="token plain">pod/prod-1   </span><span class="token number" style=color:#36acaa>1</span><span class="token plain">/1     Running   </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">          4m36s</span><br></span><span class=token-line style=color:#393A34><span class="token plain">pod/prod-2   </span><span class="token number" style=color:#36acaa>1</span><span class="token plain">/1     Running   </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">          3m45s</span><br></span><span class=token-line style=color:#393A34><span class="token plain">pod/prod-3   </span><span class="token number" style=color:#36acaa>1</span><span class="token plain">/1     Running   </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">          3m9s</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">NAME               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">S</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain">    AGE</span><br></span><span class=token-line style=color:#393A34><span class="token plain">service/prod-any   ClusterIP   </span><span class="token number" style=color:#36acaa>172.20</span><span class="token plain">.230.153   </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><span class="token plain">        </span><span class="token number" style=color:#36acaa>5432</span><span class="token plain">/TCP   4m54s</span><br></span><span class=token-line style=color:#393A34><span class="token plain">service/prod-r     ClusterIP   </span><span class="token number" style=color:#36acaa>172.20</span><span class="token plain">.33.61     </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><span class="token plain">        </span><span class="token number" style=color:#36acaa>5432</span><span class="token plain">/TCP   4m54s</span><br></span><span class=token-line style=color:#393A34><span class="token plain">service/prod-ro    ClusterIP   </span><span class="token number" style=color:#36acaa>172.20</span><span class="token plain">.96.16     </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><span class="token plain">        </span><span class="token number" style=color:#36acaa>5432</span><span class="token plain">/TCP   4m53s</span><br></span><span class=token-line style=color:#393A34><span class="token plain">service/prod-rw    ClusterIP   </span><span class="token number" style=color:#36acaa>172.20</span><span class="token plain">.236.1     </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">none</span><span class="token operator" style=color:#393A34>></span><span class="token plain">        </span><span class="token number" style=color:#36acaa>5432</span><span class="token plain">/TCP   4m53s</span><br></span></code></pre></div></div>
<p>The operator created also three services:</p>
<ol>
<li><code>-rw</code>: points only to the primary instances of cluster database</li>
<li><code>-ro</code>points only to hot standby replicas for read-only-workloads</li>
<li><code>-r</code>points to any of the instances for read-only workloads</li>
</ol>
<p>Note that <code>-any</code> points on all the instances.</p>
<p>Another way to check Cluster status is by using <a href=https://cloudnative-pg.io/documentation/1.19/cnpg-plugin/#cloudnativepg-plugin target=_blank rel="noopener noreferrer">cloudnative-pg kubectl plugin</a> offered by the CloudNativePG community,</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">kubectl cnpg status prod</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">Cluster Summary</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Name:               prod</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Namespace:          demo</span><br></span><span class=token-line style=color:#393A34><span class="token plain">System ID:          </span><span class="token number" style=color:#36acaa>7214866198623563798</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">PostgreSQL Image:   ghcr.io/cloudnative-pg/postgresql:15.2</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Primary instance:   prod-1</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Status:             Cluster </span><span class="token keyword" style=color:#00009f>in</span><span class="token plain"> healthy state</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Instances:          </span><span class="token number" style=color:#36acaa>3</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">Ready instances:    </span><span class="token number" style=color:#36acaa>3</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">Current Write LSN:  </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">/6000000 </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">Timeline: </span><span class="token number" style=color:#36acaa>1</span><span class="token plain"> - WAL File: 000000010000000000000005</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">Certificates Status</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Certificate Name  Expiration Date                Days Left Until Expiration</span><br></span><span class=token-line style=color:#393A34><span class="token plain">----------------  ---------------                --------------------------</span><br></span><span class=token-line style=color:#393A34><span class="token plain">prod-ca           </span><span class="token number" style=color:#36acaa>2023</span><span class="token plain">-06-24 </span><span class="token number" style=color:#36acaa>14</span><span class="token plain">:40:27 +0000 UTC  </span><span class="token number" style=color:#36acaa>89.96</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">prod-replication  </span><span class="token number" style=color:#36acaa>2023</span><span class="token plain">-06-24 </span><span class="token number" style=color:#36acaa>14</span><span class="token plain">:40:27 +0000 UTC  </span><span class="token number" style=color:#36acaa>89.96</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">prod-server       </span><span class="token number" style=color:#36acaa>2023</span><span class="token plain">-06-24 </span><span class="token number" style=color:#36acaa>14</span><span class="token plain">:40:27 +0000 UTC  </span><span class="token number" style=color:#36acaa>89.96</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">Continuous Backup status</span><br></span><span class=token-line style=color:#393A34><span class="token plain">First Point of Recoverability:  Not Available</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Working WAL archiving:          OK</span><br></span><span class=token-line style=color:#393A34><span class="token plain">WALs waiting to be archived:    </span><span class="token number" style=color:#36acaa>0</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">Last Archived WAL:              000000010000000000000005   @   </span><span class="token number" style=color:#36acaa>2023</span><span class="token plain">-03-26T14:52:09.24307Z</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Last Failed WAL:                -</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">Streaming Replication status</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Replication Slots Enabled</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Name    Sent LSN   Write LSN  Flush LSN  Replay LSN  Write Lag  Flush Lag  Replay Lag  State      Sync State  Sync Priority  Replication Slot</span><br></span><span class=token-line style=color:#393A34><span class="token plain">----    --------   ---------  ---------  ----------  ---------  ---------  ----------  -----      ----------  -------------  ----------------</span><br></span><span class=token-line style=color:#393A34><span class="token plain">prod-2  </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">/6000000  </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">/6000000  </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">/6000000  </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">/6000000   00:00:00   00:00:00   00:00:00    streaming  async       </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">              active</span><br></span><span class=token-line style=color:#393A34><span class="token plain">prod-3  </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">/6000000  </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">/6000000  </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">/6000000  </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">/6000000   00:00:00   00:00:00   00:00:00    streaming  async       </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">              active</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">Unmanaged Replication Slot Status</span><br></span><span class=token-line style=color:#393A34><span class="token plain">No unmanaged replication slots found</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">Instances status</span><br></span><span class=token-line style=color:#393A34><span class="token plain">Name    Database Size  Current LSN  Replication role  Status  QoS         Manager Version  Node</span><br></span><span class=token-line style=color:#393A34><span class="token plain">----    -------------  -----------  ----------------  ------  ---         ---------------  ----</span><br></span><span class=token-line style=color:#393A34><span class="token plain">prod-1  </span><span class="token number" style=color:#36acaa>29</span><span class="token plain"> MB          </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">/6000000    Primary           OK      BestEffort  </span><span class="token number" style=color:#36acaa>1.19</span><span class="token plain">.0           ip-10-1-10-192.us-west-2.compute.internal</span><br></span><span class=token-line style=color:#393A34><span class="token plain">prod-2  </span><span class="token number" style=color:#36acaa>29</span><span class="token plain"> MB          </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">/6000000    Standby </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">async</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain">   OK      BestEffort  </span><span class="token number" style=color:#36acaa>1.19</span><span class="token plain">.0           ip-10-1-12-195.us-west-2.compute.internal</span><br></span><span class=token-line style=color:#393A34><span class="token plain">prod-3  </span><span class="token number" style=color:#36acaa>29</span><span class="token plain"> MB          </span><span class="token number" style=color:#36acaa>0</span><span class="token plain">/6000000    Standby </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">async</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain">   OK      BestEffort  </span><span class="token number" style=color:#36acaa>1.19</span><span class="token plain">.0           ip-10-1-11-38.us-west-2.compute.internal</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=monitoring>Monitoring<a href=#monitoring class=hash-link aria-label="Direct link to Monitoring" title="Direct link to Monitoring">​</a></h3>
<p>In this example, we deployed a Prometheus and Grafana addons to monitor all database clusters created by CloudNativePG. Let's check Grafana dashboard.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">kubectl </span><span class="token parameter variable" style=color:#36acaa>-n</span><span class="token plain"> monitoring port-forward svc/kube-prometheus-stack-grafana </span><span class="token number" style=color:#36acaa>8080</span><span class="token plain">:80</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span></code></pre></div></div>
<p><img decoding=async loading=lazy alt="CloudNativePG Grafana Dashboard" src=/data-on-eks/assets/images/cnpg_garfana_dashboard-3e1324abcad72e5b4b056a6b3042ccb1.png width=3554 height=1666 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=import-database-sample>Import database sample<a href=#import-database-sample class=hash-link aria-label="Direct link to Import database sample" title="Direct link to Import database sample">​</a></h3>
<p>You can expose your database outside the cluster using ingress-controller or kubernetes service type <code>LoadBalancer</code>. However, for internal usage inside your EKS cluster, you can use kubernetes service <code>prod-rw</code> and <code>prod-ro</code>.
In this section, we are going to expose read-write service <code>-rw</code>using <code>kubectl port-forward</code>.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">kubectl port-forward svc/prod-rw </span><span class="token number" style=color:#36acaa>5432</span><span class="token plain">:5432 </span><span class="token parameter variable" style=color:#36acaa>-n</span><span class="token plain"> demo</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span></code></pre></div></div>
<p>Now, we use <code>psql</code> cli to import <code>world.sql</code> into our database instance WorldDB using credentials from <code>app-auth</code> secrets.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">psql </span><span class="token parameter variable" style=color:#36acaa>-h</span><span class="token plain"> localhost </span><span class="token parameter variable" style=color:#36acaa>--port</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>5432</span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>-U</span><span class="token plain"> app </span><span class="token parameter variable" style=color:#36acaa>-d</span><span class="token plain"> WorldDB </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain"> world.sql</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># Quick check on db tables.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">psql </span><span class="token parameter variable" style=color:#36acaa>-h</span><span class="token plain"> localhost </span><span class="token parameter variable" style=color:#36acaa>--port</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>5432</span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>-U</span><span class="token plain"> app </span><span class="token parameter variable" style=color:#36acaa>-d</span><span class="token plain"> WorldDB </span><span class="token parameter variable" style=color:#36acaa>-c</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'\dt'</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">Password </span><span class="token keyword" style=color:#00009f>for</span><span class="token plain"> user app:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            List of relations</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> Schema </span><span class="token operator" style=color:#393A34>|</span><span class="token plain">      Name       </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> Type  </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> Owner</span><br></span><span class=token-line style=color:#393A34><span class="token plain">--------+-----------------+-------+-------</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> public </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> city            </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> table </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> app</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> public </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> country         </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> table </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> app</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> public </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> countrylanguage </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> table </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> app</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>3</span><span class="token plain"> rows</span><span class="token punctuation" style=color:#393A34>)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=create-backup-to-s3>Create Backup to S3<a href=#create-backup-to-s3 class=hash-link aria-label="Direct link to Create Backup to S3" title="Direct link to Create Backup to S3">​</a></h3>
<p>Now that we had a running database with data, CloudNativePG operator offers backup-restore feature using <a href=https://pgbarman.org/ target=_blank rel="noopener noreferrer">barman</a> tool. CloudNativePG allows database admin to create on-demand database or Scheduled backups and for more details on <a href=https://cloudnative-pg.io/documentation/1.19/backup_recovery/ target=_blank rel="noopener noreferrer">documentations</a>.</p>
<p>In this example, we will create a Backup object to start a backup process immediately.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token key atrule" style=color:#00a4db>apiVersion</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> postgresql.cnpg.io/v1</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>kind</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> Backup</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>metadata</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>name</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> ondemand</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>spec</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>cluster</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>name</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> prod</span><br></span></code></pre></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain"> kubectl create </span><span class="token parameter variable" style=color:#36acaa>-f</span><span class="token plain"> examples/backup-od.yaml</span><br></span></code></pre></div></div>
<p>It will take couple minutes to run, then, check the backup process</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">kubectl describe backup ondemand</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">Events:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Type    Reason     Age   From                   Message</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  ----    ------     ----  ----                   -------</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Normal  Starting   60s   cloudnative-pg-backup  Starting backup </span><span class="token keyword" style=color:#00009f>for</span><span class="token plain"> cluster prod</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Normal  Starting   60s   instance-manager       Backup started</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Normal  Completed  56s   instance-manager       Backup completed</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=restore>Restore<a href=#restore class=hash-link aria-label="Direct link to Restore" title="Direct link to Restore">​</a></h3>
<p>For restore, we use bootstrap a new cluster using backup file on S3. The backup tool <em>barman</em> manages restore process, but, it doesn't support backup and restore for kubernetes secrets. This must be managed separately, like using csi-secrets-driver with AWS SecretsManager.</p>
<p>First let's delete prod database.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">kubectl delete cluster prod </span><span class="token parameter variable" style=color:#36acaa>-n</span><span class="token plain"> demo</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span></code></pre></div></div>
<p>Then, update your template <code>examples/cluster-restore.yaml</code> with your S3 bucket and IAM role. Note that on restore template, CloudNativePG use <code>externalClusters</code> to point on the database.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">  kubectl create </span><span class="token parameter variable" style=color:#36acaa>-f</span><span class="token plain"> examples/cluster-restore.yaml</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Type    Reason                       Age    From            Message</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  ----    ------                       ----   ----            -------</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Normal  CreatingPodDisruptionBudget  7m12s  cloudnative-pg  Creating PodDisruptionBudget prod-primary</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Normal  CreatingPodDisruptionBudget  7m12s  cloudnative-pg  Creating PodDisruptionBudget prod</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Normal  CreatingServiceAccount       7m12s  cloudnative-pg  Creating ServiceAccount</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Normal  CreatingRole                 7m12s  cloudnative-pg  Creating Cluster Role</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Normal  CreatingInstance             7m12s  cloudnative-pg  Primary instance </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">from backup</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Normal  CreatingInstance             6m33s  cloudnative-pg  Creating instance prod-2</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  Normal  CreatingInstance             5m51s  cloudnative-pg  Creating instance prod-3</span><br></span></code></pre></div></div>
<p>When creating a new cluster, the operator will create a ServiceAccount with IRSA configuration as described on Cluster resources. Make sure the trust policy points the right ServiceAccount.</p>
<p>Let's check if the data were covered as expected.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">psql </span><span class="token parameter variable" style=color:#36acaa>-h</span><span class="token plain"> localhost </span><span class="token parameter variable" style=color:#36acaa>--port</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>5432</span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>-U</span><span class="token plain"> app </span><span class="token parameter variable" style=color:#36acaa>-d</span><span class="token plain"> WorldDB </span><span class="token parameter variable" style=color:#36acaa>-c</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'\dt'</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">Password </span><span class="token keyword" style=color:#00009f>for</span><span class="token plain"> user app:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            List of relations</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> Schema </span><span class="token operator" style=color:#393A34>|</span><span class="token plain">      Name       </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> Type  </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> Owner</span><br></span><span class=token-line style=color:#393A34><span class="token plain">--------+-----------------+-------+-------</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> public </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> city            </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> table </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> app</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> public </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> country         </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> table </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> app</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> public </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> countrylanguage </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> table </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> app</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>3</span><span class="token plain"> rows</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">psql </span><span class="token parameter variable" style=color:#36acaa>-h</span><span class="token plain"> localhost </span><span class="token parameter variable" style=color:#36acaa>--port</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>5432</span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>-U</span><span class="token plain"> app </span><span class="token parameter variable" style=color:#36acaa>-d</span><span class="token plain"> WorldDB </span><span class="token parameter variable" style=color:#36acaa>-c</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'SELECT CURRENT_TIME;'</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=conclusion>Conclusion<a href=#conclusion class=hash-link aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>CloudNativePG operator provides Level 5 from <a href=https://operatorframework.io/operator-capabilities/ target=_blank rel="noopener noreferrer">Operator Capability Levels</a>. In this example, we share a blueprint that deploy the operator as an addon along with its monitoring stack (Prometheus and grafana). Among many features, we highlighted couple of examples on creating cluster, importing data and restoring database in case of disaster (or cluster deletion). More features are available on this <a href=https://cloudnative-pg.io/documentation/1.19/ target=_blank rel="noopener noreferrer">documentation</a></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/awslabs/data-on-eks/blob/main/website/docs/blueprints/distributed-databases/cloudnative-postgres.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/data-on-eks/docs/blueprints/distributed-databases><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Introduction</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/data-on-eks/docs/blueprints/distributed-databases/pinot><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Apache Pinot</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#introduction class="table-of-contents__link toc-highlight">Introduction</a><li><a href=#deploying-the-solution class="table-of-contents__link toc-highlight">Deploying the Solution</a><ul><li><a href=#prerequisites class="table-of-contents__link toc-highlight">Prerequisites</a><li><a href=#deploy-the-eks-cluster-with-cloudnativepg-operator class="table-of-contents__link toc-highlight">Deploy the EKS Cluster with CloudNativePG Operator</a><li><a href=#verify-deployment class="table-of-contents__link toc-highlight">Verify Deployment</a><li><a href=#deploy-a-postgresql-cluster class="table-of-contents__link toc-highlight">Deploy a PostgreSQL cluster</a><li><a href=#monitoring class="table-of-contents__link toc-highlight">Monitoring</a><li><a href=#import-database-sample class="table-of-contents__link toc-highlight">Import database sample</a><li><a href=#create-backup-to-s3 class="table-of-contents__link toc-highlight">Create Backup to S3</a><li><a href=#restore class="table-of-contents__link toc-highlight">Restore</a></ul><li><a href=#conclusion class="table-of-contents__link toc-highlight">Conclusion</a></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Get Started</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/data-on-eks/docs/introduction/intro>Docs</a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Get Involved</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://github.com/awslabs/data-on-eks target=_blank rel="noopener noreferrer" class=footer__link-item>Github<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Built with ❤️ at AWS  <br> © 2025 Amazon.com, Inc. or its affiliates. All Rights Reserved</div></div></div></footer><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "7fbc7ab02fae4767b1af2588eba0cdf2"}'></script></div>