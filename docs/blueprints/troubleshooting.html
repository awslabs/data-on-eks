<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-blueprints/troubleshooting/troubleshooting" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.8.1"><title data-rh=true>Troubleshooting | Data on EKS</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://awslabs.github.io/data-on-eks/docs/blueprints/troubleshooting><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Troubleshooting | Data on EKS"><meta data-rh=true name=description content="You will find troubleshooting info for Data on Amazon EKS(DoEKS) installation issues"><meta data-rh=true property=og:description content="You will find troubleshooting info for Data on Amazon EKS(DoEKS) installation issues"><link data-rh=true rel=icon href=/data-on-eks/img/header-icon.png><link data-rh=true rel=canonical href=https://awslabs.github.io/data-on-eks/docs/blueprints/troubleshooting><link data-rh=true rel=alternate href=https://awslabs.github.io/data-on-eks/docs/blueprints/troubleshooting hreflang=en><link data-rh=true rel=alternate href=https://awslabs.github.io/data-on-eks/docs/blueprints/troubleshooting hreflang=x-default><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://awslabs.github.io/data-on-eks/docs/blueprints/troubleshooting/","name":"Troubleshooting","position":1}]}</script><link rel=stylesheet href=/data-on-eks/assets/css/styles.03e7d5c7.css><script src=/data-on-eks/assets/js/runtime~main.68b68ee4.js defer></script><script src=/data-on-eks/assets/js/main.08422b12.js defer></script><body class=navigation-with-keyboard><svg xmlns=http://www.w3.org/2000/svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/data-on-eks/><div class=navbar__logo><img src=/data-on-eks/img/header-icon.png alt="DoEKS Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src=/data-on-eks/img/header-icon.png alt="DoEKS Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/data-on-eks/docs/blueprints/data-analytics>Blueprints</a><a class="navbar__item navbar__link" href=/data-on-eks/docs/bestpractices/intro>Best Practices</a><a class="navbar__item navbar__link" href=/data-on-eks/docs/benchmarks/emr-on-eks>Benchmarks</a><a class="navbar__item navbar__link" href=/data-on-eks/docs/resources/intro>Resources</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href=https://github.com/awslabs/data-on-eks target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill=currentColor d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"/></svg></button></div><div class=navbarSearchContainer_Bca1><div class=navbar__search><span aria-label="expand searchbar" role=button class=search-icon tabindex=0></span><input id=search_input_react type=search placeholder=Loading... aria-label=Search class="navbar__search-input search-bar" disabled></div></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/data-on-eks/docs/category/data-analytics-on-eks>Data Analytics on EKS</a><button aria-label="Expand sidebar category 'Data Analytics on EKS'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/data-on-eks/docs/category/amazon-emr-on-eks>Amazon EMR on EKS</a><button aria-label="Expand sidebar category 'Amazon EMR on EKS'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/data-on-eks/docs/category/streaming-platforms-on-eks>Streaming Platforms on EKS</a><button aria-label="Expand sidebar category 'Streaming Platforms on EKS'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/data-on-eks/docs/category/job-schedulers-on-eks>Job Schedulers on EKS</a><button aria-label="Expand sidebar category 'Job Schedulers on EKS'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/data-on-eks/docs/category/distributed-databases-on-eks>Distributed Databases on EKS</a><button aria-label="Expand sidebar category 'Distributed Databases on EKS'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current=page href=/data-on-eks/docs/blueprints/troubleshooting>Troubleshooting</a></ul></nav><button type=button title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width=20 height=20 aria-hidden=true class=collapseSidebarButtonIcon_kv0_><g fill=#7a7a7a><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"/><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"/></g></svg></button></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/data-on-eks/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link>Troubleshooting</span></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Troubleshooting</h1></header>
<p>You will find troubleshooting info for Data on Amazon EKS(DoEKS) installation issues</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=error-local-exec-provisioner-error>Error: local-exec provisioner error<a href=#error-local-exec-provisioner-error class=hash-link aria-label="Direct link to Error: local-exec provisioner error" title="Direct link to Error: local-exec provisioner error">​</a></h2>
<p>If you encounter the following error during the execution of the local-exec provisioner:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">Error: local-exec provisioner error </span><span class="token punctuation" style=color:#393A34>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">with module.eks-blueprints.module.emr_on_eks</span><span class="token punctuation" style=color:#393A34>[</span><span class="token string" style=color:#e3116c>"data_team_b"</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain">.null_resource.update_trust_policy,</span><span class="token punctuation" style=color:#393A34>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"> on .terraform/modules/eks-blueprints/modules/emr-on-eks/main.tf line </span><span class="token number" style=color:#36acaa>105</span><span class="token plain">, </span><span class="token keyword" style=color:#00009f>in</span><span class="token plain"> resource </span><span class="token string" style=color:#e3116c>"null_resource"</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"> </span><span class="token string" style=color:#e3116c>"update_trust_policy"</span><span class="token plain">:│ </span><span class="token number" style=color:#36acaa>105</span><span class="token plain">: provisioner </span><span class="token string" style=color:#e3116c>"local-exec"</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain">│ │ Error running </span><span class="token builtin class-name">command</span><span class="token plain"> 'set -e│ │ aws emr-containers update-role-trust-policy </span><span class="token punctuation" style=color:#393A34>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"> │ --cluster-name emr-on-eks </span><span class="token punctuation" style=color:#393A34>\</span><span class="token plain">│ </span><span class="token parameter variable" style=color:#36acaa>--namespace</span><span class="token plain"> emr-data-team-b </span><span class="token punctuation" style=color:#393A34>\</span><span class="token plain">│ --role-name emr-on-eks-emr-eks-data-team-b</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=issue-description>Issue Description:<a href=#issue-description class=hash-link aria-label="Direct link to Issue Description:" title="Direct link to Issue Description:">​</a></h3>
<p>The error message indicates that the emr-containers command is not present in the AWS CLI version being used. This issue has been addressed and fixed in AWS CLI version 2.0.54.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=solution>Solution<a href=#solution class=hash-link aria-label="Direct link to Solution" title="Direct link to Solution">​</a></h3>
<p>To resolve the issue, update your AWS CLI version to 2.0.54 or a later version by executing the following command:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">pip </span><span class="token function" style=color:#d73a49>install</span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>--upgrade</span><span class="token plain"> awscliv2</span><br></span></code></pre></div></div>
<p>By updating the AWS CLI version, you will ensure that the necessary emr-containers command is available and can be executed successfully during the provisioning process.</p>
<p>If you continue to experience any issues or require further assistance, please consult the <a href=https://github.com/aws/aws-cli/issues/6162 target=_blank rel="noopener noreferrer">AWS CLI GitHub issue</a> for more details or contact our support team for additional guidance.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=timeouts-during-terraform-destroy>Timeouts during Terraform Destroy<a href=#timeouts-during-terraform-destroy class=hash-link aria-label="Direct link to Timeouts during Terraform Destroy" title="Direct link to Timeouts during Terraform Destroy">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=issue-description-1>Issue Description:<a href=#issue-description-1 class=hash-link aria-label="Direct link to Issue Description:" title="Direct link to Issue Description:">​</a></h3>
<p>Customers may experience timeouts during the deletion of their environments, specifically when VPCs are being deleted. This is a known issue related to the vpc-cni component.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=symptoms>Symptoms:<a href=#symptoms class=hash-link aria-label="Direct link to Symptoms:" title="Direct link to Symptoms:">​</a></h3>
<p>ENIs (Elastic Network Interfaces) remain attached to subnets even after the environment is destroyed.
The EKS managed security group associated with the ENI cannot be deleted by EKS.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=solution-1>Solution:<a href=#solution-1 class=hash-link aria-label="Direct link to Solution:" title="Direct link to Solution:">​</a></h3>
<p>To overcome this issue, follow the recommended solution below:</p>
<p>Utilize the provided <code>cleanup.sh</code> scripts to ensure a proper cleanup of resources. Run the `cleanup.sh`` script, which is included in the blueprint.
This script will handle the removal of any lingering ENIs and associated security groups.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=error-could-not-download-chart>Error: could not download chart<a href=#error-could-not-download-chart class=hash-link aria-label="Direct link to Error: could not download chart" title="Direct link to Error: could not download chart">​</a></h2>
<p>If you encounter the following error while attempting to download a chart:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">│ Error: could not download chart: failed to download </span><span class="token string" style=color:#e3116c>"oci://public.ecr.aws/karpenter/karpenter"</span><span class="token plain"> at version </span><span class="token string" style=color:#e3116c>"v0.18.1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">│</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│   with module.eks_blueprints_kubernetes_addons.module.karpenter</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain">.module.helm_addon.helm_release.addon</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>0</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain">,</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│   on .terraform/modules/eks_blueprints_kubernetes_addons/modules/kubernetes-addons/helm-addon/main.tf line </span><span class="token number" style=color:#36acaa>1</span><span class="token plain">, </span><span class="token keyword" style=color:#00009f>in</span><span class="token plain"> resource </span><span class="token string" style=color:#e3116c>"helm_release"</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"addon"</span><span class="token builtin class-name">:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">│    </span><span class="token number" style=color:#36acaa>1</span><span class="token plain">: resource </span><span class="token string" style=color:#e3116c>"helm_release"</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"addon"</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">│</span><br></span></code></pre></div></div>
<p>Follow the steps below to resolve the issue:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=issue-description-2>Issue Description:<a href=#issue-description-2 class=hash-link aria-label="Direct link to Issue Description:" title="Direct link to Issue Description:">​</a></h3>
<p>The error message indicates that there was a failure in downloading the specified chart. This issue can occur due to a bug in Terraform during the installation of Karpenter.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=solution-2>Solution:<a href=#solution-2 class=hash-link aria-label="Direct link to Solution:" title="Direct link to Solution:">​</a></h3>
<p>To resolve the issue, you can try the following steps:</p>
<p>Authenticate with ECR: Run the following command to authenticate with the ECR (Elastic Container Registry) where the chart is located:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">aws ecr-public get-login-password </span><span class="token parameter variable" style=color:#36acaa>--region</span><span class="token plain"> us-east-1 </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>docker</span><span class="token plain"> login </span><span class="token parameter variable" style=color:#36acaa>--username</span><span class="token plain"> AWS --password-stdin public.ecr.aws</span><br></span></code></pre></div></div>
<p>Re-run terraform apply: Execute the terraform apply command again with the --auto-approve flag to reapply the Terraform configuration:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">terraform apply --auto-approve</span><br></span></code></pre></div></div>
<p>By authenticating with ECR and re-running the terraform apply command, you will ensure that the necessary chart can be downloaded successfully during the installation process.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=terraform-applydestroy-error-to-authenticate-with-eks-cluster>Terraform apply/destroy error to authenticate with EKS Cluster<a href=#terraform-applydestroy-error-to-authenticate-with-eks-cluster class=hash-link aria-label="Direct link to Terraform apply/destroy error to authenticate with EKS Cluster" title="Direct link to Terraform apply/destroy error to authenticate with EKS Cluster">​</a></h2>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">ERROR:</span><br></span><span class=token-line style=color:#393A34><span class="token plain">╷</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│ Error: Get "http://localhost/api/v1/namespaces/kube-system/configmaps/aws-auth": dial tcp [::1]:80: connect: connection refused</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│   with module.eks.kubernetes_config_map_v1_data.aws_auth[0],</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│   on .terraform/modules/eks/main.tf line 550, in resource "kubernetes_config_map_v1_data" "aws_auth":</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│  550: resource "kubernetes_config_map_v1_data" "aws_auth" {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│</span><br></span><span class=token-line style=color:#393A34><span class="token plain">╵</span><br></span></code></pre></div></div>
<p><strong>Solution:</strong>
In this situation Terraform is unable to refresh the data resources and authenticate with EKS Cluster.
See the discussion <a href=https://github.com/terraform-aws-modules/terraform-aws-eks/issues/1234 target=_blank rel="noopener noreferrer">here</a></p>
<p>Try this approach first by using exec plugin.</p>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">provider "kubernetes" {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  host                   = module.eks_blueprints.eks_cluster_endpoint</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  cluster_ca_certificate = base64decode(module.eks_blueprints.eks_cluster_certificate_authority_data)</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  exec {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    api_version = "client.authentication.k8s.io/v1beta1"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    command     = "aws"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    args = ["eks", "get-token", "--cluster-name", module.eks_blueprints.eks_cluster_id]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span></code></pre></div></div>
<p>If the issue still persists even after the above change then you can use alternative approach of using local kube config file.
NOTE: This approach might not be ideal for production. It helps you to apply/destroy clusters with your local kube config.</p>
<ol>
<li>Create a local kubeconfig for your cluster</li>
</ol>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">aws eks update-kubeconfig </span><span class="token parameter variable" style=color:#36acaa>--name</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">EKS_CLUSTER_NAME</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>--region</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">CLUSTER_REGION</span><span class="token operator" style=color:#393A34>></span><br></span></code></pre></div></div>
<ol start=2>
<li>Update the <code>providers.tf</code> file with the below config by just using the config_path.</li>
</ol>
<div class="language-terraform codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-terraform codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">provider "kubernetes" {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    config_path = "&lt;HOME_PATH>/.kube/config"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">provider "helm" {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    kubernetes {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        config_path = "&lt;HOME_PATH>/.kube/config"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">provider "kubectl" {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    config_path = "&lt;HOME_PATH>/.kube/config"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=emr-containers-virtual-cluster-dhwtlq9yx34duzq5q3akjac00-delete-unexpected-state-arrested>EMR Containers Virtual Cluster (dhwtlq9yx34duzq5q3akjac00) delete: unexpected state 'ARRESTED'<a href=#emr-containers-virtual-cluster-dhwtlq9yx34duzq5q3akjac00-delete-unexpected-state-arrested class=hash-link aria-label="Direct link to EMR Containers Virtual Cluster (dhwtlq9yx34duzq5q3akjac00) delete: unexpected state 'ARRESTED'" title="Direct link to EMR Containers Virtual Cluster (dhwtlq9yx34duzq5q3akjac00) delete: unexpected state 'ARRESTED'">​</a></h2>
<p>If you encounter an error message stating "waiting for EMR Containers Virtual Cluster (xwbc22787q6g1wscfawttzzgb) delete: unexpected state 'ARRESTED', wanted target ''. last error: %!s(nil)", you can follow the steps below to resolve the issue:</p>
<p>Note: Replace <code>&lt;REGION></code> with the appropriate AWS region where the virtual cluster is located.</p>
<ol>
<li>Open a terminal or command prompt.</li>
<li>Run the following command to list the virtual clusters in the "ARRESTED" state:</li>
</ol>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">aws emr-containers list-virtual-clusters </span><span class="token parameter variable" style=color:#36acaa>--region</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">REGION</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>--states</span><span class="token plain"> ARRESTED </span><span class="token punctuation" style=color:#393A34>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token parameter variable" style=color:#36acaa>--query</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'virtualClusters[0].id'</span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>--output</span><span class="token plain"> text</span><br></span></code></pre></div></div>
<p>This command retrieves the ID of the virtual cluster in the "ARRESTED" state.</p>
<ol start=3>
<li>Run the following command to delete the virtual cluster:</li>
</ol>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">aws emr-containers list-virtual-clusters </span><span class="token parameter variable" style=color:#36acaa>--region</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">REGION</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>--states</span><span class="token plain"> ARRESTED </span><span class="token punctuation" style=color:#393A34>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token parameter variable" style=color:#36acaa>--query</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'virtualClusters[0].id'</span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>--output</span><span class="token plain"> text </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>xargs</span><span class="token plain"> -I</span><span class="token punctuation" style=color:#393A34>{</span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"> aws emr-containers delete-virtual-cluster </span><span class="token punctuation" style=color:#393A34>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token parameter variable" style=color:#36acaa>--region</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">REGION</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>--id</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token punctuation" style=color:#393A34>}</span><br></span></code></pre></div></div>
<p>Replace <code>&lt;VIRTUAL_CLUSTER_ID></code> with the ID of the virtual cluster obtained from the previous step.</p>
<p>By executing these commands, you will be able to delete the virtual cluster that is in the "ARRESTED" state. This should resolve the unexpected state issue and allow you to proceed with further operations.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=terminating-namespace-issue>Terminating namespace issue<a href=#terminating-namespace-issue class=hash-link aria-label="Direct link to Terminating namespace issue" title="Direct link to Terminating namespace issue">​</a></h2>
<p>If you encounter the issue where a namespace is stuck in the "Terminating" state and cannot be deleted, you can use the following command to remove the finalizers on the namespace:</p>
<p>Note: Replace <code>&lt;namespace></code> with the name of the namespace you want to delete.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token assign-left variable" style=color:#36acaa>NAMESPACE</span><span class="token operator" style=color:#393A34>=</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">namespace</span><span class="token operator" style=color:#393A34>></span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">kubectl get namespace </span><span class="token variable" style=color:#36acaa>$NAMESPACE</span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>-o</span><span class="token plain"> json </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>sed</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>'s/"kubernetes"//'</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> kubectl replace </span><span class="token parameter variable" style=color:#36acaa>--raw</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"/api/v1/namespaces/</span><span class="token string variable" style=color:#36acaa>$NAMESPACE</span><span class="token string" style=color:#e3116c>/finalize"</span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>-f</span><span class="token plain"> -</span><br></span></code></pre></div></div>
<p>This command retrieves the namespace details in JSON format, removes the "kubernetes" finalizer, and performs a replace operation to remove the finalizer from the namespace. This should allow the namespace to complete the termination process and be successfully deleted.</p>
<p>Please ensure that you have the necessary permissions to perform this operation. If you continue to experience issues or require further assistance, please reach out to our support team for additional guidance and troubleshooting steps.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=kms-alias-alreadyexistsexception>KMS Alias AlreadyExistsException<a href=#kms-alias-alreadyexistsexception class=hash-link aria-label="Direct link to KMS Alias AlreadyExistsException" title="Direct link to KMS Alias AlreadyExistsException">​</a></h2>
<p>During your Terraform installation or redeployment, you might encounter an error saying: <code>AlreadyExistsException: An alias with the name ...</code> already exists. This happens when the KMS alias you're trying to create already exists in your AWS account.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">│ Error: creating KMS Alias (alias/eks/trainium-inferentia): AlreadyExistsException: An alias with the name arn:aws:kms:us-west-2:23423434:alias/eks/trainium-inferentia already exists</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│   with module.eks.module.kms.aws_kms_alias.this["cluster"],</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│   on .terraform/modules/eks.kms/main.tf line 452, in resource "aws_kms_alias" "this":</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│  452: resource "aws_kms_alias" "this" {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│</span><br></span></code></pre></div></div>
<p><strong>Solution:</strong></p>
<p>To resolve this, delete the existing KMS alias using the aws kms delete-alias command. Remember to update the alias name and region in the command before running it.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">aws kms delete-alias --alias-name </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">KMS_ALIAS_NAME</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>--region</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">ENTER_REGION</span><span class="token operator" style=color:#393A34>></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=error-creating-cloudwatch-logs-log-group>Error: creating CloudWatch Logs Log Group<a href=#error-creating-cloudwatch-logs-log-group class=hash-link aria-label="Direct link to Error: creating CloudWatch Logs Log Group" title="Direct link to Error: creating CloudWatch Logs Log Group">​</a></h2>
<p>Terraform cannot create a CloudWatch Logs log group because it already exists in your AWS account.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">╷</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│ Error: creating CloudWatch Logs Log Group (/aws/eks/trainium-inferentia/cluster): operation error CloudWatch Logs: CreateLogGroup, https response error StatusCode: 400, RequestID: 5c34c47a-72c6-44b2-a345-925824f24d38, ResourceAlreadyExistsException: The specified log group already exists</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│   with module.eks.aws_cloudwatch_log_group.this[0],</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│   on .terraform/modules/eks/main.tf line 106, in resource "aws_cloudwatch_log_group" "this":</span><br></span><span class=token-line style=color:#393A34><span class="token plain">│  106: resource "aws_cloudwatch_log_group" "this" {</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span></code></pre></div></div>
<p><strong>Solution:</strong></p>
<p>Delete the existing log group by updating log group name and the region.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">aws logs delete-log-group --log-group-name </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">LOG_GROUP_NAME</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>--region</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">ENTER_REGION</span><span class="token operator" style=color:#393A34>></span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=karpenter-error---missing-service-linked-role>Karpenter Error - Missing Service Linked Role<a href=#karpenter-error---missing-service-linked-role class=hash-link aria-label="Direct link to Karpenter Error - Missing Service Linked Role" title="Direct link to Karpenter Error - Missing Service Linked Role">​</a></h2>
<p>Karpenter throws below error while trying to create new instances.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">"error":"launching nodeclaim, creating instance, with fleet error(s), AuthFailure.ServiceLinkedRoleCreationNotPermitted: The provided credentials do not have permission to create the service-linked role for EC2 Spot Instances."}</span><br></span></code></pre></div></div>
<p><strong>Solution:</strong></p>
<p>You will need to create the service linked role in the AWS account you're using to avoid <code>ServiceLinkedRoleCreationNotPermitted</code> error.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">aws iam create-service-linked-role --aws-service-name spot.amazonaws.com</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=error-amazoneks_cni_ipv6_policy-does-not-exist>Error: AmazonEKS_CNI_IPv6_Policy does not exist<a href=#error-amazoneks_cni_ipv6_policy-does-not-exist class=hash-link aria-label="Direct link to Error: AmazonEKS_CNI_IPv6_Policy does not exist" title="Direct link to Error: AmazonEKS_CNI_IPv6_Policy does not exist">​</a></h2>
<p>If you encounter the error below when deploying a solution that supports IPv6:</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">│ Error: attaching IAM Policy </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">arn:aws:iam::1234567890:policy/AmazonEKS_CNI_IPv6_Policy</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> to IAM Role </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">core-node-group-eks-node-group-20241111182906854800000003</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain">: operation error IAM: AttachRolePolicy, https response error StatusCode: </span><span class="token number" style=color:#36acaa>404</span><span class="token plain">, RequestID: 9c99395a-ce3d-4a05-b119-538470a3a9f7, NoSuchEntity: Policy arn:aws:iam::1234567890:policy/AmazonEKS_CNI_IPv6_Policy does not exist or is not attachable.</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=issue-description-3>Issue Description:<a href=#issue-description-3 class=hash-link aria-label="Direct link to Issue Description:" title="Direct link to Issue Description:">​</a></h3>
<p>The Amazon VPC CNI plugin requires IAM permission to assign IPv6 addresses so you must create an IAM policy and associate it with the role that the CNI will use. However, each IAM policy name must be unique in the same AWS account. This causes a conflict if the policy is created as part of the terraform stack and it is deployed multiple times.</p>
<p>To resolve this error you will need to create the Policy with the commands below. You should only need to do this once per AWS account.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=solution-3>Solution:<a href=#solution-3 class=hash-link aria-label="Direct link to Solution:" title="Direct link to Solution:">​</a></h3>
<ol>
<li>Copy the following text and save it to a file named vpc-cni-ipv6-policy.json.</li>
</ol>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token string" style=color:#e3116c>"Version"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"2012-10-17"</span><span class="token plain">,</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token string" style=color:#e3116c>"Statement"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token string" style=color:#e3116c>"Effect"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"Allow"</span><span class="token plain">,</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token string" style=color:#e3116c>"Action"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token string" style=color:#e3116c>"ec2:AssignIpv6Addresses"</span><span class="token plain">,</span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token string" style=color:#e3116c>"ec2:DescribeInstances"</span><span class="token plain">,</span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token string" style=color:#e3116c>"ec2:DescribeTags"</span><span class="token plain">,</span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token string" style=color:#e3116c>"ec2:DescribeNetworkInterfaces"</span><span class="token plain">,</span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token string" style=color:#e3116c>"ec2:DescribeInstanceTypes"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain">,</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token string" style=color:#e3116c>"Resource"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>""</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain">,</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token string" style=color:#e3116c>"Effect"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"Allow"</span><span class="token plain">,</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token string" style=color:#e3116c>"Action"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token string" style=color:#e3116c>"ec2:CreateTags"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain">,</span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token string" style=color:#e3116c>"Resource"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>[</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">                </span><span class="token string" style=color:#e3116c>"arn:aws:ec2::*:network-interface/*"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><br></span></code></pre></div></div>
<ol start=2>
<li>Create the IAM policy.</li>
</ol>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">aws iam create-policy --policy-name AmazonEKS_CNI_IPv6_Policy --policy-document file://vpc-cni-ipv6-policy.json</span><br></span></code></pre></div></div>
<ol start=3>
<li>Re-run the <code>install.sh</code> script for the blueprint</li>
</ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/awslabs/data-on-eks/blob/main/website/docs/blueprints/troubleshooting/troubleshooting.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/data-on-eks/docs/blueprints/distributed-databases/aerospike><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Aerospike</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#error-local-exec-provisioner-error class="table-of-contents__link toc-highlight">Error: local-exec provisioner error</a><ul><li><a href=#issue-description class="table-of-contents__link toc-highlight">Issue Description:</a><li><a href=#solution class="table-of-contents__link toc-highlight">Solution</a></ul><li><a href=#timeouts-during-terraform-destroy class="table-of-contents__link toc-highlight">Timeouts during Terraform Destroy</a><ul><li><a href=#issue-description-1 class="table-of-contents__link toc-highlight">Issue Description:</a><li><a href=#symptoms class="table-of-contents__link toc-highlight">Symptoms:</a><li><a href=#solution-1 class="table-of-contents__link toc-highlight">Solution:</a></ul><li><a href=#error-could-not-download-chart class="table-of-contents__link toc-highlight">Error: could not download chart</a><ul><li><a href=#issue-description-2 class="table-of-contents__link toc-highlight">Issue Description:</a><li><a href=#solution-2 class="table-of-contents__link toc-highlight">Solution:</a></ul><li><a href=#terraform-applydestroy-error-to-authenticate-with-eks-cluster class="table-of-contents__link toc-highlight">Terraform apply/destroy error to authenticate with EKS Cluster</a><li><a href=#emr-containers-virtual-cluster-dhwtlq9yx34duzq5q3akjac00-delete-unexpected-state-arrested class="table-of-contents__link toc-highlight">EMR Containers Virtual Cluster (dhwtlq9yx34duzq5q3akjac00) delete: unexpected state 'ARRESTED'</a><li><a href=#terminating-namespace-issue class="table-of-contents__link toc-highlight">Terminating namespace issue</a><li><a href=#kms-alias-alreadyexistsexception class="table-of-contents__link toc-highlight">KMS Alias AlreadyExistsException</a><li><a href=#error-creating-cloudwatch-logs-log-group class="table-of-contents__link toc-highlight">Error: creating CloudWatch Logs Log Group</a><li><a href=#karpenter-error---missing-service-linked-role class="table-of-contents__link toc-highlight">Karpenter Error - Missing Service Linked Role</a><li><a href=#error-amazoneks_cni_ipv6_policy-does-not-exist class="table-of-contents__link toc-highlight">Error: AmazonEKS_CNI_IPv6_Policy does not exist</a><ul><li><a href=#issue-description-3 class="table-of-contents__link toc-highlight">Issue Description:</a><li><a href=#solution-3 class="table-of-contents__link toc-highlight">Solution:</a></ul></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Get Started</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/data-on-eks/docs/introduction/intro>Docs</a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Get Involved</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://github.com/awslabs/data-on-eks target=_blank rel="noopener noreferrer" class=footer__link-item>Github<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Built with ❤️ at AWS  <br> © 2025 Amazon.com, Inc. or its affiliates. All Rights Reserved</div></div></div></footer><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "7fbc7ab02fae4767b1af2588eba0cdf2"}'></script></div>