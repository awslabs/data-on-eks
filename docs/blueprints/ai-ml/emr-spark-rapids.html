<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-blueprints/ai-ml/emr-spark-rapids" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">EMR on EKS NVIDIA RAPIDS Accelerator for Apache Spark | Data on EKS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://awslabs.github.io/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="EMR on EKS NVIDIA RAPIDS Accelerator for Apache Spark | Data on EKS"><meta data-rh="true" name="description" content="The NVIDIA RAPIDS Accelerator for Apache Spark is a powerful tool that builds on the capabilities of NVIDIA CUDAÂ® - a transformative parallel computing platform designed for enhancing computational processes on NVIDIA&#x27;s GPU architecture. RAPIDS, a project developed by NVIDIA, comprises a suite of open-source libraries that are hinged upon CUDA, thereby enabling GPU-accelerated data science workflows."><meta data-rh="true" property="og:description" content="The NVIDIA RAPIDS Accelerator for Apache Spark is a powerful tool that builds on the capabilities of NVIDIA CUDAÂ® - a transformative parallel computing platform designed for enhancing computational processes on NVIDIA&#x27;s GPU architecture. RAPIDS, a project developed by NVIDIA, comprises a suite of open-source libraries that are hinged upon CUDA, thereby enabling GPU-accelerated data science workflows."><link data-rh="true" rel="icon" href="/data-on-eks/img/header-icon.png"><link data-rh="true" rel="canonical" href="https://awslabs.github.io/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids"><link data-rh="true" rel="alternate" href="https://awslabs.github.io/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids" hreflang="en"><link data-rh="true" rel="alternate" href="https://awslabs.github.io/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids" hreflang="x-default"><link rel="stylesheet" href="/data-on-eks/assets/css/styles.f39770c7.css">
<script src="/data-on-eks/assets/js/runtime~main.eba6fdd1.js" defer="defer"></script>
<script src="/data-on-eks/assets/js/main.8924eeff.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/data-on-eks/"><div class="navbar__logo"><img src="/data-on-eks/img/header-icon.png" alt="DoEKS Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/data-on-eks/img/header-icon.png" alt="DoEKS Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/data-on-eks/docs/introduction/intro">Introduction</a><a class="navbar__item navbar__link" href="/data-on-eks/docs/gen-ai">Gen AI</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/data-on-eks/docs/blueprints/amazon-emr-on-eks">Blueprints</a><a class="navbar__item navbar__link" href="/data-on-eks/docs/bestpractices/intro">Best Practices</a><a class="navbar__item navbar__link" href="/data-on-eks/docs/benchmarks/emr-on-eks">Benchmarks</a><a class="navbar__item navbar__link" href="/data-on-eks/docs/resources/intro">Resources</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/awslabs/data-on-eks" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/data-on-eks/docs/category/amazon-emr-on-eks">Amazon EMR on EKS</a><button aria-label="Expand sidebar category &#x27;Amazon EMR on EKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/data-on-eks/docs/category/data-analytics-on-eks">Data Analytics on EKS</a><button aria-label="Expand sidebar category &#x27;Data Analytics on EKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/data-on-eks/docs/category/aiml-on-eks">AI/ML on EKS</a><button aria-label="Collapse sidebar category &#x27;AI/ML on EKS&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-on-eks/docs/blueprints/ai-ml">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-on-eks/docs/blueprints/ai-ml/ray">Ray on EKS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-on-eks/docs/blueprints/ai-ml/jupyterhub">JupyterHub on EKS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids">EMR NVIDIA Spark-RAPIDS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/data-on-eks/docs/blueprints/ai-ml/trainium">Trainium on EKS</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/data-on-eks/docs/category/job-schedulers-on-eks">Job Schedulers on EKS</a><button aria-label="Expand sidebar category &#x27;Job Schedulers on EKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/data-on-eks/docs/category/streaming-platforms-on-eks">Streaming Platforms on EKS</a><button aria-label="Expand sidebar category &#x27;Streaming Platforms on EKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/data-on-eks/docs/category/distributed-databases-on-eks">Distributed Databases on EKS</a><button aria-label="Expand sidebar category &#x27;Distributed Databases on EKS&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/data-on-eks/docs/blueprints/troubleshooting">Troubleshooting</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/data-on-eks/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/data-on-eks/docs/category/aiml-on-eks"><span itemprop="name">AI/ML on EKS</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">EMR NVIDIA Spark-RAPIDS</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>EMR on EKS NVIDIA RAPIDS Accelerator for Apache Spark</h1>
<p>The NVIDIA RAPIDS Accelerator for Apache Spark is a powerful tool that builds on the capabilities of NVIDIA CUDAÂ® - a transformative parallel computing platform designed for enhancing computational processes on NVIDIA&#x27;s GPU architecture. RAPIDS, a project developed by NVIDIA, comprises a suite of open-source libraries that are hinged upon CUDA, thereby enabling GPU-accelerated data science workflows.</p>
<p>With the invention of the RAPIDS Accelerator for Spark 3, NVIDIA has successfully revolutionized extract, transform, and load pipelines by significantly enhancing the efficiency of Spark SQL and DataFrame operations. By merging the capabilities of the RAPIDS cuDF library and the extensive reach of the Spark distributed computing ecosystem, the RAPIDS Accelerator for Apache Spark provides a robust solution to handle large-scale computations.
Moreover, the RAPIDS Accelerator library incorporates an advanced shuffle optimized by UCX, which can be configured to support GPU-to-GPU communication and RDMA capabilities, hence further boosting its performance.</p>
<p><img decoding="async" loading="lazy" alt="Alt text" src="/data-on-eks/assets/images/nvidia-505240d62b417acc46d631e6db952871.png" width="1200" height="676" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="emr-support-for-nvidia-rapids-accelerator-for-apache-spark">EMR support for NVIDIA RAPIDS Accelerator for Apache Spark<a class="hash-link" aria-label="Direct link to EMR support for NVIDIA RAPIDS Accelerator for Apache Spark" title="Direct link to EMR support for NVIDIA RAPIDS Accelerator for Apache Spark" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#emr-support-for-nvidia-rapids-accelerator-for-apache-spark">â€‹</a></h3>
<p>Integration of Amazon EMR with NVIDIA RAPIDS Accelerator for Apache Sparkâ€‹ Amazon EMR on EKS now extends its support to include the use of GPU instance types with the NVIDIA RAPIDS Accelerator for Apache Spark. As the use of artificial intelligence (AI) and machine learning (ML) continues to expand in the realm of data analytics, there&#x27;s an increasing demand for rapid and cost-efficient data processing, which GPUs can provide. The NVIDIA RAPIDS Accelerator for Apache Spark enables users to harness the superior performance of GPUs, leading to substantial infrastructure cost savings.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="features">Features<a class="hash-link" aria-label="Direct link to Features" title="Direct link to Features" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#features">â€‹</a></h3>
<ul>
<li>
<p>Highlighted Featuresâ€‹ Experience a performance boost in data preparation tasks, allowing you to transition quickly to the subsequent stages of your pipeline. This not only accelerates model training but also liberates data scientists and engineers to concentrate on priority tasks.</p>
</li>
<li>
<p>Spark 3 ensures seamless coordination of end-to-end pipelines - from data ingestion, through model training, to visualization. The same GPU-accelerated setup can serve both Spark and machine learning or deep learning frameworks. This obviates the need for discrete clusters and provides GPU acceleration to the entire pipeline.</p>
</li>
<li>
<p>Spark 3 extends support for columnar processing in the Catalyst query optimizer. The RAPIDS Accelerator can plug into this system to speed up SQL and DataFrame operators. When the query plan is actioned, these operators can then utilize the GPUs within the Spark cluster for improved performance.</p>
</li>
<li>
<p>NVIDIA has introduced an innovative Spark shuffle implementation designed to optimize data exchange between Spark tasks. This shuffle system is built on GPU-boosted communication libraries, including UCX, RDMA, and NCCL, which significantly enhance data transfer rates and overall performance.-</p>
</li>
</ul>
<div class="collapsibleContent_q3kw"><div class="header_QCEw"><h2><span>Deploying the Solution</span></h2><span class="icon_PckA">ðŸ‘ˆ</span></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="launching-xgboost-spark-job">Launching XGBoost Spark Job<a class="hash-link" aria-label="Direct link to Launching XGBoost Spark Job" title="Direct link to Launching XGBoost Spark Job" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#launching-xgboost-spark-job">â€‹</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="training-dataset">Training Dataset<a class="hash-link" aria-label="Direct link to Training Dataset" title="Direct link to Training Dataset" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#training-dataset">â€‹</a></h4>
<p>Fannie Maeâ€™s Single-Family Loan Performance Data has a comprehensive dataset starting from 2013. It provides valuable insights into the credit performance of a portion of Fannie Maeâ€™s single-family book of business. This dataset is designed to assist investors in better understanding the credit performance of single-family loans owned or guaranteed by Fannie Mae.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-building-a-custom-docker-image">Step 1: Building a Custom Docker Image<a class="hash-link" aria-label="Direct link to Step 1: Building a Custom Docker Image" title="Direct link to Step 1: Building a Custom Docker Image" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#step-1-building-a-custom-docker-image">â€‹</a></h4>
<ul>
<li>To pull the Spark Rapids base image from the EMR on EKS ECR repository located in <code>us-west-2</code>, log in:</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin 895885662937.dkr.ecr.us-west-2.amazonaws.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>If you&#x27;re located in a different region, please refer to: this <a href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/docker-custom-images-tag.html." target="_blank" rel="noopener noreferrer">guide</a>.</p>
<ul>
<li>To build your Docker image locally, use the following command:</li>
</ul>
<p>Build the custom Docker image using the provided <code>Dockerfile</code>. Choose a tag for the image, such as 0.10.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Please note that the build process may take some time, depending on your network speed. Keep in mind that the resulting image size will be approximately <code>23.5GB</code>.</p></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd ~/data-on-eks/ai-ml/emr-spark-rapids/examples/xgboost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker build -t emr-6.10.0-spark-rapids-custom:0.10 -f Dockerfile .</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Replace <code>&lt;ACCOUNTID&gt;</code> with your AWS account ID. Log in to your ECR repository with the following command:</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin &lt;ACCOUNTID&gt;.dkr.ecr.us-west-2.amazonaws.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>To push your Docker image to your ECR, use:</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker tag emr-6.10.0-spark-rapids-custom:0.10 &lt;ACCOUNT_ID&gt;.dkr.ecr.us-west-2.amazonaws.com/emr-6.10.0-spark-rapids-custom:0.10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker push &lt;ACCOUNT_ID&gt;.dkr.ecr.us-west-2.amazonaws.com/emr-6.10.0-spark-rapids-custom:0.10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>You can use this image during the job execution in <code>Step3</code> .</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step2-acquire-the-input-data-fannie-maes-single-family-loan-performance-data">Step2: Acquire the Input Data (Fannie Maeâ€™s Single-Family Loan Performance Data)<a class="hash-link" aria-label="Direct link to Step2: Acquire the Input Data (Fannie Maeâ€™s Single-Family Loan Performance Data)" title="Direct link to Step2: Acquire the Input Data (Fannie Maeâ€™s Single-Family Loan Performance Data)" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#step2-acquire-the-input-data-fannie-maes-single-family-loan-performance-data">â€‹</a></h3>
<p>This dataset is sourced from <a href="http://www.fanniemae.com/portal/funding-the-market/data/loan-performance-data.html" target="_blank" rel="noopener noreferrer">Fannie Maeâ€™s Single-Family Loan Performance Data</a>. All rights are held by Fannie Mae.</p>
<ol>
<li>Go to the <a href="https://capitalmarkets.fanniemae.com/credit-risk-transfer/single-family-credit-risk-transfer/fannie-mae-single-family-loan-performance-data" target="_blank" rel="noopener noreferrer">Fannie Mae</a> website</li>
<li>Click on <a href="https://datadynamics.fanniemae.com/data-dynamics/?&amp;_ga=2.181456292.2043790680.1657122341-289272350.1655822609#/reportMenu;category=HP" target="_blank" rel="noopener noreferrer">Single-Family Loan Performance Data</a>
<ul>
<li>Register as a new user if you are using the website for the first time</li>
<li>Use the credentials to login</li>
</ul>
</li>
<li>Select <a href="https://datadynamics.fanniemae.com/data-dynamics/#/reportMenu;category=HP" target="_blank" rel="noopener noreferrer">HP</a></li>
<li>Click on  <code>Download Data</code> and choose <code>Single-Family Loan Performance Data</code></li>
<li>You will find a tabular list of Acquisition and Performance` files sorted based on year and quarter. Click on the file to download. You can download three years(2020, 2021 and 2022 - 4 files for each year and one for each quarter) worth of data that will be used in our example job.  e.g.,: 2017Q1.zip</li>
<li>Unzip the download file to extract the csv file to your local machine. e.g.,: 2017Q1.csv</li>
<li>Copy only the CSV files to an S3 bucket under <code>${S3_BUCKET}/${EMR_VIRTUAL_CLUSTER_ID}/spark-rapids-emr/input/fannie-mae-single-family-loan-performance/</code>. The example below uses three years of data (one file for each quarter, 12 files in total). Note: <code>${S3_BUCKET}</code> and <code>${EMR_VIRTUAL_CLUSTER_ID}</code> values can be extracted from Terraform outputs.</li>
</ol>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> aws s3 ls s3://emr-spark-rapids-&lt;aws-account-id&gt;-us-west-2/949wt7zuphox1beiv0i30v65i/spark-rapids-emr/input/fannie-mae-single-family-loan-performance/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2023-06-24 21:38:25 2301641519 2000Q1.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2023-06-24 21:38:25 9739847213 2020Q2.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2023-06-24 21:38:25 10985541111 2020Q3.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2023-06-24 21:38:25 11372073671 2020Q4.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2023-06-23 16:38:36 9603950656 2021Q1.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2023-06-23 16:38:36 7955614945 2021Q2.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2023-06-23 16:38:36 5365827884 2021Q3.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2023-06-23 16:38:36 4390166275 2021Q4.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2023-06-22 19:20:08 2723499898 2022Q1.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2023-06-22 19:20:08 1426204690 2022Q2.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2023-06-22 19:20:08  595639825 2022Q3.csv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    2023-06-22 19:20:08  180159771 2022Q4.csv</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step3-run-the-emr-spark-xgboost-job">Step3: Run the EMR Spark XGBoost Job<a class="hash-link" aria-label="Direct link to Step3: Run the EMR Spark XGBoost Job" title="Direct link to Step3: Run the EMR Spark XGBoost Job" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#step3-run-the-emr-spark-xgboost-job">â€‹</a></h3>
<p>Here, we will utilize a helper shell script to execute the job. This script requires user input.</p>
<p>This script will ask for certain inputs that you can obtain from Terraform outputs. See the example below.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd ai-ml/emr-spark-rapids/examples/xgboost/ &amp;&amp; chmod +x execute_spark_rapids_xgboost.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">./execute_spark_rapids_xgboost.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Example inputs shown below</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Did you copy the fannie-mae-single-family-loan-performance data to S3 bucket(y/n): y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Enter the customized Docker image URI: public.ecr.aws/o7d8v7g9/emr-6.10.0-spark-rapids:0.11</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Enter EMR Virtual Cluster AWS Region: us-west-2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Enter the EMR Virtual Cluster ID: 949wt7zuphox1beiv0i30v65i</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Enter the EMR Execution Role ARN: arn:aws:iam::&lt;ACCOUNTID&gt;:role/emr-spark-rapids-emr-eks-data-team-a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Enter the CloudWatch Log Group name: /emr-on-eks-logs/emr-spark-rapids/emr-ml-team-a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Enter the S3 Bucket for storing PySpark Scripts, Pod Templates, Input data and Output data.&lt;bucket-name&gt;: emr-spark-rapids-&lt;ACCOUNTID&gt;-us-west-2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Enter the number of executor instances (4 to 8): 8</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Verify the pod status</p>
<p><img decoding="async" loading="lazy" alt="Alt text" src="/data-on-eks/assets/images/spark-rapids-pod-status-c53b6ca113b175c12558cbd200441bbd.png" width="2846" height="848" class="img_ev3q"></p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Note that the first execution might take longer as it needs to download the image for the EMR Job Pod, Driver, and Executor pods. Each pod may take up to 8 minutes to download the Docker image. Subsequent runs should be faster (usually under 30 seconds), thanks to image caching</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="step4-verify-the-job-results">Step4: Verify the Job results<a class="hash-link" aria-label="Direct link to Step4: Verify the Job results" title="Direct link to Step4: Verify the Job results" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#step4-verify-the-job-results">â€‹</a></h3>
<ul>
<li>Log in to check the Spark driver pod logs from either CloudWatch logs or your S3 bucket.</li>
</ul>
<p>Here&#x27;s a sample output from the log file:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/emr-on-eks-logs/emr-spark-rapids/emr-ml-team-a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spark-rapids-emr/949wt7zuphox1beiv0i30v65i/jobs/0000000327fe50tosa4/containers/spark-0000000327fe50tosa4/spark-0000000327fe50tosa4-driver/stdout</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The following is a sample output from the above log file:</p>
<p>Raw Dataframe CSV Rows count : 215386024
Raw Dataframe Parquet Rows count : 215386024
ETL takes 222.34674382209778</p>
<p>Training takes 95.90932035446167 seconds
If features_cols param set, then features_col param is ignored.</p>
<p>Transformation takes 63.999391317367554 seconds
+--------------+--------------------+--------------------+----------+
|delinquency_12|       rawPrediction|         probability|prediction|
+--------------+--------------------+--------------------+----------+
|             0|[10.4500541687011...|[0.99997103214263...|       0.0|
|             0|[10.3076572418212...|[0.99996662139892...|       0.0|
|             0|[9.81707763671875...|[0.99994546175003...|       0.0|
|             0|[9.10498714447021...|[0.99988889694213...|       0.0|
|             0|[8.81903457641601...|[0.99985212087631...|       0.0|
+--------------+--------------------+--------------------+----------+
only showing top 5 rows</p>
<p>Evaluation takes 3.8372223377227783 seconds
Accuracy is 0.996563056111921</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ml-pipeline-for-fannie-mae-single-loan-performance-dataset">ML Pipeline for Fannie Mae Single Loan Performance Dataset<a class="hash-link" aria-label="Direct link to ML Pipeline for Fannie Mae Single Loan Performance Dataset" title="Direct link to ML Pipeline for Fannie Mae Single Loan Performance Dataset" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#ml-pipeline-for-fannie-mae-single-loan-performance-dataset">â€‹</a></h3>
<p><strong>Step1</strong>: Preprocess and clean the dataset to handle missing values, categorical variables, and other data inconsistencies.This may involve techniques like data imputation,one-hot encoding, and data normalization.</p>
<p><strong>Step2</strong>: Create additional features from the existing ones that might provide more useful information for predicting loan performance. For example, you could extract features like loan-to-value ratio, borrower&#x27;s credit score range, or loan origination year.</p>
<p><strong>Step3</strong>: Divide the dataset into two parts: one for training the XGBoost model and one for evaluating its performance. This allows you to assess how well the model generalizes to unseen data.</p>
<p><strong>Step4</strong>: Feed the training dataset into XGBoost to train the model. XGBoost will analyze the loan attributes and their corresponding loan performance labels to learn the patterns and relationships between them. The objective is to predict whether a loan is likely to default or perform well based on the given features.</p>
<p><strong>Step5</strong>: Once the model is trained, use the evaluation dataset to assess its performance. This involves analyzing metrics such as accuracy, precision, recall, or area under the receiver operating characteristic curve (AUC-ROC) to measure how well the model predicts loan performance</p>
<p><strong>Step6</strong>: If the performance is not satisfactory, you can tune the XGBoost hyperparameters, such as the learning rate, tree depth, or regularization parameters, to improve the model&#x27;s accuracy or address issues like overfitting.</p>
<p><strong>Step7</strong>: Finally, with a trained and validated XGBoost model, you can use it to make predictions on new, unseen loan data. These predictions can help in identifying potential risks associated with loan default or evaluating loan performance.</p>
<p><img decoding="async" loading="lazy" alt="Alt text" src="/data-on-eks/assets/images/emr-spark-rapids-fannie-mae-d6c47c14cc7c259e4b07f7fb0b7914c9.png" width="9395" height="5403" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="gpu-monitoring-with-dcgm-exporter-prometheus-and-grafana">GPU Monitoring with DCGM Exporter, Prometheus and Grafana<a class="hash-link" aria-label="Direct link to GPU Monitoring with DCGM Exporter, Prometheus and Grafana" title="Direct link to GPU Monitoring with DCGM Exporter, Prometheus and Grafana" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#gpu-monitoring-with-dcgm-exporter-prometheus-and-grafana">â€‹</a></h3>
<p>Observability plays a crucial role in managing and optimizing hardware resources such as GPUs, particularly in machine learning workloads where the GPU utilization is high. The ability to monitor GPU usage in real-time, identify trends, and detect anomalies can significantly impact performance tuning, troubleshooting, and efficient resource utilization.</p>
<p><a href="https://github.com/NVIDIA/gpu-operator" target="_blank" rel="noopener noreferrer">NVIDIA GPU Operator</a> plays a key role in GPU observability. It automates the deployment of the necessary components to run GPU workloads on Kubernetes. One of its components, the <a href="https://docs.nvidia.com/datacenter/cloud-native/gpu-telemetry/latest/index.html" target="_blank" rel="noopener noreferrer">DCGM (Data Center GPU Manager) Exporter</a>, is an open-source project that exports GPU metrics in a format that can be ingested by Prometheus, a leading open-source monitoring solution. These metrics include GPU temperature, memory usage, GPU utilization, and more. The DCGM Exporter allows you to monitor these metrics on a per-GPU basis, providing granular visibility into your GPU resources.</p>
<p>The NVIDIA GPU Operator, in combination with the DCGM Exporter, exports GPU metrics to a Prometheus server. With its flexible query language, Prometheus allows you to slice and dice data to generate insights into resource usage patterns.</p>
<p>However, Prometheus is not designed for long-term data storage. This is where the <a href="https://aws.amazon.com/prometheus/" target="_blank" rel="noopener noreferrer">Amazon Managed Service for Prometheus (AMP)</a> comes into play. It provides a fully-managed, secure, and scalable service for Prometheus that makes it easy to analyze operational data at scale without having to manage the underlying infrastructure.</p>
<p>Visualizing these metrics and creating informative dashboards is where Grafana excels. Grafana is an open-source platform for monitoring and observability, offering rich visualizations to represent collected metrics intuitively. When combined with Prometheus, Grafana can display the GPU metrics collected by the DCGM Exporter in a user-friendly manner.</p>
<p>The NVIDIA GPU Operator is configured to export metrics to the Prometheus server, which then remote-writes these metrics to Amazon Managed Prometheus (AMP). As a user, you can log into the Grafana WebUI, deployed as part of the blueprint, and add AMP as a data source. Following this, you can import the open-source <a href="https://grafana.com/grafana/dashboards/12239-nvidia-dcgm-exporter-dashboard/" target="_blank" rel="noopener noreferrer">GPU monitoring dashboard</a> that presents GPU metrics in an easily digestible format, facilitating real-time performance monitoring and resource optimization.</p>
<ol>
<li><strong>NVIDIA GPU Operator</strong>: Installed on your Kubernetes cluster, the NVIDIA GPU Operator is responsible for managing the lifecycle of GPU resources. It deploys NVIDIA drivers and the DCGM Exporter on each GPU-equipped node.</li>
<li><strong>DCGM Exporter</strong>: The DCGM Exporter runs on each node, collecting GPU metrics and exposing them to Prometheus.</li>
<li><strong>Prometheus</strong>: Prometheus is a time-series database that collects metrics from various sources, including the DCGM Exporter. It pulls metrics from the exporter at regular intervals and stores them. In this setup, you would configure Prometheus to remote-write the collected metrics to AMP.</li>
<li><strong>Amazon Managed Service for Prometheus (AMP)</strong>: AMP is a fully-managed Prometheus service provided by AWS. It takes care of long-term storage, scalability, and security of your Prometheus data.</li>
<li><strong>Grafana</strong>: Grafana is a visualization tool that can query AMP for the collected metrics, and display them on informative dashboards.</li>
</ol>
<p>In this blueprint, we leverage DCGM to write GPU metrics to both Prometheus and Amazon Managed Prometheus (AMP). To verify the GPU metrics, you can use Grafana by running the following command:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">kubectl port-forward svc/grafana 3000:80 -n grafana</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">``</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Login to Grafana using `admin` as the username, and retrieve the password from Secrets Manager using the following AWS CLI command:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">```bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">aws secretsmanager get-secret-value --secret-id emr-spark-rapids-grafana --region us-west-2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Once logged in, add the AMP datasource to Grafana and import the Open Source GPU monitoring dashboard. You can then explore the metrics and visualize them using the Grafana dashboard, as shown in the screenshot below.</p>
<p><img decoding="async" loading="lazy" alt="Alt text" src="/data-on-eks/assets/images/gpu-dashboard-d829ebf9e69c5f26d76b49fbe2d2f8ce.png" width="3076" height="1882" class="img_ev3q"></p>
<div class="collapsibleContent_q3kw"><div class="header_QCEw"><h2><span>Cleanup</span></h2><span class="icon_PckA">ðŸ‘ˆ</span></div></div>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</div><div class="admonitionContent_BuS1"><p>To avoid unwanted charges to your AWS account, delete all the AWS resources created during this deployment</p></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/awslabs/data-on-eks/blob/main/website/docs/blueprints/ai-ml/emr-spark-rapids.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/data-on-eks/docs/blueprints/ai-ml/jupyterhub"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">JupyterHub on EKS</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/data-on-eks/docs/blueprints/ai-ml/trainium"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Trainium on EKS</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#emr-support-for-nvidia-rapids-accelerator-for-apache-spark">EMR support for NVIDIA RAPIDS Accelerator for Apache Spark</a></li><li><a class="table-of-contents__link toc-highlight" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#features">Features</a></li><li><a class="table-of-contents__link toc-highlight" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#prerequisites">Prerequisites</a></li><li><a class="table-of-contents__link toc-highlight" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#deploy">Deploy</a></li><li><a class="table-of-contents__link toc-highlight" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#verify-the-resources">Verify the resources</a></li><li><a class="table-of-contents__link toc-highlight" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#launching-xgboost-spark-job">Launching XGBoost Spark Job</a></li><li><a class="table-of-contents__link toc-highlight" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#step2-acquire-the-input-data-fannie-maes-single-family-loan-performance-data">Step2: Acquire the Input Data (Fannie Maeâ€™s Single-Family Loan Performance Data)</a></li><li><a class="table-of-contents__link toc-highlight" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#step3-run-the-emr-spark-xgboost-job">Step3: Run the EMR Spark XGBoost Job</a></li><li><a class="table-of-contents__link toc-highlight" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#step4-verify-the-job-results">Step4: Verify the Job results</a></li><li><a class="table-of-contents__link toc-highlight" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#ml-pipeline-for-fannie-mae-single-loan-performance-dataset">ML Pipeline for Fannie Mae Single Loan Performance Dataset</a></li><li><a class="table-of-contents__link toc-highlight" href="/data-on-eks/docs/blueprints/ai-ml/emr-spark-rapids#gpu-monitoring-with-dcgm-exporter-prometheus-and-grafana">GPU Monitoring with DCGM Exporter, Prometheus and Grafana</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Get Started</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/data-on-eks/docs/introduction/intro">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Get Involved</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/awslabs/data-on-eks" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Built with â¤ï¸ at AWS  <br> Â© 2024 Amazon.com, Inc. or its affiliates. All Rights Reserved</div></div></div></footer></div>
</body>
</html>