<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-blueprints/data-analytics/spark-operator-s3tables" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.8.1"><title data-rh=true>S3 Tables with Amazon EKS | Data on EKS</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:url content=https://awslabs.github.io/data-on-eks/docs/blueprints/data-analytics/spark-operator-s3tables><meta data-rh=true property=og:locale content=en><meta data-rh=true name=docusaurus_locale content=en><meta data-rh=true name=docsearch:language content=en><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="S3 Tables with Amazon EKS | Data on EKS"><meta data-rh=true name=description content=s3tables><meta data-rh=true property=og:description content=s3tables><link data-rh=true rel=icon href=/data-on-eks/img/header-icon.png><link data-rh=true rel=canonical href=https://awslabs.github.io/data-on-eks/docs/blueprints/data-analytics/spark-operator-s3tables><link data-rh=true rel=alternate href=https://awslabs.github.io/data-on-eks/docs/blueprints/data-analytics/spark-operator-s3tables hreflang=en><link data-rh=true rel=alternate href=https://awslabs.github.io/data-on-eks/docs/blueprints/data-analytics/spark-operator-s3tables hreflang=x-default><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://awslabs.github.io/data-on-eks/docs/category/data-analytics-on-eks","name":"Data Analytics on EKS","position":1},{"@type":"ListItem","item":"https://awslabs.github.io/data-on-eks/docs/blueprints/data-analytics/spark-operator-s3tables","name":"S3 Tables with EKS","position":2}]}</script><link rel=stylesheet href=/data-on-eks/assets/css/styles.03e7d5c7.css><script src=/data-on-eks/assets/js/runtime~main.68b68ee4.js defer></script><script src=/data-on-eks/assets/js/main.08422b12.js defer></script><body class=navigation-with-keyboard><svg xmlns=http://www.w3.org/2000/svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/data-on-eks/><div class=navbar__logo><img src=/data-on-eks/img/header-icon.png alt="DoEKS Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src=/data-on-eks/img/header-icon.png alt="DoEKS Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/data-on-eks/docs/blueprints/data-analytics>Blueprints</a><a class="navbar__item navbar__link" href=/data-on-eks/docs/bestpractices/intro>Best Practices</a><a class="navbar__item navbar__link" href=/data-on-eks/docs/benchmarks/emr-on-eks>Benchmarks</a><a class="navbar__item navbar__link" href=/data-on-eks/docs/resources/intro>Resources</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href=https://github.com/awslabs/data-on-eks target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill=currentColor d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"/></svg></button></div><div class=navbarSearchContainer_Bca1><div class=navbar__search><span aria-label="expand searchbar" role=button class=search-icon tabindex=0></span><input id=search_input_react type=search placeholder=Loading... aria-label=Search class="navbar__search-input search-bar" disabled></div></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/data-on-eks/docs/category/data-analytics-on-eks>Data Analytics on EKS</a><button aria-label="Collapse sidebar category 'Data Analytics on EKS'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/data-on-eks/docs/blueprints/data-analytics>Introduction</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/data-on-eks/docs/blueprints/data-analytics/spark-operator-yunikorn>Spark Operator with YuniKorn</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/data-on-eks/docs/blueprints/data-analytics/spark-eks-ipv6>Spark Operator on EKS with IPv6</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/data-on-eks/docs/blueprints/data-analytics/spark-operator-s3tables>S3 Tables with EKS</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/data-on-eks/docs/blueprints/data-analytics/observability-spark-on-eks>Spark Observability on EKS</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/data-on-eks/docs/blueprints/data-analytics/spark-operator-beam>Apache Beam on EKS</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/data-on-eks/docs/blueprints/data-analytics/datahub-on-eks>DataHub on EKS</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/data-on-eks/docs/blueprints/data-analytics/ray-data-processing>Ray Data on EKS</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/data-on-eks/docs/blueprints/data-analytics/superset-on-eks>Superset on EKS</a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/data-on-eks/docs/category/amazon-emr-on-eks>Amazon EMR on EKS</a><button aria-label="Expand sidebar category 'Amazon EMR on EKS'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/data-on-eks/docs/category/streaming-platforms-on-eks>Streaming Platforms on EKS</a><button aria-label="Expand sidebar category 'Streaming Platforms on EKS'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/data-on-eks/docs/category/job-schedulers-on-eks>Job Schedulers on EKS</a><button aria-label="Expand sidebar category 'Job Schedulers on EKS'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/data-on-eks/docs/category/distributed-databases-on-eks>Distributed Databases on EKS</a><button aria-label="Expand sidebar category 'Distributed Databases on EKS'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/data-on-eks/docs/blueprints/troubleshooting>Troubleshooting</a></ul></nav><button type=button title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width=20 height=20 aria-hidden=true class=collapseSidebarButtonIcon_kv0_><g fill=#7a7a7a><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"/><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"/></g></svg></button></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class=col><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/data-on-eks/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class=breadcrumbs__item><a class=breadcrumbs__link href=/data-on-eks/docs/category/data-analytics-on-eks><span>Data Analytics on EKS</span></a><li class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link>S3 Tables with EKS</span></ul></nav><div class="theme-doc-markdown markdown"><header><h1>S3 Tables with Amazon EKS</h1></header>
<p><img decoding=async loading=lazy alt=s3tables src=/data-on-eks/assets/images/s3tables-c83dded2e8796851fe97ed89d1abc8e8.png width=1330 height=694 class=img_ev3q></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=what-is-s3-tables>What is S3 Tables?<a href=#what-is-s3-tables class=hash-link aria-label="Direct link to What is S3 Tables?" title="Direct link to What is S3 Tables?">‚Äã</a></h2>
<p>Amazon S3 Tables is a fully managed tabular data store purpose-built to optimize performance, simplify security, and provide cost-efficient storage for large-scale analytics workloads. It integrates directly with services like Amazon EMR, Amazon Athena, Amazon Redshift, AWS Glue, and AWS Lake Formation, offering a seamless experience for running analytics and machine learning workloads.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=why-run-s3-tables-on-amazon-eks>Why Run S3 Tables on Amazon EKS?<a href=#why-run-s3-tables-on-amazon-eks class=hash-link aria-label="Direct link to Why Run S3 Tables on Amazon EKS?" title="Direct link to Why Run S3 Tables on Amazon EKS?">‚Äã</a></h2>
<p>For users who have adopted Amazon EKS for Spark workloads and are using table formats like Iceberg, leveraging S3 Tables offers advantages in performance, cost-efficiency, and security controls. This integration allows organizations to combine Kubernetes-native features with the capabilities of S3 Tables, potentially improving query performance and resource scaling within their existing environment. By following the steps detailed in this document, users can seamlessly integrate S3 Tables into their EKS setup, providing a flexible and complementary solution for analytics workloads.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=how-s3-tables-differ-from-iceberg-table-format>How S3 Tables Differ from Iceberg Table Format<a href=#how-s3-tables-differ-from-iceberg-table-format class=hash-link aria-label="Direct link to How S3 Tables Differ from Iceberg Table Format" title="Direct link to How S3 Tables Differ from Iceberg Table Format">‚Äã</a></h2>
<p>While S3 Tables use Apache Iceberg as an underlying implementation, they offer enhanced capabilities specifically designed for AWS customers:</p>
<ul>
<li>
<p><strong>üõ†Ô∏è Automatic Compaction</strong>: S3 Tables implements automatic compaction, which intelligently optimizes data storage in the background by combining smaller files into larger, more efficient ones. This process reduces storage costs, improves query speed, and operates continuously without manual intervention.</p>
</li>
<li>
<p>üîÑ <strong>Table Maintenance</strong>: It offers critical maintenance tasks like snapshot management and unreferenced file removal. This continuous optimization ensures that tables remain performant and cost-effective without manual intervention, reducing operational overhead and allowing teams to focus on data insights.</p>
</li>
<li>
<p>‚ùÑÔ∏è <strong>Apache Iceberg Support</strong>: Offers built-in support for Apache Iceberg, which simplifies managing data lakes at scale while improving query performance and reducing costs. Consider using S3 Tables for your data lake if you want to experience the following results.</p>
</li>
<li>
<p>üîí <strong>Simplified Security</strong>: S3 Tables treat your tables as AWS resources, enabling fine-grained AWS Identity and Access Management (IAM) permissions at the table level. This simplifies data governance, enhances security, and makes access control more intuitive and manageable with your familiar AWS services.</p>
</li>
<li>
<p>‚ö° <strong>Enhanced Performance</strong>: Amazon S3 Tables introduce a new type of bucket, purpose-built for storing Apache Iceberg tables. Table buckets deliver up to 3x faster query performance and up to 10x higher transactions per second compared to storing Iceberg tables in general-purpose S3 buckets. This performance enhancement supports high-frequency updates, real-time ingestion, and more demanding workloads, ensuring scalability and responsiveness as data volumes grow.</p>
</li>
<li>
<p>üõ†Ô∏è <strong>Integration with AWS Services</strong>: S3 Tables are tightly integrated with AWS analytics services such as Athena, Redshift, EMR, and Glue, providing native support for analytics workloads.</p>
</li>
</ul>
<div class=collapsibleContent_q3kw><div class=header_QCEw><h2><span>Deploying the Solution</span></h2><span class=icon_PckA>üëà</span></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=execute-sample-spark-job>Execute Sample Spark job<a href=#execute-sample-spark-job class=hash-link aria-label="Direct link to Execute Sample Spark job" title="Direct link to Execute Sample Spark job">‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=step-1-create-the-s3-tables-compatible-apache-spark-docker-image>Step 1: Create the S3 Tables compatible Apache Spark Docker Image<a href=#step-1-create-the-s3-tables-compatible-apache-spark-docker-image class=hash-link aria-label="Direct link to Step 1: Create the S3 Tables compatible Apache Spark Docker Image" title="Direct link to Step 1: Create the S3 Tables compatible Apache Spark Docker Image">‚Äã</a></h3>
<p>Create a Docker image with necessary jars for S3 tables communication.</p>
<ul>
<li>Review the sample <a href=https://github.com/awslabs/data-on-eks/blob/main/analytics/terraform/spark-k8s-operator/examples/s3-tables/Dockerfile-S3Table target=_blank rel="noopener noreferrer">Dockerfile</a></li>
<li>Note the <a href=https://github.com/awslabs/data-on-eks/blob/e3f1a6b08d719fc69f61d18b57cd5ad09cb01bd5/analytics/terraform/spark-k8s-operator/examples/s3-tables/Dockerfile-S3Table#L43C1-L48C1 target=_blank rel="noopener noreferrer">key jar files</a> for S3 Tables interaction, including Iceberg, AWS SDK bundle, and S3 Tables Catalog for Iceberg runtime</li>
<li>Customize the Dockerfile as needed for your environment</li>
<li>Build the Docker image and push the image to your preferred container registry</li>
</ul>
<p>We have created a docker image and published in ECR for the demo purpose only.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=step-2-create-test-data-for-the-job>Step 2: Create Test Data for the job<a href=#step-2-create-test-data-for-the-job class=hash-link aria-label="Direct link to Step 2: Create Test Data for the job" title="Direct link to Step 2: Create Test Data for the job">‚Äã</a></h3>
<p>Navigate to the example directory and generate sample employee data for Spark job input using this <a href=https://github.com/awslabs/data-on-eks/blob/main/analytics/terraform/spark-k8s-operator/examples/s3-tables/input-data-gen.sh target=_blank rel="noopener noreferrer">shell</a> script.</p>
<div class="language-sh codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-sh codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token builtin class-name">cd</span><span class="token plain"> analytics/terraform/spark-k8s-operator/examples/s3-tables</span><br></span><span class=token-line style=color:#393A34><span class="token plain">./input-data-gen.sh</span><br></span></code></pre></div></div>
<p>This script will create a file named <code>employee_data.csv</code> in your current directory. By default, it generates 100 records.</p>
<p>Note: If you need to adjust the number of records, you can modify the input-data-gen.sh script. Look for the loop that generates the data and change the iteration count as needed.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=step-3-upload-test-input-data-to-amazon-s3-bucket>Step 3: Upload Test Input data to Amazon S3 Bucket<a href=#step-3-upload-test-input-data-to-amazon-s3-bucket class=hash-link aria-label="Direct link to Step 3: Upload Test Input data to Amazon S3 Bucket" title="Direct link to Step 3: Upload Test Input data to Amazon S3 Bucket">‚Äã</a></h3>
<p>Replace <code>&lt;YOUR_S3_BUCKET></code> with the name of the S3 bucket created by your blueprint and run the below command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">aws s3 </span><span class="token function" style=color:#d73a49>cp</span><span class="token plain"> employee_data.csv s3://</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">S3_BUCKET</span><span class="token operator" style=color:#393A34>></span><span class="token plain">/s3table-example/input/</span><br></span></code></pre></div></div>
<p>This command will upload the CSV file to your S3 bucket. The Spark job will later reference this path to read the input data. Ensure you have the necessary permissions to write to this bucket before executing the command.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=step-4-upload-pyspark-script-to-s3-bucket>Step 4: Upload PySpark Script to S3 Bucket<a href=#step-4-upload-pyspark-script-to-s3-bucket class=hash-link aria-label="Direct link to Step 4: Upload PySpark Script to S3 Bucket" title="Direct link to Step 4: Upload PySpark Script to S3 Bucket">‚Äã</a></h3>
<p>The following script is the snippet of the <a href=https://github.com/awslabs/data-on-eks/blob/main/analytics/terraform/spark-k8s-operator/examples/s3-tables/s3table-iceberg-pyspark.py target=_blank rel="noopener noreferrer">Spark job</a> where you can see the Spark config required to work with S3 Tables.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-python codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token keyword" style=color:#00009f>def</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>main</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">args</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token keyword" style=color:#00009f>if</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">args</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>!=</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>3</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">error</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"Usage: spark-etl [input-csv-path] [s3table-arn]"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        sys</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">exit</span><span class="token punctuation" style=color:#393A34>(</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic># Input parameters</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    input_csv_path </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> args</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>1</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic># Path to the input CSV file</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    s3table_arn </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> args</span><span class="token punctuation" style=color:#393A34>[</span><span class="token number" style=color:#36acaa>2</span><span class="token punctuation" style=color:#393A34>]</span><span class="token plain">       </span><span class="token comment" style=color:#999988;font-style:italic># s3table arn</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic># Initialize Spark session</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"Initializing Spark Session"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    spark </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>(</span><span class="token plain">SparkSession</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">builder</span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">appName</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string-interpolation string" style=color:#e3116c>f"</span><span class="token string-interpolation interpolation punctuation" style=color:#393A34>{</span><span class="token string-interpolation interpolation">AppName</span><span class="token string-interpolation interpolation punctuation" style=color:#393A34>}</span><span class="token string-interpolation string" style=color:#e3116c>_</span><span class="token string-interpolation interpolation punctuation" style=color:#393A34>{</span><span class="token string-interpolation interpolation">dt_string</span><span class="token string-interpolation interpolation punctuation" style=color:#393A34>}</span><span class="token string-interpolation string" style=color:#e3116c>"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">config</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"spark.sql.extensions"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"org.apache.iceberg.spark.extensions.IcebergSparkSessionExtensions"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">config</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"spark.sql.catalog.s3tablesbucket"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"org.apache.iceberg.spark.SparkCatalog"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">config</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"spark.sql.catalog.s3tablesbucket.catalog-impl"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"software.amazon.s3tables.iceberg.S3TablesCatalog"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">config</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"spark.sql.catalog.s3tablesbucket.warehouse"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> s3table_arn</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">config</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>'spark.hadoop.fs.s3.impl'</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"org.apache.hadoop.fs.s3a.S3AFileSystem"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">config</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"spark.sql.defaultCatalog"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"s3tablesbucket"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">             </span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">getOrCreate</span><span class="token punctuation" style=color:#393A34>(</span><span class="token punctuation" style=color:#393A34>)</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    spark</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">sparkContext</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">setLogLevel</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"INFO"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    logger</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain">info</span><span class="token punctuation" style=color:#393A34>(</span><span class="token string" style=color:#e3116c>"Spark session initialized successfully"</span><span class="token punctuation" style=color:#393A34>)</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    namespace </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"doeks_namespace"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    table_name </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"employee_s3_table"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    full_table_name </span><span class="token operator" style=color:#393A34>=</span><span class="token plain"> </span><span class="token string-interpolation string" style=color:#e3116c>f"s3tablesbucket.</span><span class="token string-interpolation interpolation punctuation" style=color:#393A34>{</span><span class="token string-interpolation interpolation">namespace</span><span class="token string-interpolation interpolation punctuation" style=color:#393A34>}</span><span class="token string-interpolation string" style=color:#e3116c>.</span><span class="token string-interpolation interpolation punctuation" style=color:#393A34>{</span><span class="token string-interpolation interpolation">table_name</span><span class="token string-interpolation interpolation punctuation" style=color:#393A34>}</span><span class="token string-interpolation string" style=color:#e3116c>"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>.</span><span class="token punctuation" style=color:#393A34>.</span><span class="token punctuation" style=color:#393A34>.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span></code></pre></div></div>
<p>Replace <code>S3_BUCKET</code> with the name of the S3 bucket created by your blueprint and run the below command to upload sample <a href=https://github.com/awslabs/data-on-eks/blob/main/analytics/terraform/spark-k8s-operator/examples/s3-tables/s3table-iceberg-pyspark.py target=_blank rel="noopener noreferrer">Spark job</a> to S3 buckets.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">aws s3 </span><span class="token function" style=color:#d73a49>cp</span><span class="token plain"> s3table-iceberg-pyspark.py s3://</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">S3_BUCKET</span><span class="token operator" style=color:#393A34>></span><span class="token plain">/s3table-example/scripts/</span><br></span></code></pre></div></div>
<p>Navigate to example directory and submit the Spark job.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=step-5-create-amazon-s3-table-bucket>Step 5: Create Amazon S3 table bucket<a href=#step-5-create-amazon-s3-table-bucket class=hash-link aria-label="Direct link to Step 5: Create Amazon S3 table bucket" title="Direct link to Step 5: Create Amazon S3 table bucket">‚Äã</a></h3>
<p>This is the main step where you will create an S3 table bucket that will be used for S3 Tables, which your PySpark job will access later.</p>
<p>Replace <code>&lt;S3TABLE_BUCKET_NAME></code> with your desired bucket name. Replace <code>&lt;REGION></code> with your AWS region.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">aws s3tables create-table-bucket </span><span class="token punctuation" style=color:#393A34>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token parameter variable" style=color:#36acaa>--region</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"&lt;REGION>"</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token parameter variable" style=color:#36acaa>--name</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"&lt;S3TABLE_BUCKET_NAME>"</span><br></span></code></pre></div></div>
<p>Make note of the S3TABLE BUCKET ARN generated by this command. Verify the S3 table bucket ARN from AWS Console.</p>
<p><img decoding=async loading=lazy alt="alt text" src=/data-on-eks/assets/images/s3table_bucket-d51564e96fc064ad5d9101afbb760c05.png width=3054 height=1100 class=img_ev3q></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=step-6-update-spark-operator-yaml-file>Step 6: Update Spark Operator YAML File<a href=#step-6-update-spark-operator-yaml-file class=hash-link aria-label="Direct link to Step 6: Update Spark Operator YAML File" title="Direct link to Step 6: Update Spark Operator YAML File">‚Äã</a></h3>
<p>Update the Spark Operator YAML file as below:</p>
<ul>
<li>Open <a href=https://github.com/awslabs/data-on-eks/blob/main/analytics/terraform/spark-k8s-operator/examples/s3-tables/s3table-spark-operator.yaml target=_blank rel="noopener noreferrer">s3table-spark-operator.yaml</a> file in your preferred text editor.</li>
<li>Replace <code>&lt;S3_BUCKET></code> with your S3 bucket created by this blueprint(Check Terraform outputs). S3 bucket is the place where you copied the test data and sample spark job in the above steps.</li>
<li>REPLACE <code>&lt;S3TABLE_BUCKET_ARN></code> with your S3 table bucket ARN captured in the previous step.</li>
</ul>
<p>You can see the snippet of Spark Operator Job config below.</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token punctuation" style=color:#393A34>---</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>apiVersion</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"sparkoperator.k8s.io/v1beta2"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>kind</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> SparkApplication</span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>metadata</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>name</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"s3table-example"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>namespace</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> spark</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">team</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">a</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>labels</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>app</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"s3table-example"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>applicationId</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"s3table-example-nvme"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>spec</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>type</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> Python</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>sparkVersion</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"3.5.3"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>mode</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> cluster</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic># CAUTION: Unsupported test image</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic># This image is created solely for testing and reference purposes.</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic># Before use, please:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic># 1. Review the Dockerfile used to create this image</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic># 2. Create your own image that meets your organization's security requirements</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>image</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"public.ecr.aws/data-on-eks/spark:3.5.3-scala2.12-java17-python3-ubuntu-s3table0.1.3-iceberg1.6.1"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>imagePullPolicy</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> IfNotPresent</span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>mainApplicationFile</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"s3a://&lt;S3_BUCKET>/s3table-example/scripts/s3table-iceberg-pyspark.py"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>arguments</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"s3a://&lt;S3_BUCKET>/s3table-example/input/"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"&lt;S3TABLE_BUCKET_ARN>"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>sparkConf</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.app.name"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"s3table-example"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.kubernetes.driver.pod.name"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"s3table-example"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.kubernetes.executor.podNamePrefix"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"s3table-example"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.local.dir"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"/data"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.speculation"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"false"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.network.timeout"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"2400"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.hadoop.fs.s3a.connection.timeout"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"1200000"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.hadoop.fs.s3a.path.style.access"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"true"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.hadoop.fs.s3a.connection.maximum"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"200"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.hadoop.fs.s3a.fast.upload"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"true"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.hadoop.fs.s3a.readahead.range"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"256K"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.hadoop.fs.s3a.input.fadvise"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"random"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.hadoop.fs.s3a.aws.credentials.provider.mapping"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"com.amazonaws.auth.WebIdentityTokenCredentialsProvider=software.amazon.awssdk.auth.credentials.WebIdentityTokenFileCredentialsProvider"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.hadoop.fs.s3a.aws.credentials.provider"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"software.amazon.awssdk.auth.credentials.WebIdentityTokenFileCredentialsProvider"</span><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic># AWS SDK V2 https://hadoop.apache.org/docs/stable/hadoop-aws/tools/hadoop-aws/aws_sdk_upgrade.html</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>...</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=step-7-execute-spark-job>Step 7: Execute Spark Job<a href=#step-7-execute-spark-job class=hash-link aria-label="Direct link to Step 7: Execute Spark Job" title="Direct link to Step 7: Execute Spark Job">‚Äã</a></h3>
<p>Apply the updated YAML configuration file to your Kubernetes cluster to submit and execute the Spark job:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token variable" style=color:#36acaa>${DOEKS_HOME}</span><span class="token plain">/analytics/terraform/spark-k8s-operator/examples/s3-tables</span><br></span><span class=token-line style=color:#393A34><span class="token plain">kubectl apply </span><span class="token parameter variable" style=color:#36acaa>-f</span><span class="token plain"> s3table-spark-operator.yaml</span><br></span></code></pre></div></div>
<p>This will schedule the Spark job on the EKS cluster. Spark Operator handles submitting the job to the Kubernetes API Server.</p>
<p>Kubernetes will schedule the Spark driver and executor pods to run on separate worker nodes. Karpenter will automatically provision new nodes if required, based on the nodepool configuration in the Terraform scripts.</p>
<p>Monitor the logs of the Spark driver pod to track job progress. The pods default to <code>c5d</code> instances, but you can modify the YAML and Karpenter nodepool to use different EC2 instance types if needed.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=step-8-verify-the-spark-driver-log-for-the-output>Step 8: Verify the Spark Driver log for the output<a href=#step-8-verify-the-spark-driver-log-for-the-output class=hash-link aria-label="Direct link to Step 8: Verify the Spark Driver log for the output" title="Direct link to Step 8: Verify the Spark Driver log for the output">‚Äã</a></h3>
<p>List the pods running under the spark-team-a namespace:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">kubectl get pods </span><span class="token parameter variable" style=color:#36acaa>-n</span><span class="token plain"> spark-team-a</span><br></span></code></pre></div></div>
<p>Verify the driver logs to see the full output of the Spark job. The job reads the CSV data from the S3 bucket and writes it back to the S3 Tables bucket using the Iceberg format. It also counts the number of records processed and displays the first 10 records:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">kubectl logs </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">spark-driver-pod-name</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>-n</span><span class="token plain"> spark-team-a</span><br></span></code></pre></div></div>
<p>You should see the Spark driver pod transition to a <code>Succeeded</code> state when the job completes successfully and the log should show output like below.</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">...</span><br></span><span class=token-line style=color:#393A34><span class="token plain">[2025-01-07 22:07:44,185] INFO @ line 59: Previewing employee data schema</span><br></span><span class=token-line style=color:#393A34><span class="token plain">root</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> |-- id: integer (nullable = true)</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> |-- name: string (nullable = true)</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> |-- level: string (nullable = true)</span><br></span><span class=token-line style=color:#393A34><span class="token plain"> |-- salary: double (nullable = true)</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">....</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">25/01/07 22:07:44 INFO CodeGenerator: Code generated in 10.594982 ms</span><br></span><span class=token-line style=color:#393A34><span class="token plain">+---+-----------+------+--------+</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|id |name       |level |salary  |</span><br></span><span class=token-line style=color:#393A34><span class="token plain">+---+-----------+------+--------+</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|1  |Employee_1 |Mid   |134000.0|</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|2  |Employee_2 |Senior|162500.0|</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|3  |Employee_3 |Senior|174500.0|</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|4  |Employee_4 |Exec  |69500.0 |</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|5  |Employee_5 |Senior|54500.0 |</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|6  |Employee_6 |Mid   |164000.0|</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|7  |Employee_7 |Junior|119000.0|</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|8  |Employee_8 |Senior|54500.0 |</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|9  |Employee_9 |Senior|57500.0 |</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|10 |Employee_10|Mid   |152000.0|</span><br></span><span class=token-line style=color:#393A34><span class="token plain">+---+-----------+------+--------+</span><br></span><span class=token-line style=color:#393A34><span class="token plain">only showing top 10 rows</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">....</span><br></span></code></pre></div></div>
<p>You should see a new Table and Namespace once the job is successful as shown in the image below.</p>
<p><img decoding=async loading=lazy alt="alt text" src=/data-on-eks/assets/images/s3tables-2-01dd11532674f79bc394542c2e386a22.png width=3270 height=896 class=img_ev3q></p>
<p>The following commands will show the additional information on the S3 Tables.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=verify-the-s3table-using-s3table-api>Verify the S3Table using S3Table API<a href=#verify-the-s3table-using-s3table-api class=hash-link aria-label="Direct link to Verify the S3Table using S3Table API" title="Direct link to Verify the S3Table using S3Table API">‚Äã</a></h3>
<p>Use the S3Table API to confirm the table was created successfully. Just replace the <code>&lt;ACCOUNT_ID></code> and run the command.</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">aws s3tables get-table --table-bucket-arn arn:aws:s3tables:</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">REGION</span><span class="token operator" style=color:#393A34>></span><span class="token plain">:</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">ACCOUNT_ID</span><span class="token operator" style=color:#393A34>></span><span class="token plain">:bucket/doeks-spark-on-eks-s3table </span><span class="token punctuation" style=color:#393A34>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token parameter variable" style=color:#36acaa>--namespace</span><span class="token plain"> doeks_namespace </span><span class="token punctuation" style=color:#393A34>\</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token parameter variable" style=color:#36acaa>--name</span><span class="token plain"> employee_s3_table</span><br></span></code></pre></div></div>
<p>Output looks like below:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">Output looks like below.</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain">{</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    "name": "employee_s3_table",</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    "type": "customer",</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    "tableARN": "arn:aws:s3tables:us-west-2:&lt;ACCOUNT_ID>:bucket/doeks-spark-on-eks-s3table/table/55511111-7a03-4513-b921-e372b0030daf",</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    "namespace": [</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        "doeks_namespace"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    ],</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    "versionToken": "aafc39ddd462690d2a0c",</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    "metadataLocation": "s3://55511111-7a03-4513-asdfsafdsfdsf--table-s3/metadata/00004-62cc4be3-59b5-4647-a78d-1cdf69ec5ed8.metadata.json",</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    "warehouseLocation": "s3://55511111-7a03-4513-asdfsafdsfdsf--table-s3",</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    "createdAt": "2025-01-07T22:14:48.689581+00:00",</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    "createdBy": "&lt;ACCOUNT_ID>",</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    "modifiedAt": "2025-01-09T00:06:09.222917+00:00",</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    "ownerAccountId": "&lt;ACCOUNT_ID>",</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    "format": "ICEBERG"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=monitor-the-table-maintenance-job-status>Monitor the table maintenance job status:<a href=#monitor-the-table-maintenance-job-status class=hash-link aria-label="Direct link to Monitor the table maintenance job status:" title="Direct link to Monitor the table maintenance job status:">‚Äã</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">aws s3tables get-table-maintenance-job-status --table-bucket-arn arn:aws:s3tables:us-west-2:"</span><span class="token punctuation" style=color:#393A34>\</span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">ACCOUNT_ID</span><span class="token operator" style=color:#393A34>></span><span class="token plain">:bucket/doeks-spark-on-eks-s3table </span><span class="token parameter variable" style=color:#36acaa>--namespace</span><span class="token plain"> doeks_namespace </span><span class="token parameter variable" style=color:#36acaa>--name</span><span class="token plain"> employee_s3_table</span><br></span></code></pre></div></div>
<p>This command provides information about Iceberg compaction, snapshot management, and unreferenced file removal processes.</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-json codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token property" style=color:#36acaa>"tableARN"</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"arn:aws:s3tables:us-west-2:&lt;ACCOUNT_ID>:bucket/doeks-spark-on-eks-s3table/table/55511111-7a03-4513-b921-e372b0030daf"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token property" style=color:#36acaa>"status"</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token property" style=color:#36acaa>"icebergCompaction"</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token property" style=color:#36acaa>"status"</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"Successful"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token property" style=color:#36acaa>"lastRunTimestamp"</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"2025-01-08T01:18:08.857000+00:00"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token property" style=color:#36acaa>"icebergSnapshotManagement"</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token property" style=color:#36acaa>"status"</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"Successful"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token property" style=color:#36acaa>"lastRunTimestamp"</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"2025-01-08T22:17:08.811000+00:00"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token property" style=color:#36acaa>"icebergUnreferencedFileRemoval"</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token punctuation" style=color:#393A34>{</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token property" style=color:#36acaa>"status"</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"Successful"</span><span class="token punctuation" style=color:#393A34>,</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">            </span><span class="token property" style=color:#36acaa>"lastRunTimestamp"</span><span class="token operator" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"2025-01-08T22:17:10.377000+00:00"</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token punctuation" style=color:#393A34>}</span><span class="token plain"></span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 14 16"><path fill-rule=evenodd d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"/></svg></span>info</div><div class=admonitionContent_BuS1><p>To work with S3 Tables on EKS, both Node-level policies and Pod-level policies are required.<ol>
<li>
<p><strong>Node-level policies</strong>: These are added to the Karpenter Node IAM role. For reference, you can view the permissions configuration in the <a href=https://github.com/awslabs/data-on-eks/blob/e3f1a6b08d719fc69f61d18b57cd5ad09cb01bd5/analytics/terraform/spark-k8s-operator/addons.tf#L649C1-L687C5 target=_blank rel="noopener noreferrer">addons.tf</a> file.</p>
</li>
<li>
<p><strong>Pod-level policies</strong>: These are necessary for creating namespaces, managing tables, and reading/writing data to the tables. <a href=https://github.com/awslabs/data-on-eks/blob/e3f1a6b08d719fc69f61d18b57cd5ad09cb01bd5/analytics/terraform/spark-k8s-operator/main.tf#L98C1-L156C2 target=_blank rel="noopener noreferrer">https://github.com/awslabs/data-on-eks/blob/e3f1a6b08d719fc69f61d18b57cd5ad09cb01bd5/analytics/terraform/spark-k8s-operator/main.tf#L98C1-L156C2</a> are granted through IAM Roles for Service Accounts (IRSA) for the <code>spark-team-a</code> namespace. This ensures that the Spark job pods have the required access to perform operations on S3 Tables.</p>
</li>
</ol><p>By configuring these permissions appropriately, you can ensure seamless execution of Spark jobs and secure access to resources.<p>Please note that these policies can further be adjusted and make it more granular based on your security requirements.</div></div>
<div class=collapsibleContent_q3kw><div class=header_QCEw><h2><span>Using S3 Tables with JupyterLab </span></h2><span class=icon_PckA>üëà</span></div></div>
<div class=collapsibleContent_q3kw><div class=header_QCEw><h2><span>Cleanup</span></h2><span class=icon_PckA>üëà</span></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/awslabs/data-on-eks/blob/main/website/docs/blueprints/data-analytics/spark-operator-s3tables.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/data-on-eks/docs/blueprints/data-analytics/spark-eks-ipv6><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Spark Operator on EKS with IPv6</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/data-on-eks/docs/blueprints/data-analytics/observability-spark-on-eks><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Spark Observability on EKS</div></a></nav></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Get Started</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/data-on-eks/docs/introduction/intro>Docs</a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Get Involved</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://github.com/awslabs/data-on-eks target=_blank rel="noopener noreferrer" class=footer__link-item>Github<svg width=13.5 height=13.5 aria-hidden=true class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Built with ‚ù§Ô∏è at AWS  <br> ¬© 2025 Amazon.com, Inc. or its affiliates. All Rights Reserved</div></div></div></footer><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "7fbc7ab02fae4767b1af2588eba0cdf2"}'></script></div>