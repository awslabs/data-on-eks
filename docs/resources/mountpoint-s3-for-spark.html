<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-resources/mountpoint-s3-for-spark" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.5.2">
<title data-rh="true">Mountpoint-S3 for Spark Workloads | Data on EKS</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://awslabs.github.io/data-on-eks/docs/resources/mountpoint-s3-for-spark"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Mountpoint-S3 for Spark Workloads | Data on EKS"><meta data-rh="true" name="description" content="When working with the SparkApplication Custom Resource Definition (CRD) managed by the SparkOperator, handling multiple dependency JAR files can become a significant challenge. Traditionally, these JAR files are bundled within the container image, leading to several inefficiencies:"><meta data-rh="true" property="og:description" content="When working with the SparkApplication Custom Resource Definition (CRD) managed by the SparkOperator, handling multiple dependency JAR files can become a significant challenge. Traditionally, these JAR files are bundled within the container image, leading to several inefficiencies:"><link data-rh="true" rel="icon" href="/data-on-eks/img/header-icon.png"><link data-rh="true" rel="canonical" href="https://awslabs.github.io/data-on-eks/docs/resources/mountpoint-s3-for-spark"><link data-rh="true" rel="alternate" href="https://awslabs.github.io/data-on-eks/docs/resources/mountpoint-s3-for-spark" hreflang="en"><link data-rh="true" rel="alternate" href="https://awslabs.github.io/data-on-eks/docs/resources/mountpoint-s3-for-spark" hreflang="x-default"><link rel="stylesheet" href="/data-on-eks/assets/css/styles.74de95c8.css">
<script src="/data-on-eks/assets/js/runtime~main.cf694a6c.js" defer="defer"></script>
<script src="/data-on-eks/assets/js/main.f1d7b660.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/data-on-eks/"><div class="navbar__logo"><img src="/data-on-eks/img/header-icon.png" alt="DoEKS Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/data-on-eks/img/header-icon.png" alt="DoEKS Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a><a class="navbar__item navbar__link" href="/data-on-eks/docs/introduction/intro">Introduction</a><a class="navbar__item navbar__link" href="/data-on-eks/docs/gen-ai">Gen AI</a><a class="navbar__item navbar__link" href="/data-on-eks/docs/blueprints/amazon-emr-on-eks">Blueprints</a><a class="navbar__item navbar__link" href="/data-on-eks/docs/bestpractices/intro">Best Practices</a><a class="navbar__item navbar__link" href="/data-on-eks/docs/benchmarks/emr-on-eks">Benchmarks</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/data-on-eks/docs/resources/intro">Resources</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/awslabs/data-on-eks" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/data-on-eks/docs/resources/intro">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/data-on-eks/docs/resources/mountpoint-s3">Mounpoint-S3 on EKS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/data-on-eks/docs/resources/mountpoint-s3-for-spark">Mounpoint-S3 for Spark Workloads</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/data-on-eks/docs/resources/binpacking-custom-scheduler-eks">Bin packing for Amazon EKS</a></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/data-on-eks/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Mounpoint-S3 for Spark Workloads</span><meta itemprop="position" content="1"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Mountpoint-S3 for Spark Workloads</h1></header>
<p>When working with the <a href="https://www.kubeflow.org/docs/components/spark-operator/user-guide/using-sparkapplication/" target="_blank" rel="noopener noreferrer">SparkApplication</a> Custom Resource Definition (CRD) managed by the <a href="https://github.com/kubeflow/spark-operator" target="_blank" rel="noopener noreferrer">SparkOperator</a>, handling multiple dependency JAR files can become a significant challenge. Traditionally, these JAR files are bundled within the container image, leading to several inefficiencies:</p>
<ul>
<li><strong>Increased Build Time:</strong> Downloading and adding JAR files during the build process significantly inflates the build time of the container image.</li>
<li><strong>Larger Image Size:</strong> Including JAR files directly in the container image increases its size, resulting in longer download times when pulling the image to execute jobs.</li>
<li><strong>Frequent Rebuilds:</strong> Any updates or additions to the dependency JAR files necessitate rebuilding and redeploying the container image, further increasing operational overhead.</li>
</ul>
<p><a href="https://aws.amazon.com/s3/features/mountpoint/" target="_blank" rel="noopener noreferrer">Mountpoint for Amazon S3</a> offers an effective solution to these challenges. As an open-source file client, Mountpoint-S3 allows you to mount an S3 bucket on your compute instance, making it accessible as a local virtual file system. It automatically translates local file system API calls into REST API calls on S3 objects, providing seamless integration with Spark jobs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-mountpoint-s3">What is Mountpoint-S3?<a href="#what-is-mountpoint-s3" class="hash-link" aria-label="Direct link to What is Mountpoint-S3?" title="Direct link to What is Mountpoint-S3?">â€‹</a></h2>
<p><a href="https://github.com/awslabs/mountpoint-s3" target="_blank" rel="noopener noreferrer">Mountpoint-S3</a> is an open-source file client developed by AWS that translates file operations into S3 API calls, enabling your applications to interact with <a href="https://aws.amazon.com/s3/" target="_blank" rel="noopener noreferrer">Amazon S3</a> buckets as if they were local disks. <a href="https://aws.amazon.com/s3/features/mountpoint/" target="_blank" rel="noopener noreferrer">Mountpoint for Amazon S3</a> is optimized for applications that need high read throughput to large objects, potentially from many clients at once, and to write new objects sequentially from a single client at a time. It offers significant performance gains compared to traditional S3 access methods, making it ideal for data-intensive workloads or AI/ML training.</p>
<p><a href="https://aws.amazon.com/s3/features/mountpoint/" target="_blank" rel="noopener noreferrer">Mountpoint for Amazon S3</a> is optimized for high-throughput performance, largely due to its foundation on the <a href="https://docs.aws.amazon.com/sdkref/latest/guide/common-runtime.html" target="_blank" rel="noopener noreferrer">AWS Common Runtime (CRT)</a> library. The CRT library is a collection of libraries and modules designed to deliver high performance and low resource usage, specifically tailored for AWS services. Key features of the CRT library that enable high-throughput performance include:</p>
<ul>
<li><strong>Efficient I/O Management:</strong> The CRT library is optimized for non-blocking I/O operations, reducing latency and maximizing the utilization of network bandwidth.</li>
<li><strong>Lightweight and Modular Design:</strong> The library is designed to be lightweight, with minimal overhead, allowing it to perform efficiently even under high load. Its modular architecture ensures that only the necessary components are loaded, further enhancing performance.</li>
<li><strong>Advanced Memory Management:</strong> CRT employs advanced memory management techniques to minimize memory usage and reduce garbage collection overhead, leading to faster data processing and reduced latency.</li>
<li><strong>Optimized Network Protocols:</strong> The CRT library includes optimized implementations of network protocols, such as HTTP/2, that are specifically tuned for AWS environments. These optimizations ensure rapid data transfer between S3 and your compute instances, which is critical for large-scale Spark workloads.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-mountpoint-s3-with-eks">Using Mountpoint-S3 with EKS<a href="#using-mountpoint-s3-with-eks" class="hash-link" aria-label="Direct link to Using Mountpoint-S3 with EKS" title="Direct link to Using Mountpoint-S3 with EKS">â€‹</a></h2>
<p>For Spark workloads, we&#x27;ll specifically focus on <strong>loading external JARs located in S3 for Spark Applications</strong>. Weâ€™ll examine two primary deployment strategies for Mountpoint-S3;</p>
<ol>
<li>Leveraging the <a href="https://docs.aws.amazon.com/eks/latest/userguide/ebs-csi.html" target="_blank" rel="noopener noreferrer">EKS Managed Addon CSI driver</a> with Persistent Volumes (PV) and Persistent Volume Claims (PVC)</li>
<li>Deploying Mountpoint-S3 at the Node level using either <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html" target="_blank" rel="noopener noreferrer">USERDATA</a> scripts or DaemonSets.</li>
</ol>
<p>The first approach is considered mounting at a <em>Pod</em> level because the PV created is available to individual pods. The second Approach is considered mounting at a <em>Node</em> level because the S3 is mounted on the host Node itself. Each approach is discussed in detail below, highlighting their respective strengths and considerations to help you determine the most effective solution for your specific use case.</p>
<table><thead><tr><th style="text-align:center">Metric</th><th style="text-align:left">Pod Level</th><th style="text-align:left">Node Level</th></tr></thead><tbody><tr><td style="text-align:center">Access Control</td><td style="text-align:left">Provides fine-grained access control through service roles and RBAC, limiting PVC access to specific Pods. This is not possible with host-level mounts, where the mounted S3 bucket is accessible to all Pods on the Node.</td><td style="text-align:left">Simplifies configuration but lacks the granular control offered by Pod-level mounting.</td></tr><tr><td style="text-align:center">Scalabbility and Overhead</td><td style="text-align:left">Involves managing individual PVCs, which can increase overhead in large-scale environments.</td><td style="text-align:left">Reduces configuration complexity but provides less isolation between Pods.</td></tr><tr><td style="text-align:center">Performance Considerations</td><td style="text-align:left">Offers predictable and isolated performance for individual Pods.</td><td style="text-align:left">May lead to contention if multiple Pods on the same Node access the same S3 bucket.</td></tr><tr><td style="text-align:center">Flexibility and Use Cases</td><td style="text-align:left">Best suited for use cases where different Pods require access to different datasets or where strict security and compliance controls are necessary.</td><td style="text-align:left">Ideal for environments where all Pods on a Node can share the same dataset, such as when running batch processing jobs or Spark jobs that require common dependencies.</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="resource-allocation">Resource Allocation<a href="#resource-allocation" class="hash-link" aria-label="Direct link to Resource Allocation" title="Direct link to Resource Allocation">â€‹</a></h2>
<p>Before being able to implement the Mountpoint-s3 solution provided, AWS cloud resources need to be allocated. To do deploy the Terraform stack following the instructions below. After allocating the resources and setting up the EKS environment, you can explore the two different approaches of utilizing Mountpoint-S3 in detail.</p>
<div class="collapsibleContent_q3kw"><div class="header_QCEw"><h2><span>Deploy Solution Resources</span></h2><span class="icon_PckA">ðŸ‘ˆ</span></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="approach-1-deploy-mountpoint-s3-on-eks-at-pod-level">Approach 1: Deploy Mountpoint-S3 on EKS at <em>Pod level</em><a href="#approach-1-deploy-mountpoint-s3-on-eks-at-pod-level" class="hash-link" aria-label="Direct link to approach-1-deploy-mountpoint-s3-on-eks-at-pod-level" title="Direct link to approach-1-deploy-mountpoint-s3-on-eks-at-pod-level">â€‹</a></h2>
<p>Deploying Mountpoint-S3 at the Pod level involves using the <a href="https://docs.aws.amazon.com/eks/latest/userguide/ebs-csi.html" target="_blank" rel="noopener noreferrer">EKS Managed Addon CSI driver</a> with Persistent Volumes (PV) and Persistent Volume Claims (PVC) to mount an S3 bucket directly within a Pod. This method allows for fine-grained control over which Pods can access specific S3 buckets, ensuring that only the necessary workloads have access to the required data.</p>
<p>Once <a href="https://github.com/awslabs/mountpoint-s3" target="_blank" rel="noopener noreferrer">Mountpoint-S3</a> is enabled and the PV is created, the S3 bucket becomes a cluster-level resource, allowing any Pod to request access by creating a PVC that references the PV. To achieve fine-grained control over which Pods can access specific PVCs, you can use service roles within namespaces. By assigning specific service accounts to Pods and defining Role-Based Access Control (RBAC) policies, you can limit which Pods can bind to certain PVCs. This ensures that only authorized Pods can mount the S3 bucket, providing tighter security and access control compared to a host-level mount, where the hostPath is accessible to all Pods on the Node.</p>
<p>Using this approach can also be simplified using the <a href="https://docs.aws.amazon.com/eks/latest/userguide/ebs-csi.html" target="_blank" rel="noopener noreferrer">EKS Managed Addon CSI driver</a>. However, this does not support taints/tolerations and therefore cannot be used with GPUs. Additionally, because the Pods are not sharing the mount and therefore not sharing the cache it would lead to more S3 API calls.</p>
<p>For more information on how to deploy this approach refer to the <a href="https://awslabs.github.io/data-on-eks/docs/resources/mountpoint-s3" target="_blank" rel="noopener noreferrer">deployment instructions</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="approach-2--deploy-mountpoint-s3-on-eks-at-node-level">Approach 2:  Deploy Mountpoint-S3 on EKS at <em>Node level</em><a href="#approach-2--deploy-mountpoint-s3-on-eks-at-node-level" class="hash-link" aria-label="Direct link to approach-2--deploy-mountpoint-s3-on-eks-at-node-level" title="Direct link to approach-2--deploy-mountpoint-s3-on-eks-at-node-level">â€‹</a></h2>
<p>Mounting a S3 Bucket at a Node level can streamline the management of dependency JAR files for SparkApplications by  reducing build times and speeding up deployment. It can be implemented using either <strong>USERDATA</strong> or <strong>DaemonSet.</strong> USERDATA is the preferred method for implementing <a href="https://github.com/awslabs/mountpoint-s3" target="_blank" rel="noopener noreferrer">Mountpoint-S3</a>. However, if you have static Nodes in your EKS cluster that you cannot bring down, the DaemonSet approach provides an alternative. Make sure to understand all of the security mechanisms that need to be enabled in order to utilize the DaemonSet approach before implementing it.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="approach-21-using-userdata">Approach 2.1: Using USERDATA<a href="#approach-21-using-userdata" class="hash-link" aria-label="Direct link to Approach 2.1: Using USERDATA" title="Direct link to Approach 2.1: Using USERDATA">â€‹</a></h3>
<p>This approach is recommended for new clusters or where auto-scaling is customized to run workloads as the user-data script is run when a Node is initialized. Using the below script, the Node can be updated to have the S3 bucket mounted upon initialization in the EKS cluster that hosts the Pods. The below script outlines downloading, installing, and running the Mountpoint S3 package. There are a couple of arguments that are set for this application and defined below that can be altered depending on the use case. More information about these arguments and others can be found <a href="https://github.com/awslabs/mountpoint-s3/blob/main/doc/CONFIGURATION.md#caching-configuration" target="_blank" rel="noopener noreferrer">here</a></p>
<ul>
<li>metadata-ttl: this is set to indefinite because the jar files are meant to be used as read only and will not change.</li>
<li>allow-others: this is set so that the Node can have access to the mounted volume when using SSM</li>
<li>cache: this is set to enable caching and limit the S3 API calls that need to be made by storing the files in cache for consecutive re-reads.</li>
</ul>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</div><div class="admonitionContent_BuS1"><p>These same arguments can also be used in the DaemonSet approach. In addition to these arguments that are set by this example, there are also a number of other options for additional <a href="https://github.com/awslabs/mountpoint-s3/blob/main/doc/LOGGING.md" target="_blank" rel="noopener noreferrer">logging and debugging</a></p></div></div>
<p>When autoscaling with <a href="https://karpenter.sh/" target="_blank" rel="noopener noreferrer">Karpenter</a>, this method allows for more flexibility and performance. For example when configuring Karpenter in the terraform code, the user data for different types of Nodes can be unique with different buckets depending on the workload so when Pods are scheduled and need a certain set of dependencies, Taints and Tolerations will allow Karpenter to allocate the specific instance type with the unique user data to ensure the correct bucket with the dependent files is mounted on the Node so that Pods can access is. Additionally, the user script will depend on the OS that the newly allocated Node is configured with.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="userdata-script">USERDATA script:<a href="#userdata-script" class="hash-link" aria-label="Direct link to USERDATA script:" title="Direct link to USERDATA script:">â€‹</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum update -y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum install -y wget</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">wget https://s3.amazonaws.com/mountpoint-s3-release/latest/x86_64/mount-s3.rpm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yum install -y mount-s3.rpm mkdir -p /mnt/s3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/opt/aws/mountpoint-s3/bin/mount-s3 --metadata-ttl indefinite --allow-other --cache /tmp &lt;S3_BUCKET_NAME&gt; /mnt/s3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="approach-22-using-daemonset">Approach 2.2: Using DaemonSet<a href="#approach-22-using-daemonset" class="hash-link" aria-label="Direct link to Approach 2.2: Using DaemonSet" title="Direct link to Approach 2.2: Using DaemonSet">â€‹</a></h3>
<p>This approach is recommended for existing clusters. This approach is made up of 2 resources, a ConfigMap with a script that maintains the S3 Mount Point package onto the Node and a DaemonSet that runs a Pod on every Node in the cluster which will execute the script on the Node.</p>
<p>The ConfigMap script will run a loop to check the mountPoint every 60 seconds and remount it if there are any issues. There are multiple environment variables that can be altered for the mount location, cache location, S3 bucket name, log file location, and the URL of the package installation and the location of the of the installed package. These variables can be left as default as only the S3 bucket name is required to run.</p>
<p>The DaemonSet Pods will copy the script onto the Node, alter the permissions to allow execution, and then finally run the script. The Pod installs <code>util-linux</code> in order to have access to <a href="https://man7.org/linux/man-pages/man1/nsenter.1.html" target="_blank" rel="noopener noreferrer">nsenter</a>, which allows the Pod to execute the script in the Node space which allows the S3 Bucket to be mounted on to the Node directly by the Pod.</p>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>The DaemonSet Pod requires the <code>securityContext</code> to be privileged as well as <code>hostPID</code>, <code>hostIPC</code>, and <code>hostNetwork</code> to be set to true.
Review below why these are required to be configured for this solution and their security implications.</p></div></div>
<ol>
<li><code>securityContext: privileged</code>
<ul>
<li><strong>Purpose:</strong> privileged mode gives the container full access to all host resources, similar to root access on the host.</li>
<li>To install software packages, configure the system, and mount the S3 bucket onto the host, your container will likely need elevated permissions. Without privileged mode, the container might not have sufficient permissions to perform these actions on the host filesystem and network interfaces.</li>
</ul>
</li>
<li>hostPID<!-- -->
<ul>
<li><strong>Purpose:</strong> nsenter allows you to enter various namespaces, including the PID namespace of the host.</li>
<li>When using nsenter to enter the hostâ€™s PID namespace, the container needs access to the hostâ€™s PID namespace. Thus, enabling <code>hostPID: true</code> is necessary to interact with processes on the host, which is crucial for operations like installing packages or running commands that require host-level process visibility like mountpoint-s3.</li>
</ul>
</li>
<li>hostIPC<!-- -->
<ul>
<li><strong>Purpose:</strong> hostIPC enables your container to share the hostâ€™s inter-process communication namespace, which includes shared memory.</li>
<li>If nsenter commands or the script to run involves shared memory or other IPC mechanisms on the host, <code>hostIPC: true</code> will be necessary. While itâ€™s less common than hostPID, itâ€™s often enabled alongside it when nsenter is involved, especially if the script needs to interact with host processes that rely on IPC.</li>
</ul>
</li>
<li>hostNetwork<!-- -->
<ul>
<li><strong>Purpose:</strong> hostNetwork allows the container to use the hostâ€™s network namespace, giving the container access to the hostâ€™s IP address and network interfaces.</li>
<li>During the installation process, the script will likely need to download packages from the internet (e.g., from repositories hosting the mountpoint-s3 package). By enabling hostNetwork with <code>hostNetwork: true</code>, you ensure that the download processes have direct access to the hostâ€™s network interface, avoiding issues with network isolation.</li>
</ul>
</li>
</ol>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>This sample code uses the <code>spark-team-a</code> namespace to run the job and host the DaemonSet. This is primarily because the Terraform stack already sets up <a href="https://docs.aws.amazon.com/emr/latest/EMR-on-EKS-DevelopmentGuide/setting-up-enable-IAM.html" target="_blank" rel="noopener noreferrer">IRSA</a> for this namespace and allows the service account to access any S3 bucket.
When using in production make sure create your own separate namespace, service account, and IAM role that follows the policy of least-privilege permissions and follows <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/best-practices.html" target="_blank" rel="noopener noreferrer">IAM role best practice</a></p></div></div>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary> To view the DaemonSet, Click to toggle content!</summary><div><div class="collapsibleContent_i85q"><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ConfigMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">mount</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">script</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spark</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">team</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">monitor_s3_mount.sh</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">    #!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    set </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">e  </span><span class="token comment" style="color:#999988;font-style:italic"># Exit immediately if a command exits with a non-zero status</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ENVIRONMENT VARIABLES</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    LOG_FILE=&quot;/var/log/s3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">mount.log&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    S3_BUCKET_NAME=&quot;&lt;S3_BUCKET_NAME</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain">&quot;  </span><span class="token comment" style="color:#999988;font-style:italic"># Replace with your S3 Bucket Name before applying to EKS cluster</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MOUNT_POINT=&quot;/mnt/s3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CACHE_DIR=&quot;/tmp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MOUNT_S3_BIN=&quot;/usr/bin/mount</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">s3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MOUNT_S3_URL=&quot;https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//s3.amazonaws.com/mountpoint</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">s3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">release/latest/x86_64/mount</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">s3.rpm&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Function to install mount-s3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    install_mount_s3() </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">echo &quot;$(date)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Installing mount</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">s3&quot; </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> tee </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a $LOG_FILE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      yum update </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">y </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> tee </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a $LOG_FILE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      yum install </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">y wget util</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">linux </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> tee </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a $LOG_FILE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      wget $MOUNT_S3_URL </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">O /tmp/mount</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">s3.rpm </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> tee </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a $LOG_FILE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      yum install </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">y /tmp/mount</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">s3.rpm </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> tee </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a $LOG_FILE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Function to mount S3 bucket</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mount_s3_bucket() </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">echo &quot;$(date)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Mounting S3 bucket</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $S3_BUCKET_NAME to $MOUNT_POINT&quot; </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> tee </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a $LOG_FILE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      $MOUNT_S3_BIN </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">metadata</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ttl indefinite </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">allow</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">other </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cache $CACHE_DIR $S3_BUCKET_NAME $MOUNT_POINT </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> tee </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a $LOG_FILE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ne 0 </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">echo &quot;$(date)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Failed to mount S3 bucket</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $S3_BUCKET_NAME&quot; </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> tee </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a $LOG_FILE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        exit 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Ensure the mount point directory exists</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ensure_mount_point() </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token tag" style="color:#00009f">!</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">d $MOUNT_POINT </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">echo &quot;$(date)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">Creating mount point directory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $MOUNT_POINT&quot; </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> tee </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a $LOG_FILE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mkdir </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">p $MOUNT_POINT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Install mount-s3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    install_mount_s3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Continuous monitoring and remounting loop</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    while true; do</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">echo &quot;$(date)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Checking if S3 bucket is mounted&quot; </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> tee </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a $LOG_FILE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ensure_mount_point</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if mount </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> grep $MOUNT_POINT </span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"> /dev/null; then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">echo &quot;$(date)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> S3 bucket is already mounted&quot; </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> tee </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a $LOG_FILE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if </span><span class="token tag" style="color:#00009f">!</span><span class="token plain"> ls $MOUNT_POINT </span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token plain"> /dev/null 2</span><span class="token punctuation" style="color:#393A34">&gt;</span><span class="token important">&amp;1;</span><span class="token plain"> then</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">echo &quot;$(date)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Transport endpoint is not connected</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> remounting S3 bucket&quot; </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> tee </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a $LOG_FILE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">fusermount -u $MOUNT_POINT || echo &quot;$(date)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Failed to unmount S3 bucket&quot; </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> tee </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a $LOG_FILE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">rm -rf $MOUNT_POINT || echo &quot;$(date)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Failed to remove mount point directory&quot; </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> tee </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a $LOG_FILE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ensure_mount_point</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          mount_s3_bucket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      else</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">echo &quot;$(date)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> S3 bucket is not mounted</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mounting now&quot; </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> tee </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a $LOG_FILE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        mount_s3_bucket</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      fi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sleep 60  </span><span class="token comment" style="color:#999988;font-style:italic"># Check every 60 seconds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> DaemonSet</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">mount</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">daemonset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spark</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">team</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">mount</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">daemonset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">mount</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">daemonset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">hostPID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">hostIPC</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">hostNetwork</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> script</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">configMap</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">mount</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">script</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">hostPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">restartPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> s3</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">mount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> amazonlinux</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">volumeMounts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> script</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> host</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">mountPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /host</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">mountPropagation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Bidirectional</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">securityContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">privileged</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> /bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">|</span><span class="token scalar string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          set -e</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          echo &quot;Starting s3-mount&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          yum install -y util-linux</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          echo &quot;Copying script to /usr/bin&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          cp /config/monitor_s3_mount.sh /host/usr/bin/monitor_s3_mount.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          chmod +x /host/usr/bin/monitor_s3_mount.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          echo &quot;Verifying the copied script&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          ls -lha /host/usr/bin/monitor_s3_mount.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          echo &quot;Running the script in Host space&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          nsenter --target 1 --mount --uts --ipc --net --pid ./usr/bin/monitor_s3_mount.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token scalar string" style="color:#e3116c">          echo &quot;Done&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="executing-spark-job">Executing Spark Job<a href="#executing-spark-job" class="hash-link" aria-label="Direct link to Executing Spark Job" title="Direct link to Executing Spark Job">â€‹</a></h2>
<p>Here are the steps to test the scenario using Approach 2 with DaemonSet:</p>
<ol>
<li>Deploy <a href="#resource-allocation">Spark Operator Resources</a></li>
<li>Prepare the S3 Bucket<!-- -->
<ol>
<li><code>cd ${DOEKS_HOME}/analytics/terraform/spark-k8s-operator/examples/mountpoint-s3-spark/</code></li>
<li><code>chmod +x copy-jars-to-s3.sh</code></li>
<li><code>./copy-jars-to-s3.sh</code></li>
</ol>
</li>
<li>Set-up Kubeconfig<!-- -->
<ol>
<li><code>aws eks update-kubeconfig --name spark-operator-doeks</code></li>
</ol>
</li>
<li>Apply DaemonSet<!-- -->
<ol>
<li><code>kubectl apply -f mountpoint-s3-daemonset.yaml </code></li>
</ol>
</li>
<li>Apply Spark Job sample<!-- -->
<ol>
<li>
<ol>
<li><code>kubectl apply -f mountpoint-s3-spark-job.yaml </code></li>
</ol>
</li>
</ol>
</li>
<li>View Job Running<!-- -->
<ul>
<li>There are a couple different resources of which we can view logs of as this SparkApplication CRD is running. Each of these logs should be in a separate terminal to view all of the logs simultaneously.<!-- -->
<ol>
<li><strong>spark operator</strong>
<ol>
<li><code> kubectl -n spark-operator get pods</code></li>
<li>copy the name of the spark operator pod</li>
<li><code> kubectl -n spark-operator logs -f &lt;POD_NAME&gt;</code></li>
</ol>
</li>
<li><strong>spark-team-a Pods</strong>
<ol>
<li>In order to get the logs for the driver and exec Pods for the SparkApplication, we need to first verify that the Pods are running. Using wide output we should be able to see the Node that the Pods are running on and using <code>-w</code> we can see the status updates for each of the Pods.</li>
<li><code>kubectl -n spark-team-a get pods -o wide -w</code></li>
</ol>
</li>
<li><strong>driver Pod</strong>
<ol>
<li>Once the driver Pod is in the running state, which will be visible in the previous terminal, we can get the logs for the driver Pod</li>
<li><code>kubectl -n spark-team-a logs -f taxi-trip</code></li>
</ol>
</li>
<li><strong>exec Pod</strong>
<ol>
<li>Once the exec Pod is in the running state which will be visible in the previous terminal, we can get the logs for the exec Pod. Make sure that the exec-1 is running before getting the logs, otherwise use another exec Pod that is in the running state.</li>
<li>
<ol start="2">
<li><code>kubectl -n spark-team-a logs -f taxi-trip-exec-1</code></li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ul>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="verification">Verification<a href="#verification" class="hash-link" aria-label="Direct link to Verification" title="Direct link to Verification">â€‹</a></h2>
<p>Once the job is done running you can see in the exec logs that the files are being copied from the local mountpoint-s3 location on the Node to the spark Pod in order to do the processing.</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">24/08/13 00:08:46 INFO Utils: Copying /mnt/s3/jars/hadoop-aws-3.3.1.jar to /var/data/spark-5eae56b3-3999-4c2f-8004-afc46d1c82ba/spark-a433e7ce-db5d-4fd5-b344-abf751f43bd3/-14716855631723507720806_cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">24/08/13 00:08:46 INFO Utils: Copying /var/data/spark-5eae56b3-3999-4c2f-8004-afc46d1c82ba/spark-a433e7ce-db5d-4fd5-b344-abf751f43bd3/-14716855631723507720806_cache to /opt/spark/work-dir/./hadoop-aws-3.3.1.jar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">24/08/13 00:08:46 INFO Executor: Adding file:/opt/spark/work-dir/./hadoop-aws-3.3.1.jar to class loader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">24/08/13 00:08:46 INFO Executor: Fetching file:/mnt/s3/jars/aws-java-sdk-bundle-1.12.647.jar with timestamp 1723507720806</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">24/08/13 00:08:46 INFO Utils: Copying /mnt/s3/jars/aws-java-sdk-bundle-1.12.647.jar to /var/data/spark-5eae56b3-3999-4c2f-8004-afc46d1c82ba/spark-a433e7ce-db5d-4fd5-b344-abf751f43bd3/14156613201723507720806_cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">24/08/13 00:08:47 INFO Utils: Copying /var/data/spark-5eae56b3-3999-4c2f-8004-afc46d1c82ba/spark-a433e7ce-db5d-4fd5-b344-abf751f43bd3/14156613201723507720806_cache to /opt/spark/work-dir/./aws-java-sdk-bundle-1.12.647.jar</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Additionally, when viewing status of the spark-team-a Pods, you would notice that another Node comes online, this Node is is optimized to the run the SparkApplication and as soon as it comes online the DaemonSet Pod will also spin up and start running on the new Node so that any Pods that are run that new Node will also have access to the S3 Bucket. Using Systems Sessions Manager (SSM), you can connect any of the Nodes and verify the that the mountpoint-s3 package has been downloaded and installed by running:</p>
<ul>
<li><code>mount-s3 --version</code></li>
</ul>
<p>The largest advantage to using the mountpoint-S3 on the Node level for multiple Pods is that the data can be cached to allow other Pods to access the same data without having to make their own API calls. Once the <em>karpenter-spark-compute-optimized</em> optimized Node is allocated you can use Sessions Manager (SSM) to connect to the Node and verify that the files will be cached on the Node when the job is run and the volume is mounted. you can see the cache at:</p>
<ul>
<li><code>sudo ls /tmp/mountpoint-cache/</code></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">â€‹</a></h2>
<p>By leveraging the CRT library, Mountpoint for Amazon S3 can deliver the high throughput and low latency needed to efficiently manage and access large volumes of data stored in S3. This allows dependency JAR files to be stored and managed externally from the container image, decoupling them from the Spark jobs. Additionally, storing JARs in S3 enables multiple Pods to consume them, leading to cost savings as S3 provides a cost-effective storage solution compared to larger container images. S3 also offers virtually unlimited storage, making it easy to scale and manage dependencies.</p>
<p>Mountpoint-S3 offers a versatile and powerful way to integrate S3 storage with EKS for data and AI/ML workloads. Whether you choose to deploy it at the Pod level using PVs and PVCs, or at the Node level using USERDATA or DaemonSets, each approach has its own set of advantages and trade-offs. By understanding these options, you can make informed decisions to optimize your data and AI/ML workflows on EKS.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/awslabs/data-on-eks/blob/main/website/docs/resources/mountpoint-s3-for-spark.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/data-on-eks/docs/resources/mountpoint-s3"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Mounpoint-S3 on EKS</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/data-on-eks/docs/resources/binpacking-custom-scheduler-eks"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Bin packing for Amazon EKS</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#what-is-mountpoint-s3" class="table-of-contents__link toc-highlight">What is Mountpoint-S3?</a></li><li><a href="#using-mountpoint-s3-with-eks" class="table-of-contents__link toc-highlight">Using Mountpoint-S3 with EKS</a></li><li><a href="#resource-allocation" class="table-of-contents__link toc-highlight">Resource Allocation</a><ul><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#deploy" class="table-of-contents__link toc-highlight">Deploy</a></li></ul></li><li><a href="#approach-1-deploy-mountpoint-s3-on-eks-at-pod-level" class="table-of-contents__link toc-highlight">Approach 1: Deploy Mountpoint-S3 on EKS at <em>Pod level</em></a></li><li><a href="#approach-2--deploy-mountpoint-s3-on-eks-at-node-level" class="table-of-contents__link toc-highlight">Approach 2:  Deploy Mountpoint-S3 on EKS at <em>Node level</em></a><ul><li><a href="#approach-21-using-userdata" class="table-of-contents__link toc-highlight">Approach 2.1: Using USERDATA</a></li><li><a href="#approach-22-using-daemonset" class="table-of-contents__link toc-highlight">Approach 2.2: Using DaemonSet</a></li></ul></li><li><a href="#executing-spark-job" class="table-of-contents__link toc-highlight">Executing Spark Job</a></li><li><a href="#verification" class="table-of-contents__link toc-highlight">Verification</a></li><li><a href="#conclusion" class="table-of-contents__link toc-highlight">Conclusion</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Get Started</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/data-on-eks/docs/introduction/intro">Docs</a></li></ul></div><div class="col footer__col"><div class="footer__title">Get Involved</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/awslabs/data-on-eks" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Built with â¤ï¸ at AWS  <br> Â© 2025 Amazon.com, Inc. or its affiliates. All Rights Reserved</div></div></div></footer><script defer="" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon="{&quot;token&quot;: &quot;7fbc7ab02fae4767b1af2588eba0cdf2&quot;}"></script></div>
</body>
</html>