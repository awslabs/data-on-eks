apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: aws-for-fluentbit
  namespace: argocd
  labels:
    category: core
    type: logging
spec:
  project: core-infrastructure
  source:
    repoURL: https://aws.github.io/eks-charts
    chart: aws-for-fluent-bit
    targetRevision: "0.1.34"
    helm:
      values: |
        serviceAccount:
          create: true
          name: aws-for-fluent-bit
          annotations:
            eks.amazonaws.com/role-arn: "{{ .Values.fluentbitRoleArn }}"
        
        cloudWatchLogs:
          enabled: true
          region: "{{ .Values.region }}"
          logGroupName: "/{{ .Values.clusterName }}/aws-fluentbit-logs"
          logStreamName: "worker-fluentbit"
          autoCreateGroup: true
        
        kinesis:
          enabled: false
        
        elasticsearch:
          enabled: false
        
        opensearch:
          enabled: false
        
        s3:
          enabled: true
          bucket: "{{ .Values.s3BucketName }}"
          region: "{{ .Values.region }}"
          prefix: "fluent-bit-logs"
          bufferSize: "10MB"
          pathFormat: "/year=%Y/month=%m/day=%d/hour=%H/"
          uploadTimeout: "10m"
          storeDir: "/tmp/fluent-bit/s3"
        
        tolerations:
          - operator: Exists
        
        nodeSelector: {}
        
        resources:
          requests:
            cpu: 50m
            memory: 50Mi
          limits:
            cpu: 100m
            memory: 100Mi
  
  destination:
    server: https://kubernetes.default.svc
    namespace: aws-for-fluent-bit
  
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true