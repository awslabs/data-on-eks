# Spark on EKS - Blueprint Composition
# Deploys Karpenter addon, NodePools/NodeClasses, Spark Operator, History Server, YuniKorn

apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: spark-on-eks
  namespace: argocd
  labels:
    blueprint: spark-on-eks
spec:
  generators:
    - matrix:
        generators:
          # Dev environment only (users can copy to create other environments)
          - list:
              elements:
                - env: dev
          
          # ArgoCD addon deployment sequence
          - list:
              elements:
                # Phase 1: Karpenter Addon (Helm Chart v1.6.0)
                - addon: karpenter
                  category: core
                  namespace: karpenter
                  syncWave: "1"
                
                # Phase 2: Karpenter Resources (NodePools + NodeClasses)
                - addon: karpenter-resources
                  category: core
                  namespace: karpenter
                  syncWave: "2"
                
                # Phase 3: Data Platform Addons
                - addon: spark-operator
                  category: data
                  namespace: spark-operator
                  syncWave: "3"
                
                - addon: spark-history-server
                  category: data
                  namespace: spark-operator
                  syncWave: "4"
                
                - addon: yunikorn
                  category: data
                  namespace: yunikorn
                  syncWave: "3"

  template:
    metadata:
      name: "{{addon}}-{{env}}"
      namespace: argocd
      labels:
        blueprint: spark-on-eks
        addon: "{{addon}}"
        environment: "{{env}}"
      annotations:
        argocd.argoproj.io/sync-wave: "{{syncWave}}"

    spec:
      project: default
      
      source:
        # For local development/testing - ArgoCD uses local filesystem
        # For production - change repoURL to your GitOps repository
        repoURL: file:///data-on-eks
        targetRevision: HEAD
        path: "infra/argocd/{{category}}/{{addon}}"

        helm:
          valueFiles:
            - values.yaml
            - ../../../blueprints/spark-on-eks/values/{{env}}/{{addon}}.yaml
          
          parameters:
            - name: global.clusterName
              value: "CLUSTER_NAME_PLACEHOLDER"
            - name: global.environment
              value: "{{env}}"
            - name: global.region
              value: "REGION_PLACEHOLDER"
            - name: global.s3BucketName
              value: "S3_BUCKET_PLACEHOLDER"
      
      destination:
        server: https://kubernetes.default.svc
        namespace: "{{namespace}}"

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
        retry:
          limit: 3
          backoff:
            duration: 5s
            factor: 2
            maxDuration: 3m
