# Karpenter Resources for Spark on EKS - Dev Environment
# NodePools and NodeClasses for Spark workloads

# Spark NodePools
sparkNodePools:
  # General purpose Spark nodes
  - name: spark-general
    metadata:
      labels:
        type: karpenter
        blueprint: spark-on-eks
        environment: dev
    spec:
      template:
        spec:
          nodeClassRef:
            apiVersion: karpenter.k8s.aws/v1
            kind: EC2NodeClass
            name: spark-general
          
          requirements:
            - key: "karpenter.sh/capacity-type"
              operator: In
              values: ["spot", "on-demand"]
            - key: "kubernetes.io/arch"
              operator: In
              values: ["amd64"]
            - key: "karpenter.k8s.aws/instance-category"
              operator: In
              values: ["c", "m", "r"]
            - key: "karpenter.k8s.aws/instance-size"
              operator: In
              values: ["large", "xlarge", "2xlarge", "4xlarge"]
          
          expireAfter: 30m
          terminationGracePeriod: 60s
      
      limits:
        cpu: 1000
      
      disruption:
        consolidationPolicy: WhenEmptyOrUnderutilized
        consolidateAfter: 1m

# Spark EC2NodeClasses
sparkEC2NodeClasses:
  - name: spark-general
    metadata:
      labels:
        blueprint: spark-on-eks
        environment: dev
    spec:
      amiFamily: AL2023
      instanceStorePolicy: RAID0
      
      subnetSelectorTerms:
        - tags:
            karpenter.sh/discovery: "spark-on-eks-dev"
            Type: "Private"
      
      securityGroupSelectorTerms:
        - tags:
            karpenter.sh/discovery: "spark-on-eks-dev"
            Type: "ClusterSharedNodeSecurityGroup"
      
      blockDeviceMappings:
        - deviceName: /dev/xvda
          ebs:
            volumeSize: 100Gi
            volumeType: gp3
            encrypted: true
            deleteOnTermination: true
      
      tags:
        Blueprint: spark-on-eks
        Environment: dev
        ManagedBy: karpenter