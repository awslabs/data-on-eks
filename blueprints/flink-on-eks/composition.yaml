# Flink on EKS - Blueprint Composition
# Uses SAME base addons as Spark, but with different configurations

apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: flink-on-eks
  namespace: argocd
  labels:
    blueprint: flink-on-eks
    category: composition
spec:
  generators:
    - matrix:
        generators:
          # Environment matrix (same pattern as Spark)
          - list:
              elements:
                - env: dev
                  domain: dev.data-on-eks.com
                  replicas: 1
                - env: prod
                  domain: prod.data-on-eks.com
                  replicas: 3

          # Flink-specific addon selection
          - list:
              elements:
                # SAME Core Infrastructure (different config)
                - addon: karpenter
                  category: core
                  namespace: karpenter
                  syncWave: "1"
                  required: true

                - addon: aws-load-balancer-controller
                  category: core
                  namespace: kube-system
                  syncWave: "2"
                  required: true

                # Different Data Platform Addon
                - addon: flink-operator
                  category: data
                  namespace: flink-operator
                  syncWave: "3"
                  required: true

                # SAME Observability (different config)
                - addon: prometheus-stack
                  category: observability
                  namespace: kube-prometheus-stack
                  syncWave: "4"
                  required: true

  template:
    metadata:
      name: "{{addon}}-{{env}}"
      namespace: argocd
      labels:
        blueprint: flink-on-eks
        addon: "{{addon}}"
        category: "{{category}}"
        environment: "{{env}}"
      annotations:
        argocd.argoproj.io/sync-wave: "{{syncWave}}"

    spec:
      project: data-platform

      source:
        repoURL: https://github.com/awslabs/data-on-eks
        targetRevision: main
        # SAME infra/argocd/ library as Spark!
        path: "infra/argocd/{{category}}/{{addon}}"

        helm:
          valueFiles:
            - values.yaml  # SAME base defaults
            # Flink-specific overrides (different from Spark)
            - ../../../blueprints/flink-on-eks/values/{{env}}/{{addon}}.yaml

          # Different global parameters for Flink
          parameters:
            - name: global.clusterName
              value: "flink-on-eks-{{env}}"
            - name: global.environment
              value: "{{env}}"
            - name: global.region
              value: "eu-west-1"  # Different region than Spark
            - name: global.blueprint
              value: "flink-on-eks"
            - name: global.replicas
              value: "{{replicas}}"

      destination:
        server: https://kubernetes.default.svc
        namespace: "{{namespace}}"

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
