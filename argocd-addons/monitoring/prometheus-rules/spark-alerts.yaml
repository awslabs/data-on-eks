apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: spark-operator-alerts
  namespace: kube-prometheus-stack
  labels:
    prometheus: kube-prometheus-stack-prometheus
    role: alert-rules
spec:
  groups:
  - name: spark-operator
    interval: 30s
    rules:
    # Spark Application Failures
    - alert: SparkApplicationFailed
      expr: spark_app_completed_count{status="FAILED"} > 0
      for: 0m
      labels:
        severity: critical
      annotations:
        summary: "Spark application failed"
        description: "Spark application {{ $labels.name }} in namespace {{ $labels.namespace }} has failed"
    
    # High Spark Application Queue Time
    - alert: SparkApplicationHighQueueTime
      expr: spark_app_queue_time_seconds > 300
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Spark application high queue time"
        description: "Spark application {{ $labels.name }} has been queued for more than 5 minutes"
    
    # Karpenter Node Provisioning Issues
    - alert: KarpenterNodeProvisioningFailed
      expr: increase(karpenter_nodes_terminated_total[10m]) > increase(karpenter_nodes_created_total[10m])
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Karpenter node provisioning issues"
        description: "More nodes terminated than created in the last 10 minutes"
    
    # Spark Driver Memory Usage
    - alert: SparkDriverHighMemoryUsage
      expr: (spark_driver_memory_used_bytes / spark_driver_memory_total_bytes) > 0.9
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Spark driver high memory usage"
        description: "Spark driver {{ $labels.app_name }} is using more than 90% memory"
    
    # Spark Executor Failures
    - alert: SparkExecutorFailures
      expr: rate(spark_executor_failures_total[5m]) > 0.1
      for: 2m
      labels:
        severity: warning
      annotations:
        summary: "High Spark executor failure rate"
        description: "Spark application {{ $labels.app_name }} has high executor failure rate"

  - name: karpenter
    interval: 30s
    rules:
    # Karpenter Node Pool Capacity
    - alert: KarpenterNodePoolCapacityLimit
      expr: (karpenter_nodepool_usage / karpenter_nodepool_limit) > 0.9
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Karpenter node pool near capacity limit"
        description: "Node pool {{ $labels.nodepool }} is using more than 90% of capacity"
    
    # Karpenter Provisioning Latency
    - alert: KarpenterHighProvisioningLatency
      expr: histogram_quantile(0.95, karpenter_node_provisioning_duration_seconds_bucket) > 300
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High Karpenter node provisioning latency"
        description: "95th percentile node provisioning time is above 5 minutes"