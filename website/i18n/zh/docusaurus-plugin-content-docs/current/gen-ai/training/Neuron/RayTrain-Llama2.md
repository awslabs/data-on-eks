---
sidebar_position: 1
sidebar_label: åœ¨Trn1ä¸Šä½¿ç”¨RayTrainè®­ç»ƒLlama-2
---
import CollapsibleContent from '../../../../../../../src/components/CollapsibleContent';

:::caution

**AI on EKS**å†…å®¹**æ­£åœ¨è¿ç§»**åˆ°ä¸€ä¸ªæ–°çš„ä»“åº“ã€‚
ğŸ”— ğŸ‘‰ [é˜…è¯»å®Œæ•´çš„è¿ç§»å…¬å‘Š Â»](https://awslabs.github.io/data-on-eks/docs/migration/migration-announcement)

:::

:::warning
åœ¨EKSä¸Šéƒ¨ç½²MLæ¨¡å‹éœ€è¦è®¿é—®GPUæˆ–Neuronå®ä¾‹ã€‚å¦‚æœæ‚¨çš„éƒ¨ç½²ä¸èµ·ä½œç”¨ï¼Œé€šå¸¸æ˜¯å› ä¸ºç¼ºå°‘å¯¹è¿™äº›èµ„æºçš„è®¿é—®ã€‚æ­¤å¤–ï¼Œä¸€äº›éƒ¨ç½²æ¨¡å¼ä¾èµ–äºKarpenterè‡ªåŠ¨æ‰©å±•å’Œé™æ€èŠ‚ç‚¹ç»„ï¼›å¦‚æœèŠ‚ç‚¹æœªåˆå§‹åŒ–ï¼Œè¯·æ£€æŸ¥Karpenteræˆ–èŠ‚ç‚¹ç»„çš„æ—¥å¿—ä»¥è§£å†³é—®é¢˜ã€‚
:::

:::danger

æ³¨æ„ï¼šä½¿ç”¨æ­¤Llama-2æ¨¡å‹å—Metaè®¸å¯è¯çš„çº¦æŸã€‚
ä¸ºäº†ä¸‹è½½æ¨¡å‹æƒé‡å’Œåˆ†è¯å™¨ï¼Œè¯·è®¿é—®[ç½‘ç«™](https://ai.meta.com/)å¹¶åœ¨è¯·æ±‚è®¿é—®å‰æ¥å—è®¸å¯è¯ã€‚

:::

:::info

æˆ‘ä»¬æ­£åœ¨ç§¯æå¢å¼ºæ­¤è“å›¾ï¼Œä»¥çº³å…¥å¯è§‚æµ‹æ€§ã€æ—¥å¿—è®°å½•å’Œå¯æ‰©å±•æ€§æ–¹é¢çš„æ”¹è¿›ã€‚

:::

# ä½¿ç”¨RayTrainå’ŒKubeRayåœ¨Trn1ä¸Šè¿›è¡ŒLlama2åˆ†å¸ƒå¼é¢„è®­ç»ƒ

æœ¬ç»¼åˆæŒ‡å—å°†å¼•å¯¼æ‚¨ä½¿ç”¨AWS Trainium (Trn1)å®ä¾‹å’ŒAWS Neuron SDKåœ¨Amazon EKSçš„KubeRayé›†ç¾¤ä¸­é¢„è®­ç»ƒ`Llama2-7B`è¯­è¨€æ¨¡å‹ã€‚è¿™æ˜¯åŸå§‹[Llama2é¢„è®­ç»ƒæ•™ç¨‹](https://awsdocs-neuron.readthedocs-hosted.com/en/latest/libraries/neuronx-distributed/tutorials/training_llama2_7b.html#llama2-7b-tp-zero1-tutorial)çš„å®šåˆ¶ç‰ˆæœ¬ï¼Œé’ˆå¯¹KubeRayçš„åˆ†å¸ƒå¼è®­ç»ƒèƒ½åŠ›è¿›è¡Œäº†ä¼˜åŒ–ã€‚

![Llama2-RayTrain](../../../../../../../docs/gen-ai/training/img/Llama2-RayTrain-Trn1.png)

### ä»€ä¹ˆæ˜¯Llama-2ï¼Ÿ

Llama-2æ˜¯ä¸€ä¸ªæœ€å…ˆè¿›çš„å¤§å‹è¯­è¨€æ¨¡å‹(LLM)ï¼Œè®¾è®¡ç”¨äºå„ç§è‡ªç„¶è¯­è¨€å¤„ç†(NLP)ä»»åŠ¡ï¼ŒåŒ…æ‹¬æ–‡æœ¬ç”Ÿæˆã€æ‘˜è¦ã€ç¿»è¯‘ã€é—®ç­”ç­‰ã€‚å®ƒæ˜¯ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥é’ˆå¯¹ç‰¹å®šç”¨ä¾‹è¿›è¡Œå¾®è°ƒã€‚

### ä¸ºä»€ä¹ˆä½¿ç”¨RayTrainå’ŒKubeRayè¿›è¡Œåˆ†å¸ƒå¼è®­ç»ƒï¼Ÿ

ç”±äºLlama-2ç­‰å¤§å‹æ¨¡å‹çš„å¹¿æ³›è®¡ç®—å’Œå†…å­˜éœ€æ±‚ï¼Œåˆ†å¸ƒå¼è®­ç»ƒè‡³å…³é‡è¦ã€‚RayTrainå’ŒKubeRayçš„ç»„åˆï¼Œç‰¹åˆ«æ˜¯ä¸AWS Trainiumä¸€èµ·ä½¿ç”¨æ—¶ï¼Œæä¾›äº†ä¸€ä¸ªå¼ºå¤§çš„æ¡†æ¶ï¼Œå¯ä»¥é«˜æ•ˆæœ‰æ•ˆåœ°å¤„ç†è¿™äº›éœ€æ±‚ï¼š

#### RayTrainï¼š
- **ç®€åŒ–çš„åˆ†å¸ƒå¼è®­ç»ƒ**ï¼šRayTrainæ˜¯å»ºç«‹åœ¨Rayæ¡†æ¶ä¸Šçš„é«˜çº§åº“ï¼ŒæŠ½è±¡äº†åˆ†å¸ƒå¼è®­ç»ƒçš„å¤æ‚æ€§ã€‚å®ƒå…è®¸æ‚¨ä»¥æœ€å°‘çš„ä»£ç æ›´æ”¹å°†Llama-2è®­ç»ƒæ‰©å±•åˆ°å¤šä¸ªèŠ‚ç‚¹ã€‚Rayçš„åŸºäºè§’è‰²çš„æ¶æ„å’ŒåŸºäºä»»åŠ¡çš„å¹¶è¡Œæ€§ä½¿åˆ†å¸ƒå¼å·¥ä½œè´Ÿè½½èƒ½å¤Ÿé«˜æ•ˆæ‰§è¡Œã€‚
- **çµæ´»çš„ç­–ç•¥**ï¼šRayTrainæ”¯æŒå„ç§åˆ†å¸ƒå¼è®­ç»ƒç­–ç•¥ï¼Œå¦‚æ•°æ®å¹¶è¡Œå’Œæ¨¡å‹å¹¶è¡Œã€‚æ•°æ®å¹¶è¡Œå°†æ•°æ®é›†åˆ†å‰²åˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œè€Œæ¨¡å‹å¹¶è¡Œåˆ™åˆ†å‰²æ¨¡å‹æœ¬èº«ã€‚è¿™ç§çµæ´»æ€§ä½¿æ‚¨èƒ½å¤Ÿæ ¹æ®æ¨¡å‹çš„ç‰¹å®šéœ€æ±‚å’Œè®­ç»ƒç¯å¢ƒçš„æ¶æ„ä¼˜åŒ–è®­ç»ƒã€‚
- **å®¹é”™æ€§**ï¼šRayTrainåŒ…å«å†…ç½®çš„å®¹é”™æœºåˆ¶ã€‚å¦‚æœä¸€ä¸ªèŠ‚ç‚¹å¤±è´¥ï¼ŒRayå¯ä»¥åœ¨å…¶ä»–å¯ç”¨èŠ‚ç‚¹ä¸Šé‡æ–°è°ƒåº¦ä»»åŠ¡ï¼Œç¡®ä¿è®­ç»ƒä½œä¸šä¸é—´æ–­åœ°ç»§ç»­ã€‚è¿™ä¸ªç‰¹æ€§å¯¹äºåœ¨å¤§è§„æ¨¡åˆ†å¸ƒå¼è®­ç»ƒç¯å¢ƒä¸­ä¿æŒç¨³å¥æ€§è‡³å…³é‡è¦ã€‚
- **æ˜“ç”¨æ€§**ï¼šRayTrainæä¾›ç›´è§‚çš„APIï¼Œç®€åŒ–äº†åˆ†å¸ƒå¼è®­ç»ƒä½œä¸šçš„è®¾ç½®å’Œæ‰§è¡Œã€‚ä¸æµè¡Œçš„æœºå™¨å­¦ä¹ åº“ï¼ˆå¦‚Hugging Face Transformersï¼‰çš„é›†æˆä½¿å¾—å°†RayTrainçº³å…¥ç°æœ‰å·¥ä½œæµç¨‹å˜å¾—æ›´åŠ å®¹æ˜“ï¼Œæ— éœ€è¿›è¡Œå¹¿æ³›çš„ä¿®æ”¹ã€‚
#### KubeRayï¼š
- **ä¸Kubernetesé›†æˆ**ï¼šKubeRayåˆ©ç”¨Kubernetesçš„åŸç”ŸåŠŸèƒ½æ¥éƒ¨ç½²ã€ç®¡ç†å’Œæ‰©å±•Rayé›†ç¾¤ã€‚è¿™ç§é›†æˆå…è®¸æ‚¨ä½¿ç”¨Kuberneteså¼ºå¤§çš„ç¼–æ’åŠŸèƒ½æœ‰æ•ˆåœ°å¤„ç†Rayå·¥ä½œè´Ÿè½½ã€‚
- **åŠ¨æ€æ‰©å±•**ï¼šKubeRayæ”¯æŒRayé›†ç¾¤çš„åŠ¨æ€æ‰©å±•ã€‚Rayçš„å†…ç½®è‡ªåŠ¨ç¼©æ”¾å™¨å¯ä»¥æ ¹æ®å·¥ä½œè´Ÿè½½éœ€æ±‚è¯·æ±‚é¢å¤–çš„è§’è‰²å‰¯æœ¬ï¼Œè€ŒKuberneteså·¥å…·ï¼ˆå¦‚Karpenteræˆ–Cluster Autoscalerï¼‰ç®¡ç†æ–°èŠ‚ç‚¹çš„åˆ›å»ºä»¥æ»¡è¶³è¿™äº›éœ€æ±‚ã€‚
- **æ°´å¹³æ‰©å±•**ï¼šéšç€è®¡ç®—è´Ÿè½½çš„å¢åŠ ï¼Œé€šè¿‡æ·»åŠ æ›´å¤šå·¥ä½œèŠ‚ç‚¹æ°´å¹³æ‰©å±•Rayé›†ç¾¤ã€‚è¿™å…è®¸é«˜æ•ˆå¤„ç†å¤§è§„æ¨¡åˆ†å¸ƒå¼è®­ç»ƒå’Œæ¨ç†ä»»åŠ¡ã€‚
- **è‡ªå®šä¹‰èµ„æºå®šä¹‰(CRD)**ï¼šKubeRayåˆ©ç”¨Kubernetes CRDæ¥å®šä¹‰å’Œç®¡ç†Rayé›†ç¾¤å’Œä½œä¸šã€‚è¿™ä¸ºåœ¨Kubernetesç”Ÿæ€ç³»ç»Ÿä¸­å¤„ç†Rayå·¥ä½œè´Ÿè½½æä¾›äº†ä¸€ç§æ ‡å‡†åŒ–çš„æ–¹å¼ã€‚
- **å®¹é”™æ€§**ï¼šKubeRayåˆ©ç”¨Kubernetesçš„è‡ªæˆ‘ä¿®å¤èƒ½åŠ›ã€‚å¦‚æœRayå¤´èŠ‚ç‚¹æˆ–å·¥ä½œèŠ‚ç‚¹å¤±è´¥ï¼ŒKubernetesä¼šè‡ªåŠ¨é‡å¯å¤±è´¥çš„ç»„ä»¶ï¼Œç¡®ä¿æœ€å°çš„åœæœºæ—¶é—´å’ŒæŒç»­è¿è¡Œã€‚
- **åˆ†å¸ƒå¼è°ƒåº¦**ï¼šRayåŸºäºè§’è‰²çš„æ¨¡å‹å’Œåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ï¼Œç»“åˆKubernetesçš„ç¼–æ’ï¼Œç¡®ä¿å³ä½¿åœ¨èŠ‚ç‚¹æ•…éšœçš„æƒ…å†µä¸‹ä¹Ÿèƒ½ä¿æŒé«˜å¯ç”¨æ€§å’Œé«˜æ•ˆçš„ä»»åŠ¡æ‰§è¡Œã€‚
- **å£°æ˜å¼é…ç½®**ï¼šKubeRayå…è®¸æ‚¨ä½¿ç”¨å£°æ˜å¼YAMLé…ç½®å®šä¹‰Rayé›†ç¾¤å’Œä½œä¸šã€‚è¿™ç®€åŒ–äº†éƒ¨ç½²å’Œç®¡ç†è¿‡ç¨‹ï¼Œä½¿è®¾ç½®å’Œç»´æŠ¤Rayé›†ç¾¤å˜å¾—æ›´åŠ å®¹æ˜“ã€‚
- **é›†æˆçš„æ—¥å¿—å’Œç›‘æ§**ï¼šKubeRayä¸Kubernetesçš„æ—¥å¿—å’Œç›‘æ§å·¥å…·ï¼ˆå¦‚Prometheuså’ŒGrafanaï¼‰é›†æˆã€‚è¿™æä¾›äº†å¯¹Rayé›†ç¾¤æ€§èƒ½å’Œå¥åº·çŠ¶å†µçš„å…¨é¢æ´å¯Ÿï¼Œä¾¿äºæ›´å®¹æ˜“åœ°è°ƒè¯•å’Œä¼˜åŒ–ã€‚
- **ç«ä»·å®ä¾‹**ï¼šä½¿ç”¨Kuberneteså¯¹ç«ä»·å®ä¾‹çš„æ”¯æŒæ¥ç»æµé«˜æ•ˆåœ°è¿è¡ŒRayé›†ç¾¤ã€‚è¿™ä½¿æ‚¨èƒ½å¤Ÿåˆ©ç”¨ä½æˆæœ¬çš„è®¡ç®—èµ„æºï¼ŒåŒæ—¶ä¿æŒæ ¹æ®éœ€è¦è¿›è¡Œæ‰©å±•çš„èƒ½åŠ›ã€‚

#### AWS Trainiumï¼š
- **é’ˆå¯¹æ·±åº¦å­¦ä¹ ä¼˜åŒ–**ï¼šåŸºäºAWS Trainiumçš„Trn1å®ä¾‹ä¸“ä¸ºæ·±åº¦å­¦ä¹ å·¥ä½œè´Ÿè½½è®¾è®¡ã€‚å®ƒä»¬æä¾›é«˜ååé‡å’Œä½å»¶è¿Ÿï¼Œä½¿å…¶æˆä¸ºè®­ç»ƒLlama-2ç­‰å¤§è§„æ¨¡æ¨¡å‹çš„ç†æƒ³é€‰æ‹©ã€‚TrainiumèŠ¯ç‰‡ç›¸æ¯”ä¼ ç»Ÿå¤„ç†å™¨æä¾›æ˜¾è‘—çš„æ€§èƒ½æ”¹è¿›ï¼ŒåŠ é€Ÿè®­ç»ƒæ—¶é—´ã€‚
- **Neuron SDK**ï¼šAWS Neuron SDKä¸“ä¸ºä¼˜åŒ–æ‚¨çš„æ·±åº¦å­¦ä¹ æ¨¡å‹ä»¥é€‚åº”Trainiumè€Œé‡èº«å®šåˆ¶ã€‚å®ƒåŒ…æ‹¬é«˜çº§ç¼–è¯‘å™¨ä¼˜åŒ–å’Œå¯¹æ··åˆç²¾åº¦è®­ç»ƒçš„æ”¯æŒç­‰åŠŸèƒ½ï¼Œå¯ä»¥åœ¨ä¿æŒå‡†ç¡®æ€§çš„åŒæ—¶è¿›ä¸€æ­¥åŠ é€Ÿæ‚¨çš„è®­ç»ƒå·¥ä½œè´Ÿè½½ã€‚

### ä¸ºä»€ä¹ˆè¿™ç§ç»„åˆå¼ºå¤§
- **ç®€åŒ–æ‰©å±•**ï¼šRayTrainå’ŒKubeRayç®€åŒ–äº†å°†Llama-2è®­ç»ƒæ‰©å±•åˆ°å¤šä¸ªèŠ‚ç‚¹çš„è¿‡ç¨‹ã€‚å€ŸåŠ©Rayçš„é«˜æ•ˆåˆ†å¸ƒå¼æ‰§è¡Œå’ŒKubeRayçš„KubernetesåŸç”Ÿç¼–æ’ï¼Œæ‚¨å¯ä»¥è½»æ¾æ‰©å±•è®­ç»ƒå·¥ä½œè´Ÿè½½ï¼Œå……åˆ†åˆ©ç”¨Trn1å®ä¾‹ä¸Šçš„AWS Trainiumçš„å…¨éƒ¨åŠŸèƒ½ã€‚
- **ä¼˜åŒ–æ€§èƒ½**ï¼šNeuron SDKé€šè¿‡ä¸“é—¨é’ˆå¯¹Trainiumæ¶æ„ä¼˜åŒ–ï¼Œå¢å¼ºäº†è®­ç»ƒä½œä¸šçš„æ€§èƒ½ã€‚ç»“åˆRayé«˜æ•ˆç®¡ç†åˆ†å¸ƒå¼ä»»åŠ¡çš„èƒ½åŠ›å’ŒKubeRayçš„èµ„æºç¼–æ’ï¼Œè¿™ç§è®¾ç½®ç¡®ä¿äº†æœ€ä½³çš„è®­ç»ƒæ€§èƒ½ã€‚
- **æˆæœ¬æ•ˆç›Š**ï¼šRayçš„è‡ªåŠ¨æ‰©å±•èƒ½åŠ›å’ŒKubernetesçš„èµ„æºç®¡ç†å¸®åŠ©æ‚¨é€šè¿‡é«˜æ•ˆåˆ†é…èµ„æºå¹¶æ ¹æ®éœ€æ±‚æ‰©å±•é›†ç¾¤æ¥ä¼˜åŒ–æˆæœ¬ã€‚è¿™ç¡®ä¿æ‚¨åªä½¿ç”¨æ‰€éœ€çš„èµ„æºï¼Œå‡å°‘ä¸å¿…è¦çš„æ”¯å‡ºã€‚

é€šè¿‡ä½¿ç”¨è¿™ç§æŠ€æœ¯ç»„åˆï¼Œæ‚¨å¯ä»¥åˆ©ç”¨åˆ†å¸ƒå¼è®­ç»ƒå’Œç¡¬ä»¶æ–¹é¢çš„æœ€æ–°è¿›å±•ï¼Œé«˜æ•ˆæœ‰æ•ˆåœ°é¢„è®­ç»ƒLlama-2ã€‚

### ä»€ä¹ˆæ˜¯Volcanoï¼Ÿ
Volcanoæ˜¯ä¸€ä¸ªå»ºç«‹åœ¨Kubernetesä¸Šçš„å¼€æºæ‰¹å¤„ç†è°ƒåº¦ç³»ç»Ÿï¼Œä¸“ä¸ºç®¡ç†é«˜æ€§èƒ½è®¡ç®—(HPC)å’Œæœºå™¨å­¦ä¹ å·¥ä½œè´Ÿè½½è€Œè®¾è®¡ã€‚å®ƒæä¾›äº†é«˜çº§è°ƒåº¦åŠŸèƒ½ï¼Œå¦‚å¸®æ´¾è°ƒåº¦ã€å…¬å¹³å…±äº«å’ŒæŠ¢å ï¼Œè¿™äº›å¯¹äºåœ¨Kubernetesç¯å¢ƒä¸­é«˜æ•ˆè¿è¡Œå¤§è§„æ¨¡åˆ†å¸ƒå¼è®­ç»ƒä½œä¸šè‡³å…³é‡è¦ã€‚

### Volcanoå¦‚ä½•ä¸å¸®æ´¾è°ƒåº¦ä¸€èµ·å·¥ä½œ
Volcanoçš„å¸®æ´¾è°ƒåº¦ç¡®ä¿ä½œä¸šï¼ˆæˆ–"å¸®æ´¾"ï¼‰ä¸­çš„æ‰€æœ‰podåŒæ—¶è°ƒåº¦ã€‚è¿™å¯¹äºåˆ†å¸ƒå¼è®­ç»ƒå·¥ä½œè´Ÿè½½è‡³å…³é‡è¦ï¼Œå…¶ä¸­å¤šä¸ªpodéœ€è¦ä¸€èµ·å¯åŠ¨æ‰èƒ½æ­£å¸¸è¿è¡Œã€‚å¦‚æœå¸®æ´¾ä¸­çš„ä»»ä½•ä¸€ä¸ªpodç”±äºèµ„æºé™åˆ¶è€Œæ— æ³•è°ƒåº¦ï¼Œå¸®æ´¾ä¸­çš„æ‰€æœ‰podéƒ½ä¸ä¼šå¯åŠ¨ã€‚è¿™é˜²æ­¢äº†éƒ¨åˆ†æ‰§è¡Œï¼Œå¹¶ç¡®ä¿åœ¨æ‰§è¡Œå¼€å§‹å‰æ‰€æœ‰ä½œä¸šæ‰€éœ€çš„èµ„æºéƒ½å¯ç”¨ã€‚

## 1. éƒ¨ç½²è§£å†³æ–¹æ¡ˆ
<CollapsibleContent header={<h2><span>å…ˆå†³æ¡ä»¶</span></h2>}>
    åœ¨æˆ‘ä»¬å¼€å§‹ä¹‹å‰ï¼Œè¯·ç¡®ä¿æ‚¨å·²ç»å‡†å¤‡å¥½æ‰€æœ‰å…ˆå†³æ¡ä»¶ï¼Œä»¥ä½¿éƒ¨ç½²è¿‡ç¨‹é¡ºåˆ©æ— å¿§ã€‚
    ç¡®ä¿æ‚¨å·²åœ¨EC2æˆ–Cloud9å®ä¾‹ä¸Šå®‰è£…äº†ä»¥ä¸‹å·¥å…·ã€‚

:::info

    * [EC2å®ä¾‹](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/EC2_GetStarted.html)æˆ–[Cloud9å®ä¾‹](https://docs.aws.amazon.com/cloud9/latest/user-guide/tutorial-create-environment.html) â†’ ç¡®ä¿ä¸¤ç§é€‰é¡¹éƒ½æœ‰100GB+çš„å­˜å‚¨ç©ºé—´ã€‚è¿™å¯¹äºåˆ›å»ºå…·æœ‰x86æ¶æ„çš„Dockeré•œåƒå¹¶æ‹¥æœ‰é€‚é‡å­˜å‚¨ç©ºé—´è‡³å…³é‡è¦ã€‚

    å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯æœ¬åœ°Windowsæœºå™¨æˆ–Macï¼Œè¯·ç¡®ä¿æœ¬åœ°å®‰è£…äº†Dockerï¼Œæ„å»ºå™¨å­˜å‚¨ç©ºé—´è¶…è¿‡100GBï¼Œå¹¶ä¸”é•œåƒæ˜¯ä½¿ç”¨x86æ¶æ„åˆ›å»ºçš„ã€‚

:::


    * [AWS CLI](https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html)
    * [kubectl](https://Kubernetes.io/docs/tasks/tools/)
    * [terraform](https://learn.hashicorp.com/tutorials/terraform/install-cli)

    è¦åœ¨EC2ä¸Šå®‰è£…æ‰€æœ‰å…ˆå†³æ¡ä»¶ï¼Œæ‚¨å¯ä»¥è¿è¡Œè¿™ä¸ª[è„šæœ¬](https://github.com/awslabs/data-on-eks/blob/main/ai-ml/trainium-inferentia/examples/llama2/install-pre-requsites-for-ec2.sh)ï¼Œå®ƒä¸Amazon Linux 2023å…¼å®¹ã€‚


    **å…‹éš†Data on EKSä»“åº“**

    ```bash
    git clone https://github.com/awslabs/data-on-eks.git
    ```

    **å¯¼èˆªåˆ°trainium-inferentiaç›®å½•ã€‚**

    ```bash
    cd data-on-eks/ai-ml/trainium-inferentia
    ```

   è®©æˆ‘ä»¬è¿è¡Œä»¥ä¸‹exportå‘½ä»¤æ¥è®¾ç½®ç¯å¢ƒå˜é‡ã€‚

:::info

    **æ³¨æ„ï¼š** æˆªè‡³2024/01/04ï¼ŒTrainiumå®ä¾‹ä»…åœ¨us-west-2ã€us-east-1å’Œus-east-2åŒºåŸŸå¯ç”¨ã€‚

:::


    ```bash
    # å¯ç”¨FSx for Lustreï¼Œå®ƒå°†é¢„è®­ç»ƒæ•°æ®æŒ‚è½½åˆ°è·¨å¤šä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰pod
    export TF_VAR_enable_fsx_for_lustre=true

    # æ ¹æ®æ‚¨çš„è¦æ±‚è®¾ç½®åŒºåŸŸã€‚æ£€æŸ¥æŒ‡å®šåŒºåŸŸä¸­Trn1å®ä¾‹çš„å¯ç”¨æ€§ã€‚
    export TF_VAR_region=us-west-2

    # ä½¿ç”¨KubeRay operatorå¯ç”¨Volcanoè‡ªå®šä¹‰è°ƒåº¦å™¨
    export TF_VAR_enable_volcano=true

    # æ³¨æ„ï¼šæ­¤é…ç½®å°†åˆ›å»ºä¸¤ä¸ªæ–°çš„Trn1 32xlå®ä¾‹ã€‚åœ¨ç»§ç»­ä¹‹å‰ï¼Œè¯·ç¡®ä¿éªŒè¯ç›¸å…³æˆæœ¬ã€‚
    export TF_VAR_trn1_32xl_min_size=2
    export TF_VAR_trn1_32xl_desired_size=2
    ```

    è¿è¡Œå®‰è£…è„šæœ¬ä»¥é…ç½®å…·æœ‰è§£å†³æ–¹æ¡ˆæ‰€éœ€çš„æ‰€æœ‰é™„åŠ ç»„ä»¶çš„EKSé›†ç¾¤ã€‚

    ```bash
    ./install.sh
    ```

    ### éªŒè¯èµ„æº

    éªŒè¯Amazon EKSé›†ç¾¤

    ```bash
    aws eks --region us-west-2 describe-cluster --name trainium-inferentia
    ```

    ```bash
    # åˆ›å»ºk8sé…ç½®æ–‡ä»¶ä»¥ä¸EKSè¿›è¡Œèº«ä»½éªŒè¯
    aws eks --region us-west-2 update-kubeconfig --name trainium-inferentia

    kubectl get nodes # è¾“å‡ºæ˜¾ç¤ºEKSæ‰˜ç®¡èŠ‚ç‚¹ç»„èŠ‚ç‚¹
    ```

</CollapsibleContent>

## 2. æ„å»ºDockeré•œåƒï¼ˆå¯é€‰æ­¥éª¤ï¼‰

ä¸ºäº†ç®€åŒ–è“å›¾éƒ¨ç½²ï¼Œæˆ‘ä»¬å·²ç»æ„å»ºäº†Dockeré•œåƒå¹¶åœ¨å…¬å…±ECRä¸‹æä¾›ã€‚
å¦‚æœæ‚¨æƒ³è‡ªå®šä¹‰Dockeré•œåƒï¼Œå¯ä»¥æ›´æ–°`Dockerfile`å¹¶æŒ‰ç…§å¯é€‰æ­¥éª¤æ„å»ºDockeré•œåƒã€‚
è¯·æ³¨æ„ï¼Œæ‚¨è¿˜éœ€è¦ä½¿ç”¨æ‚¨è‡ªå·±çš„ç§æœ‰ECRä¸­æ–°åˆ›å»ºçš„é•œåƒä¿®æ”¹RayCluster YAMLæ–‡ä»¶`llama2-pretrain-trn1-raycluster.yaml`ã€‚

```bash
cd gen-ai/training/raytrain-llama2-pretrain-trn1
./kuberay-trn1-llama2-pretrain-build-image.sh
```
è¿è¡Œæ­¤è„šæœ¬åï¼Œè®°ä¸‹ç”Ÿæˆçš„Dockeré•œåƒURLå’Œæ ‡ç­¾ã€‚
æ‚¨å°†åœ¨ä¸‹ä¸€æ­¥ä¸­éœ€è¦è¿™äº›ä¿¡æ¯ã€‚

## 3. ä½¿ç”¨KubeRay operatorå¯åŠ¨Rayé›†ç¾¤

å¦‚æœæ‚¨è·³è¿‡æ­¥éª¤2ï¼Œåˆ™æ— éœ€ä¿®æ”¹YAMLæ–‡ä»¶ã€‚
æ‚¨å¯ä»¥ç®€å•åœ°å¯¹æ–‡ä»¶è¿è¡Œ`kubectl apply`å‘½ä»¤ï¼Œå®ƒå°†ä½¿ç”¨æˆ‘ä»¬å‘å¸ƒçš„å…¬å…±ECRé•œåƒã€‚

å¦‚æœæ‚¨åœ¨**æ­¥éª¤2**ä¸­æ„å»ºäº†è‡ªå®šä¹‰Dockeré•œåƒï¼Œè¯·ä½¿ç”¨ä»ä¸Šä¸€æ­¥è·å¾—çš„Dockeré•œåƒURLå’Œæ ‡ç­¾æ›´æ–°`gen-ai/training/raytrain-llama2-pretrain-trn1/llama2-pretrain-trn1-raycluster.yaml`æ–‡ä»¶ã€‚

ä¸€æ—¦æ‚¨æ›´æ–°äº†YAMLæ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦ï¼‰ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤åœ¨æ‚¨çš„EKSé›†ç¾¤ä¸­å¯åŠ¨KubeRayé›†ç¾¤podï¼š

```bash
kubectl apply -f llama2-pretrain-trn1-raycluster.yaml
```

**éªŒè¯PodçŠ¶æ€ï¼š**

```bash
kubectl get pods -l "ray.io/cluster=kuberay-trn1"
```
### ä½¿ç”¨Volcanoè¿›è¡ŒRayå¤´éƒ¨å’Œå·¥ä½œèŠ‚ç‚¹Podçš„å¸®æ´¾è°ƒåº¦

åœ¨éƒ¨ç½²ç”¨äºè®­ç»ƒLlama2çš„Rayé›†ç¾¤çš„ä¸Šä¸‹æ–‡ä¸­ï¼ŒVolcanoå¯¹äºç¡®ä¿Rayå¤´éƒ¨å’Œå·¥ä½œèŠ‚ç‚¹podä¸€èµ·é«˜æ•ˆè°ƒåº¦è‡³å…³é‡è¦ã€‚
Rayå¤´éƒ¨podï¼Œé€šå¸¸è¿è¡Œåœ¨x86å®ä¾‹ä¸Šï¼Œåè°ƒåˆ†å¸ƒå¼è®­ç»ƒï¼Œè€Œå·¥ä½œèŠ‚ç‚¹podï¼Œè¿è¡Œåœ¨AWS Trainium (Trn1)å®ä¾‹ä¸Šï¼Œæ‰§è¡Œè®¡ç®—å¯†é›†å‹ä»»åŠ¡ã€‚
é€šè¿‡åˆ©ç”¨**Volcanoçš„å¸®æ´¾è°ƒåº¦**ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿å¤´éƒ¨å’Œæ‰€æœ‰å·¥ä½œèŠ‚ç‚¹podåŒæ—¶åˆ†é…å¿…è¦çš„èµ„æºï¼Œä½¿åˆ†å¸ƒå¼è®­ç»ƒä½œä¸šèƒ½å¤Ÿæ— å»¶è¿Ÿåœ°å¯åŠ¨ã€‚

ä»¥ä¸‹æ˜¯å°†Volcanoä¸ç”¨äºLlama2è®­ç»ƒçš„RayClusteré›†æˆçš„é…ç½®ç¤ºä¾‹ï¼š

:::info

æˆ‘ä»¬åœ¨æ­¤éƒ¨ç½²ä¸­ä½¿ç”¨é»˜è®¤å‘½åç©ºé—´ï¼Œå› ä¸º`fsx-claim` **PVC**æ˜¯ç”±Terraformè“å›¾åœ¨`default`å‘½åç©ºé—´ä¸‹åˆ›å»ºçš„ã€‚

å¦‚æœæ‚¨æƒ³åœ¨ä¸“ç”¨å‘½åç©ºé—´ä¸­éƒ¨ç½²é›†ç¾¤ï¼Œè¯·ç¡®ä¿FSX for Lustreæ–‡ä»¶ç³»ç»Ÿä¹Ÿåœ¨åŒä¸€å‘½åç©ºé—´ä¸­åˆ›å»ºï¼Œå› ä¸ºPVCæ˜¯å‘½åç©ºé—´ç»‘å®šçš„ã€‚

:::

```yaml
# Volcanoä¸KubeRayçš„æ–‡æ¡£ï¼šhttps://docs.ray.io/en/master/cluster/kubernetes/k8s-ecosystem/volcano.html
---
apiVersion: scheduling.volcano.sh/v1beta1
kind: Queue
metadata:
  name: llama2-training-queue
  namespace: default
spec:
  weight: 1
  capability:
    cpu: '500'
    memory: 1500Gi

---
apiVersion: ray.io/v1
kind: RayCluster
metadata:
  name: kuberay-trn1
  namespace: default
  labels:
    ray.io/scheduler-name: volcano
    volcano.sh/queue-name: llama2-training-queue
spec:
  rayVersion: 2.22.0
  headGroupSpec:
...
...
```

æ‚¨åº”è¯¥çœ‹åˆ°ä¸€ä¸ªray-head podå’Œä¸¤ä¸ªray-worker podå¤„äºRunningçŠ¶æ€ï¼š

:::warning

è¯·æ³¨æ„ï¼Œé•œåƒæ‹‰å–å’Œpodå‡†å¤‡å°±ç»ªå¯èƒ½éœ€è¦é•¿è¾¾10åˆ†é’Ÿçš„æ—¶é—´ã€‚

:::

```bash
NAME                                    READY   STATUS    RESTARTS   AGE
kuberay-trn1-head-67t46                 0/1     Pending   0          2m50s
kuberay-trn1-worker-workergroup-fz8bs   0/1     Pending   0          2m50s
kuberay-trn1-worker-workergroup-gpnxh   0/1     Pending   0          2m50s
```

æ£€æŸ¥å¤´éƒ¨podçš„æ—¥å¿—ï¼š

æŸ¥æ‰¾è¡¨æ˜Rayå¤´éƒ¨å·²å¯åŠ¨ä¸”é›†ç¾¤æ­£åœ¨è¿è¡Œçš„æ¶ˆæ¯ã€‚

```bash
kubectl logs kuberay-trn1-head-xxxxx
```

### è®¿é—®Rayä»ªè¡¨æ¿ï¼ˆç«¯å£è½¬å‘ï¼‰ï¼š
Rayä»ªè¡¨æ¿æä¾›äº†å…³äºé›†ç¾¤çŠ¶æ€å’Œä½œä¸šè¿›åº¦çš„å®è´µæ´å¯Ÿã€‚è¦è®¿é—®å®ƒï¼š

**è½¬å‘ç«¯å£ï¼š**

è¿™å°†ä»æ‚¨çš„æœ¬åœ°æœºå™¨åˆ°é›†ç¾¤å†…çš„å¤´éƒ¨podè½¬å‘Rayä»ªè¡¨æ¿ç«¯å£(8265)ã€‚

```bash
kubectl port-forward service/kuberay-trn1-head-svc 8265:8265
```

æ‰“å¼€æµè§ˆå™¨å¹¶åœ¨æ‚¨çš„ç½‘ç»œæµè§ˆå™¨ä¸­å¯¼èˆªåˆ°[http://localhost:8265](http://localhost:8265)ä»¥æŸ¥çœ‹ä»ªè¡¨æ¿ã€‚


## 4. åœ¨FSxå…±äº«æ–‡ä»¶ç³»ç»Ÿä¸Šç”Ÿæˆé¢„è®­ç»ƒæ•°æ®

:::warning

æ•°æ®ç”Ÿæˆæ­¥éª¤å¯èƒ½éœ€è¦é•¿è¾¾20åˆ†é’Ÿçš„æ—¶é—´ï¼Œä»¥åœ¨FSx for Lustreä¸­åˆ›å»ºæ‰€æœ‰æ•°æ®ã€‚

:::


åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬å°†åˆ©ç”¨KubeRayçš„ä½œä¸šè§„èŒƒæ¥å¯åŠ¨æ•°æ®ç”Ÿæˆè¿‡ç¨‹ã€‚æˆ‘ä»¬å°†ç›´æ¥å‘Rayå¤´éƒ¨podæäº¤ä½œä¸šã€‚è¿™ä¸ªä½œä¸šåœ¨ä¸ºæ‚¨çš„æ¨¡å‹å‡†å¤‡è®­ç»ƒæ–¹é¢èµ·ç€å…³é”®ä½œç”¨ã€‚

æŸ¥çœ‹ä¸‹é¢çš„`RayJob`å®šä¹‰è§„èŒƒï¼Œä½¿ç”¨`clusterSelector`åˆ©ç”¨ç°æœ‰RayClusterå‘RayClusteræäº¤ä½œä¸šã€‚

```yaml
# ----------------------------------------------------------------------------
# RayJob: llama2-generate-pretraining-test-data
#
# æè¿°ï¼š
# æ­¤RayJobè´Ÿè´£ç”ŸæˆLlama2æ¨¡å‹è®­ç»ƒæ‰€éœ€çš„é¢„è®­ç»ƒæµ‹è¯•æ•°æ®ã€‚å®ƒä»æŒ‡å®šçš„æ•°æ®é›†è·å–æ•°æ®ï¼Œ
# å¤„ç†å®ƒï¼Œå¹¶å‡†å¤‡ç”¨äºåç»­è®­ç»ƒé˜¶æ®µã€‚è¯¥ä½œä¸šè¿è¡Œä¸€ä¸ªPythonè„šæœ¬ï¼ˆ`get_dataset.py`ï¼‰ï¼Œ
# æ‰§è¡Œè¿™äº›æ•°æ®å‡†å¤‡æ­¥éª¤ã€‚

# ç”¨æ³•ï¼š
# ä½¿ç”¨`kubectl apply -f 1-llama2-pretrain-trn1-rayjob-create-test-data.yaml`å°†æ­¤é…ç½®åº”ç”¨åˆ°æ‚¨çš„Kubernetesé›†ç¾¤ã€‚
# ç¡®ä¿Rayé›†ç¾¤ï¼ˆ`kuberay-trn1`ï¼‰åœ¨æŒ‡å®šçš„å‘½åç©ºé—´ä¸­è¿è¡Œå¹¶å¯è®¿é—®ã€‚
# ----------------------------------------------------------------------------

apiVersion: ray.io/v1
kind: RayJob
metadata:
  name: llama2-generate-pretraining-test-data
  namespace: default
spec:
  submissionMode: K8sJobMode
  entrypoint: "python3 get_dataset.py"
  runtimeEnvYAML: |
    working_dir: /llama2_pretrain
    env_vars:
      PYTHONUNBUFFERED: '0'
    resources:
      requests:
        cpu: "6"
        memory: "30Gi"
  clusterSelector:
    ray.io/cluster: kuberay-trn1
    rayClusterNamespace: default  # æ›¿æ¢ä¸ºæ‚¨çš„RayClusteréƒ¨ç½²çš„å‘½åç©ºé—´
  ttlSecondsAfterFinished: 60  # å®Œæˆåpodçš„ç”Ÿå­˜æ—¶é—´ï¼ˆç§’ï¼‰
```

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿è¡Œæµ‹è¯•æ•°æ®åˆ›å»ºRayä½œä¸šï¼š


```bash
kubectl apply -f 1-llama2-pretrain-trn1-rayjob-create-test-data.yaml
```

**å¹•åå‘ç”Ÿçš„äº‹æƒ…ï¼š**

**ä½œä¸šå¯åŠ¨ï¼š** æ‚¨å°†ä½¿ç”¨kubectlæäº¤KubeRayä½œä¸šè§„èŒƒã€‚æ‚¨çš„`kuberay-trn1`é›†ç¾¤ä¸­çš„Rayå¤´éƒ¨podæ¥æ”¶å¹¶æ‰§è¡Œæ­¤ä½œä¸šã€‚

**æ•°æ®ç”Ÿæˆï¼š** è¯¥ä½œä¸šè¿è¡Œ`gen-ai/training/raytrain-llama2-pretrain-trn1/llama2_pretrain/get_dataset.py`è„šæœ¬ï¼Œè¯¥è„šæœ¬åˆ©ç”¨Hugging Faceæ•°æ®é›†åº“çš„å¼ºå¤§åŠŸèƒ½æ¥è·å–å’Œå¤„ç†åŸå§‹è‹±è¯­ç»´åŸºç™¾ç§‘æ•°æ®é›†ï¼ˆ"wikicorpus"ï¼‰ã€‚

**åˆ†è¯ï¼š** è¯¥è„šæœ¬ä½¿ç”¨æ¥è‡ªHugging Face transformersçš„é¢„è®­ç»ƒåˆ†è¯å™¨å¯¹æ–‡æœ¬è¿›è¡Œåˆ†è¯ã€‚åˆ†è¯å°†æ–‡æœ¬åˆ†è§£ä¸ºæ›´å°çš„å•å…ƒï¼ˆå•è¯æˆ–å­è¯ï¼‰ï¼Œä»¥ä¾¿æ¨¡å‹ç†è§£ã€‚

**æ•°æ®å­˜å‚¨ï¼š** åˆ†è¯åçš„æ•°æ®è¢«æ•´é½åœ°ç»„ç»‡å¹¶ä¿å­˜åˆ°FSx for Lustreå…±äº«æ–‡ä»¶ç³»ç»Ÿå†…çš„ç‰¹å®šç›®å½•ï¼ˆ`/shared/wikicorpus_llama2_7B_tokenized_4k/`ï¼‰ã€‚è¿™ç¡®ä¿é›†ç¾¤ä¸­çš„æ‰€æœ‰å·¥ä½œèŠ‚ç‚¹åœ¨é¢„è®­ç»ƒæœŸé—´éƒ½å¯ä»¥è½»æ¾è®¿é—®è¿™äº›æ ‡å‡†åŒ–æ•°æ®ã€‚

### ç›‘æ§ä½œä¸šï¼š

è¦è·Ÿè¸ªä½œä¸šçš„è¿›åº¦ï¼š

**Rayä»ªè¡¨æ¿**ï¼šå‰å¾€Rayä»ªè¡¨æ¿ï¼Œå¯é€šè¿‡Rayå¤´éƒ¨podçš„IPåœ°å€å’Œç«¯å£8265è®¿é—®ã€‚æ‚¨å°†çœ‹åˆ°å…³äºä½œä¸šçŠ¶æ€çš„å®æ—¶æ›´æ–°ã€‚


![å‡†å¤‡æ•°æ®é›†](../../../../../../../docs/gen-ai/training/img/raytrain-testdata-raydash1.png)

![å‡†å¤‡æ•°æ®é›†](../../../../../../../docs/gen-ai/training/img/raytrain-testdata-raydash2.png)

![å‡†å¤‡æ•°æ®é›†](../../../../../../../docs/gen-ai/training/img/raytrain-testdata-raydash3.png)

æˆ–è€…ï¼Œæ‚¨å¯ä»¥åœ¨ç»ˆç«¯ä¸­ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
kubectl get pods | grep llama2
```

**è¾“å‡ºï¼š**

```
llama2-generate-pretraining-test-data-g6ccl   1/1     Running   0             5m5s
```

ä»¥ä¸‹æˆªå›¾æ¥è‡ªLens K8s IDEï¼Œæ˜¾ç¤ºäº†podçš„æ—¥å¿—ã€‚

![å‡†å¤‡æ•°æ®é›†](../../../../../../../docs/gen-ai/training/img/raytrain-testdata-lens.png)

## 5. è¿è¡Œé¢„ç¼–è¯‘ä½œä¸šï¼ˆä¼˜åŒ–æ­¥éª¤ï¼‰

:::info

é¢„ç¼–è¯‘ä½œä¸šå¯èƒ½éœ€è¦é•¿è¾¾6åˆ†é’Ÿ

:::

åœ¨å¼€å§‹å®é™…è®­ç»ƒä¹‹å‰ï¼Œæˆ‘ä»¬å°†æ‰§è¡Œé¢„ç¼–è¯‘æ­¥éª¤ï¼Œä»¥ä¼˜åŒ–æ¨¡å‹ä»¥é€‚åº”Neuron SDKã€‚è¿™æœ‰åŠ©äºæ¨¡å‹åœ¨`Trn1`å®ä¾‹ä¸Šæ›´é«˜æ•ˆåœ°è¿è¡Œã€‚æ­¤è„šæœ¬å°†ä½¿ç”¨Neuron SDKç¼–è¯‘å’Œä¼˜åŒ–æ¨¡å‹çš„è®¡ç®—å›¾ï¼Œä½¿å…¶å‡†å¤‡å¥½åœ¨Trn1å¤„ç†å™¨ä¸Šè¿›è¡Œé«˜æ•ˆè®­ç»ƒã€‚

åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæ‚¨å°†è¿è¡Œä¸€ä¸ªé¢„ç¼–è¯‘ä½œä¸šï¼Œå…¶ä¸­Neuron SDKå°†è¯†åˆ«ã€ç¼–è¯‘å’Œç¼“å­˜ä¸`Llama2`é¢„è®­ç»ƒç›¸å…³çš„è®¡ç®—å›¾ã€‚

æŸ¥çœ‹ä¸‹é¢çš„`RayJob`å®šä¹‰è§„èŒƒï¼Œä»¥è¿è¡Œé¢„ç¼–è¯‘ä½œä¸šï¼š
```yaml
# ----------------------------------------------------------------------------
# RayJob: llama2-precompilation-job
#
# æè¿°ï¼š
# æ­¤RayJobè´Ÿè´£Llama2æ¨¡å‹è®­ç»ƒæ‰€éœ€çš„é¢„ç¼–è¯‘æ­¥éª¤ã€‚å®ƒè¿è¡Œä¸€ä¸ªPythonè„šæœ¬ï¼ˆ`ray_train_llama2.py`ï¼‰ï¼Œ
# å¸¦æœ‰`--neuron_parallel_compile`é€‰é¡¹ï¼Œä½¿ç”¨AWS Neuronè®¾å¤‡å¹¶è¡Œç¼–è¯‘æ¨¡å‹ã€‚è¿™ä¸€æ­¥å¯¹äº
# ä¼˜åŒ–æ¨¡å‹ä»¥åœ¨AWSåŸºç¡€è®¾æ–½ä¸Šè¿›è¡Œé«˜æ•ˆè®­ç»ƒè‡³å…³é‡è¦ã€‚

# ç”¨æ³•ï¼š
# ä½¿ç”¨`kubectl apply -f 2-llama2-pretrain-trn1-rayjob-precompilation.yaml`å°†æ­¤é…ç½®åº”ç”¨åˆ°æ‚¨çš„Kubernetesé›†ç¾¤ã€‚
# ç¡®ä¿Rayé›†ç¾¤ï¼ˆ`kuberay-trn1`ï¼‰åœ¨æŒ‡å®šçš„å‘½åç©ºé—´ä¸­è¿è¡Œå¹¶å¯è®¿é—®ã€‚
# ----------------------------------------------------------------------------

---
apiVersion: ray.io/v1
kind: RayJob
metadata:
  name: llama2-precompilation-job
  namespace: default
spec:
  submissionMode: K8sJobMode
  entrypoint: "NEURON_NUM_DEVICES=32 python3 /llama2_pretrain/ray_train_llama2.py --neuron_parallel_compile"
  runtimeEnvYAML: |
    working_dir: /llama2_pretrain
    env_vars:
      PYTHONUNBUFFERED: '0'
  clusterSelector:
    ray.io/cluster: kuberay-trn1
    rayClusterNamespace: default  # æ›¿æ¢ä¸ºæ‚¨çš„RayClusteréƒ¨ç½²çš„å‘½åç©ºé—´
  ttlSecondsAfterFinished: 60  # å®Œæˆåpodçš„ç”Ÿå­˜æ—¶é—´ï¼ˆç§’ï¼‰
```

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿è¡Œé¢„ç¼–è¯‘ä½œä¸šï¼š

```bash
kubectl apply -f 2-llama2-pretrain-trn1-rayjob-precompilation.yaml
```

**éªŒè¯æ­¥éª¤ï¼š**

è¦ç›‘æ§ä½œä¸šçš„è¿›åº¦å¹¶éªŒè¯å…¶æ˜¯å¦æ­£ç¡®è¿è¡Œï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å’Œå·¥å…·ï¼š

**Rayä»ªè¡¨æ¿ï¼š** é€šè¿‡Rayå¤´éƒ¨podçš„IPåœ°å€å’Œç«¯å£`8265`è®¿é—®Rayä»ªè¡¨æ¿ï¼ŒæŸ¥çœ‹å…³äºä½œä¸šçŠ¶æ€çš„å®æ—¶æ›´æ–°ã€‚

![é¢„ç¼–è¯‘è¿›åº¦](../../../../../../../docs/gen-ai/training/img/raytrain-precomplilation1.png)

![é¢„ç¼–è¯‘è¿›åº¦](../../../../../../../docs/gen-ai/training/img/raytrain-precomplilation2.png)

ä»¥ä¸‹æˆªå›¾æ¥è‡ªLens K8s IDEï¼Œæ˜¾ç¤ºäº†podçš„æ—¥å¿—ã€‚

![é¢„ç¼–è¯‘è¿›åº¦](../../../../../../../docs/gen-ai/training/img/raytrain-precomplilation3.png)

## 6. è¿è¡Œåˆ†å¸ƒå¼é¢„è®­ç»ƒä½œä¸š

:::warning

æ­¤ä½œä¸šå¯èƒ½è¿è¡Œæ•°å°æ—¶ï¼Œå› æ­¤ä¸€æ—¦æ‚¨ç¡®ä¿¡æŸå¤±æ­£åœ¨å‡å°‘ä¸”æ¨¡å‹æ­£åœ¨å­¦ä¹ ï¼Œå¯ä»¥éšæ—¶ä½¿ç”¨Ctrl+Cå–æ¶ˆä½œä¸šã€‚

:::

ç°åœ¨ï¼Œæ‚¨å·²å‡†å¤‡å¥½å¼€å§‹å®é™…è®­ç»ƒLlama 2æ¨¡å‹ï¼æ­¤æ­¥éª¤æ¶‰åŠä½¿ç”¨RayJobè¿è¡Œåˆ†å¸ƒå¼é¢„è®­ç»ƒä½œä¸šã€‚è¯¥ä½œä¸šå°†åˆ©ç”¨AWS Neuronè®¾å¤‡é«˜æ•ˆåœ°ä½¿ç”¨å‡†å¤‡å¥½çš„æ•°æ®é›†è®­ç»ƒæ¨¡å‹ã€‚

æŸ¥çœ‹ä¸‹é¢çš„`RayJob`å®šä¹‰è§„èŒƒï¼Œä»¥è¿è¡Œé¢„è®­ç»ƒä½œä¸šï¼š

```yaml
# ----------------------------------------------------------------------------
# RayJob: llama2-pretraining-job
#
# æè¿°ï¼š
# æ­¤RayJobè´Ÿè´£Llama2æ¨¡å‹çš„ä¸»è¦é¢„è®­ç»ƒæ­¥éª¤ã€‚
# å®ƒè¿è¡Œä¸€ä¸ªPythonè„šæœ¬ï¼ˆ`ray_train_llama2.py`ï¼‰ä½¿ç”¨AWS Neuronè®¾å¤‡æ‰§è¡Œé¢„è®­ç»ƒã€‚
# è¿™ä¸€æ­¥å¯¹äºä½¿ç”¨å‡†å¤‡å¥½çš„æ•°æ®é›†è®­ç»ƒè¯­è¨€æ¨¡å‹è‡³å…³é‡è¦ã€‚

# ç”¨æ³•ï¼š
# ä½¿ç”¨`kubectl apply -f 3-llama2-pretrain-trn1-rayjob.yaml`å°†æ­¤é…ç½®åº”ç”¨åˆ°æ‚¨çš„Kubernetesé›†ç¾¤ã€‚
# ç¡®ä¿Rayé›†ç¾¤ï¼ˆ`kuberay-trn1`ï¼‰åœ¨æŒ‡å®šçš„å‘½åç©ºé—´ä¸­è¿è¡Œå¹¶å¯è®¿é—®ã€‚
# ----------------------------------------------------------------------------

---
apiVersion: ray.io/v1
kind: RayJob
metadata:
  name: llama2-pretraining-job
  namespace: default
spec:
  submissionMode: K8sJobMode
  entrypoint: "NEURON_NUM_DEVICES=32 python3 ray_train_llama2.py"
  runtimeEnvYAML: |
    working_dir: /llama2_pretrain
    env_vars:
      PYTHONUNBUFFERED: '0'
  clusterSelector:
    ray.io/cluster: kuberay-trn1
    rayClusterNamespace: default  # æ›¿æ¢ä¸ºæ‚¨çš„RayClusteréƒ¨ç½²çš„å‘½åç©ºé—´
  shutdownAfterJobFinishes: true
  activeDeadlineSeconds: 600   # å¦‚æœä½œä¸šè¿è¡Œæ—¶é—´è¶…è¿‡600ç§’ï¼ˆ10åˆ†é’Ÿï¼‰ï¼Œå°†è¢«ç»ˆæ­¢
  ttlSecondsAfterFinished: 60  # å®Œæˆåpodçš„ç”Ÿå­˜æ—¶é—´ï¼ˆç§’ï¼‰
```
æ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿è¡Œé¢„è®­ç»ƒä½œä¸šï¼š

```bash
kubectl apply -f 3-llama2-pretrain-trn1-rayjob.yaml
```

**ç›‘æ§è¿›åº¦ï¼š**

æ‚¨å¯ä»¥ä½¿ç”¨Rayä»ªè¡¨æ¿æˆ–é€šè¿‡è§‚å¯Ÿè¾“å‡ºåˆ°ç»ˆç«¯çš„æ—¥å¿—æ¥ç›‘æ§è®­ç»ƒä½œä¸šçš„è¿›åº¦ã€‚æŸ¥æ‰¾è¯¸å¦‚è®­ç»ƒæŸå¤±ã€å­¦ä¹ ç‡å’Œå…¶ä»–æŒ‡æ ‡ç­‰ä¿¡æ¯ï¼Œä»¥è¯„ä¼°æ¨¡å‹å­¦ä¹ çš„æƒ…å†µã€‚

![è®­ç»ƒè¿›åº¦](../../../../../../../docs/gen-ai/training/img/raytrain-training-progress1.png)

**Rayä»ªè¡¨æ¿ï¼š** é€šè¿‡Rayå¤´éƒ¨podçš„IPåœ°å€å’Œç«¯å£8265è®¿é—®Rayä»ªè¡¨æ¿ï¼ŒæŸ¥çœ‹å…³äºä½œä¸šçŠ¶æ€çš„å®æ—¶æ›´æ–°ã€‚

![Rayä»ªè¡¨æ¿è®­ç»ƒè¿›åº¦](../../../../../../../docs/gen-ai/training/img/raytrain-training-progress2.png)

![Rayä»ªè¡¨æ¿è®­ç»ƒè¿›åº¦](../../../../../../../docs/gen-ai/training/img/raytrain-training-progress3.png)


### æ¸…ç†

è¦åˆ é™¤ä½¿ç”¨æ­¤è§£å†³æ–¹æ¡ˆåˆ›å»ºçš„èµ„æºï¼Œè¯·è¿è¡Œæ¸…ç†è„šæœ¬ï¼š

```bash
# åˆ é™¤RayClusterèµ„æºï¼š
cd gen-ai/training/raytrain-llama2-pretrain-trn1
kubectl delete -f llama2-pretrain-trn1-raycluster.yaml

# æ¸…ç†EKSé›†ç¾¤å’Œç›¸å…³èµ„æºï¼š
cd data-on-eks/ai-ml/trainium-inferentia
./cleanup.sh
```
