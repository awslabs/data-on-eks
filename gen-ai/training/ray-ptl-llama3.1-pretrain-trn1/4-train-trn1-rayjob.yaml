# ----------------------------------------------------------------------------
# RayJob: llama3-pretraining-job
#
# Description:
# This RayJob is responsible for the main pretraining step of the Llama3 model. It runs a
# Python script (`ray_train_llama3.py`) to perform the pretraining using AWS Neuron devices.
# This step is critical for training the language model with the prepared dataset.

# Usage:
# Apply this configuration to your Kubernetes cluster using `kubectl apply -f 4-grammarly-train-trn1-rayjob.yaml`.
# Ensure that the Ray cluster (`kuberay-trn1`) is running and accessible in the specified namespace.
# Uncomment the fields if you want the job to shut down after finishing or if you want to set a maximum runtime.
# ----------------------------------------------------------------------------

---
apiVersion: ray.io/v1
kind: RayJob
metadata:
  name: llama3.1-training-job
spec:
  submissionMode: K8sJobMode
  entrypoint: "NEURON_NUM_DEVICES=32 bash run_llama3.1_8b.sh -w 500 -n 16 -l 4e-4 -s 8192"
  runtimeEnvYAML: |
    working_dir: /grammarly_pretraining
  clusterSelector:
    ray.io/cluster: kuberay-trn1
    rayClusterNamespace: default  # Replace with the namespace where your RayCluster is deployed
  shutdownAfterJobFinishes: true
  ttlSecondsAfterFinished: 60  # Time to live for the pod after completion (in seconds)
