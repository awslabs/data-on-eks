apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: default-affinity
spec:
  rules:
    - name: set-default-affinity-to-controllers
      match:
        resources:
          kinds:
            - Deployment
            - StatefulSet
            - DaemonSet
            - Pod
      exclude:
        resources:
          selector:
            matchLabels:
              kyverno.io/skip-affinity: "true"
      mutate:
        patchStrategicMerge:
          spec:
            template:
              spec:
                affinity:
                  nodeAffinity:
                    requiredDuringSchedulingIgnoredDuringExecution:
                      nodeSelectorTerms:
                        - matchExpressions:
                            - key: karpenter.sh/capacity-type
                              operator: NotIn
                              values:
                                - on-demand

    - name: set-default-affinity-to-pods
      match:
        resources:
          kinds:
            - Pod
      exclude:
        resources:
          selector:
            matchLabels:
              kyverno.io/skip-affinity: "true"
      mutate:
        patchStrategicMerge:
          spec:
            affinity:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                    - matchExpressions:
                        - key: karpenter.sh/capacity-type
                          operator: NotIn
                          values:
                            - on-demand