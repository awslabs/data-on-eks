"use strict";(self.webpackChunkdoeks_website=self.webpackChunkdoeks_website||[]).push([[4857],{1896:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>r,toc:()=>l});var a=t(4848),s=t(8453);t(2450);const i={title:"Preload container images into data volumes",sidebar_position:2},o="Preload container images into data volumes with EBS Snapshots",r={id:"bestpractices/preload-container-images",title:"Preload container images into data volumes",description:"The purpose of this pattern is to reduce the cold start time of containers with large images by caching the images in the data volume of Bottlerocket OS.",source:"@site/docs/bestpractices/preload-container-images.md",sourceDirName:"bestpractices",slug:"/bestpractices/preload-container-images",permalink:"/data-on-eks/docs/bestpractices/preload-container-images",draft:!1,unlisted:!1,editUrl:"https://github.com/awslabs/data-on-eks/blob/main/website/docs/bestpractices/preload-container-images.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{title:"Preload container images into data volumes",sidebar_position:2},sidebar:"bestpractices",previous:{title:"EKS Best Practices",permalink:"/data-on-eks/docs/bestpractices/eks-best-practices/"},next:{title:"EMR on EKS Best Practices",permalink:"/data-on-eks/docs/bestpractices/emr-on-eks/"}},c={},l=[{value:"Overview of this script",id:"overview-of-this-script",level:2},{value:"Usage Example",id:"usage-example",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"preload-container-images-into-data-volumes-with-ebs-snapshots",children:"Preload container images into data volumes with EBS Snapshots"})}),"\n",(0,a.jsx)(n.p,{children:"The purpose of this pattern is to reduce the cold start time of containers with large images by caching the images in the data volume of Bottlerocket OS."}),"\n",(0,a.jsx)(n.p,{children:"Data analytics and machine learning workloads often require large container images (usually measured by Gigabytes), which can take several minutes to pull and extract from Amazon ECR or other image registry. Reduce image pulling time is the key of improving speed of launching these containers."}),"\n",(0,a.jsx)(n.p,{children:"Bottlerocket OS is a Linux-based open-source operating system built by AWS specifically for running containers. It has two volumes, an OS volume and a data volume, with the latter used for storing artifacts and container images. This sample will leverage the data volume to pull images and take snapshots for later usage."}),"\n",(0,a.jsx)(n.p,{children:"To demonstrate the process of caching images in EBS snapshots and launching them in an EKS cluster, this sample will use Amazon EKS optimized Bottlerocket AMIs."}),"\n",(0,a.jsx)(n.p,{children:"For details, refer to the GitHub sample and blog post:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://github.com/aws-samples/bottlerocket-images-cache/tree/main",children:"GitHub - Caching Container Images for AWS Bottlerocket Instances"})}),"\n",(0,a.jsx)(n.li,{children:(0,a.jsx)(n.a,{href:"https://aws.amazon.com/blogs/containers/reduce-container-startup-time-on-amazon-eks-with-bottlerocket-data-volume/",children:"Blog Post - Reduce container startup time on Amazon EKS with Bottlerocket data volume"})}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"overview-of-this-script",children:"Overview of this script"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:t(3560).A+"",width:"982",height:"397"})}),"\n",(0,a.jsxs)(n.ol,{children:["\n",(0,a.jsx)(n.li,{children:"Launch an EC2 instance with Bottlerocket for EKS AMI."}),"\n",(0,a.jsx)(n.li,{children:"Access to instance via Amazon System Manager"}),"\n",(0,a.jsx)(n.li,{children:"Pull images to be cached in this EC2 using Amazon System Manager Run Command."}),"\n",(0,a.jsx)(n.li,{children:"Shut down the instance, build the EBS snapshot for the data volume."}),"\n",(0,a.jsx)(n.li,{children:"Terminate the instance."}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"usage-example",children:"Usage Example"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"git clone https://github.com/aws-samples/bottlerocket-images-cache/\ncd bottlerocket-images-cache/\n\n# Using nohup in terminals to avoid disconnections\n\u276f nohup ./snapshot.sh --snapshot-size 150 -r us-west-2 \\\n  docker.io/rayproject/ray-ml:2.10.0-py310-gpu,public.ecr.aws/data-on-eks/ray2.11.0-py310-gpu-stablediffusion:latest &\n\n\u276f tail -f nohup.out\n\n2024-07-15 17:18:53 I - [1/8] Deploying EC2 CFN stack ...\n2024-07-15 17:22:07 I - [2/8] Launching SSM .\n2024-07-15 17:22:08 I - SSM launched in instance i-07d10182abc8a86e1.\n2024-07-15 17:22:08 I - [3/8] Stopping kubelet.service ..\n2024-07-15 17:22:10 I - Kubelet service stopped.\n2024-07-15 17:22:10 I - [4/8] Cleanup existing images ..\n2024-07-15 17:22:12 I - Existing images cleaned\n2024-07-15 17:22:12 I - [5/8] Pulling images:\n2024-07-15 17:22:12 I - Pulling docker.io/rayproject/ray-ml:2.10.0-py310-gpu - amd64 ...\n2024-07-15 17:27:50 I - docker.io/rayproject/ray-ml:2.10.0-py310-gpu - amd64 pulled.\n2024-07-15 17:27:50 I - Pulling docker.io/rayproject/ray-ml:2.10.0-py310-gpu - arm64 ...\n2024-07-15 17:27:58 I - docker.io/rayproject/ray-ml:2.10.0-py310-gpu - arm64 pulled.\n2024-07-15 17:27:58 I - Pulling public.ecr.aws/data-on-eks/ray2.11.0-py310-gpu-stablediffusion:latest - amd64 ...\n2024-07-15 17:31:34 I - public.ecr.aws/data-on-eks/ray2.11.0-py310-gpu-stablediffusion:latest - amd64 pulled.\n2024-07-15 17:31:34 I - Pulling public.ecr.aws/data-on-eks/ray2.11.0-py310-gpu-stablediffusion:latest - arm64 ...\n2024-07-15 17:31:36 I - public.ecr.aws/data-on-eks/ray2.11.0-py310-gpu-stablediffusion:latest - arm64 pulled.\n2024-07-15 17:31:36 I - [6/8] Stopping instance ...\n2024-07-15 17:32:25 I - Instance i-07d10182abc8a86e1 stopped\n2024-07-15 17:32:25 I - [7/8] Creating snapshot ...\n2024-07-15 17:38:36 I - Snapshot snap-0c6d965cf431785ed generated.\n2024-07-15 17:38:36 I - [8/8] Cleanup.\n2024-07-15 17:38:37 I - Stack deleted.\n2024-07-15 17:38:37 I - --------------------------------------------------\n2024-07-15 17:38:37 I - All done! Created snapshot in us-west-2: snap-0c6d965cf431785ed\n"})}),"\n",(0,a.jsxs)(n.p,{children:["You can copy the snapshot ID ",(0,a.jsx)(n.code,{children:"snap-0c6d965cf431785ed"})," and configure it as a snapshot for worker nodes."]}),"\n",(0,a.jsx)(n.h1,{id:"using-snapshot-with-amazon-eks-and-karpenter",children:"Using Snapshot with Amazon EKS and Karpenter"}),"\n",(0,a.jsxs)(n.p,{children:["You can specify ",(0,a.jsx)(n.code,{children:"snapshotID"})," in a Karpenter node class. Add the content on EC2NodeClass:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'apiVersion: karpenter.k8s.aws/v1beta1\nkind: EC2NodeClass\nmetadata:\n  name: default\nspec:\n  amiFamily: Bottlerocket # Ensure OS is BottleRocket\n  blockDeviceMappings:\n    - deviceName: /dev/xvdb\n      ebs:\n        volumeSize: 150Gi\n        volumeType: gp3\n        kmsKeyID: "arn:aws:kms:<REGION>:<ACCOUNT_ID>:key/1234abcd-12ab-34cd-56ef-1234567890ab" # Specify KMS ID if you use custom KMS key\n        snapshotID: snap-0123456789 # Specify your snapshot ID here\n'})}),"\n",(0,a.jsx)(n.h1,{id:"end-to-end-deployment-example",children:"End-to-End deployment example"}),"\n",(0,a.jsxs)(n.p,{children:["An end-to-end deployment example can be found in ",(0,a.jsx)(n.a,{href:"../gen-ai/inference/GPUs/stablediffusion-gpus",children:"Stable Diffusion on GPU"}),"."]})]})}function p(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},2450:(e,n,t)=>{t.d(n,{A:()=>m});var a=t(6540),s=t(5556),i=t.n(s),o=t(4164);const r="collapsibleContent_q3kw",c="header_QCEw",l="icon_PckA",d="content_qLC1",p="expanded_iGsi";var h=t(4848);function u(e){let{children:n,header:t}=e;const[s,i]=(0,a.useState)(!1);return(0,h.jsxs)("div",{className:r,children:[(0,h.jsxs)("div",{className:(0,o.A)(c,{[p]:s}),onClick:()=>{i(!s)},children:[t,(0,h.jsx)("span",{className:(0,o.A)(l,{[p]:s}),children:s?"\ud83d\udc47":"\ud83d\udc48"})]}),s&&(0,h.jsx)("div",{className:d,children:n})]})}u.propTypes={children:i().node.isRequired,header:i().node.isRequired};const m=u},3560:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/bottlerocket-image-cache-01a6d2697a4d32162324356163f97861.png"},8453:(e,n,t)=>{t.d(n,{R:()=>o,x:()=>r});var a=t(6540);const s={},i=a.createContext(s);function o(e){const n=a.useContext(i);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),a.createElement(i.Provider,{value:n},e.children)}}}]);