<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-benchmarks/spark-gluten-velox-benchmark" data-has-hydrated=false><head><meta charset=UTF-8><meta name=generator content="Docusaurus v3.9.0"><title data-rh=true>Apache Spark with Apache Gluten + Velox Benchmarks | Data on EKS</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"/><meta data-rh=true name=twitter:card content=summary_large_image /><meta data-rh=true property=og:url content=https://awslabs.github.io/data-on-eks/docs/benchmarks/spark-gluten-velox-benchmark /><meta data-rh=true property=og:locale content=en /><meta data-rh=true name=docusaurus_locale content=en /><meta data-rh=true name=docsearch:language content=en /><meta data-rh=true name=docusaurus_version content=current /><meta data-rh=true name=docusaurus_tag content=docs-default-current /><meta data-rh=true name=docsearch:version content=current /><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current /><meta data-rh=true property=og:title content="Apache Spark with Apache Gluten + Velox Benchmarks | Data on EKS"/><meta data-rh=true name=description content="Apache Spark powers much of today‚Äôs large-scale analytics, but its default SQL engine is still JVM-bound and row-oriented. Even with Project Tungsten‚Äôs code generation and vectorized readers, operators often pay heavy costs for Java object creation, garbage collection, and row-to-column conversions. These costs become visible on analytic workloads that scan large Parquet or ORC tables, perform wide joins, or run memory-intensive aggregations‚Äîleading to slower queries and inefficient CPU use."/><meta data-rh=true property=og:description content="Apache Spark powers much of today‚Äôs large-scale analytics, but its default SQL engine is still JVM-bound and row-oriented. Even with Project Tungsten‚Äôs code generation and vectorized readers, operators often pay heavy costs for Java object creation, garbage collection, and row-to-column conversions. These costs become visible on analytic workloads that scan large Parquet or ORC tables, perform wide joins, or run memory-intensive aggregations‚Äîleading to slower queries and inefficient CPU use."/><link data-rh=true rel=icon href=/data-on-eks/img/header-icon.png /><link data-rh=true rel=canonical href=https://awslabs.github.io/data-on-eks/docs/benchmarks/spark-gluten-velox-benchmark /><link data-rh=true rel=alternate href=https://awslabs.github.io/data-on-eks/docs/benchmarks/spark-gluten-velox-benchmark hreflang=en /><link data-rh=true rel=alternate href=https://awslabs.github.io/data-on-eks/docs/benchmarks/spark-gluten-velox-benchmark hreflang=x-default /><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://awslabs.github.io/data-on-eks/docs/benchmarks/spark-gluten-velox-benchmark","name":"Apache Spark with Gluten + Velox Benchmarks","position":1}]}</script><link rel=stylesheet href=/data-on-eks/assets/css/styles.1dd1ab63.css /><script src=/data-on-eks/assets/js/runtime~main.8ff5812d.js defer></script><script src=/data-on-eks/assets/js/main.133b39ee.js defer></script></head><body class=navigation-with-keyboard><svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/data-on-eks/><div class=navbar__logo><img src=/data-on-eks/img/header-icon.png alt="DoEKS Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"/><img src=/data-on-eks/img/header-icon.png alt="DoEKS Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"/></div></a><a class="navbar__item navbar__link" href=/data-on-eks/docs/blueprints/data-analytics>Blueprints</a><a class="navbar__item navbar__link" href=/data-on-eks/docs/bestpractices/intro>Best Practices</a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/data-on-eks/docs/benchmarks/emr-on-eks>Benchmarks</a><a class="navbar__item navbar__link" href=/data-on-eks/docs/resources/intro>Resources</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href=https://github.com/awslabs/data-on-eks target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-label="(opens in new tab)" class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill=currentColor d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"/></svg></button></div><div class=navbarSearchContainer_Bca1><div class=navbar__search><span aria-label="expand searchbar" role=button class=search-icon tabindex=0></span><input id=search_input_react type=search placeholder=Loading... aria-label=Search class="navbar__search-input search-bar" disabled/></div></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/data-on-eks/docs/benchmarks/emr-on-eks><span title="EMR on EKS Benchmarks" class=linkLabel_WmDU>EMR on EKS Benchmarks</span></a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_byQd menu__link menu__link--sublist" href=/data-on-eks/docs/category/spark-benchmarks><span title="Spark Benchmarks" class=categoryLinkLabel_W154>Spark Benchmarks</span></a><button aria-label="Expand sidebar category 'Spark Benchmarks'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/data-on-eks/docs/benchmarks/spark-operator-eks-benchmark><span title="Kubeflow Spark Operator Benchmarks" class=linkLabel_WmDU>Kubeflow Spark Operator Benchmarks</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current=page href=/data-on-eks/docs/benchmarks/spark-gluten-velox-benchmark><span title="Apache Spark with Gluten + Velox Benchmarks" class=linkLabel_WmDU>Apache Spark with Gluten + Velox Benchmarks</span></a></ul></nav><button type=button title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width=20 height=20 aria-hidden=true class=collapseSidebarButtonIcon_kv0_><g fill=#7a7a7a><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"/><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"/></g></svg></button></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=Breadcrumbs><ul class=breadcrumbs><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/data-on-eks/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link>Apache Spark with Gluten + Velox Benchmarks</span></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Apache Spark with Apache Gluten + Velox Benchmarks</h1></header>
<p><a href=https://spark.apache.org/ target=_blank rel="noopener noreferrer">Apache Spark</a> powers much of today‚Äôs large-scale analytics, but its default SQL engine is still JVM-bound and row-oriented. Even with <a href=https://spark.apache.org/docs/latest/sql-performance-tuning.html#project-tungsten target=_blank rel="noopener noreferrer">Project Tungsten</a>‚Äôs code generation and vectorized readers, operators often pay heavy costs for Java object creation, garbage collection, and row-to-column conversions. These costs become visible on analytic workloads that scan large <a href=https://parquet.apache.org/ target=_blank rel="noopener noreferrer">Parquet</a> or <a href=https://orc.apache.org/ target=_blank rel="noopener noreferrer">ORC</a> tables, perform wide joins, or run memory-intensive aggregations‚Äîleading to slower queries and inefficient CPU use.</p>
<p>Modern C++ engines such as <a href=https://github.com/facebookincubator/velox target=_blank rel="noopener noreferrer">Velox</a>, <a href=https://clickhouse.com/ target=_blank rel="noopener noreferrer">ClickHouse</a>, and <a href=https://duckdb.org/ target=_blank rel="noopener noreferrer">DuckDB</a> show that SIMD-optimized, cache-aware vectorization can process the same data far faster. But replacing Spark is impractical given its ecosystem and scheduling model. <a href=https://github.com/apache/incubator-gluten target=_blank rel="noopener noreferrer">Apache Gluten</a> solves this by translating <a href=https://spark.apache.org/sql/ target=_blank rel="noopener noreferrer">Spark SQL</a> plans into the open <a href=https://substrait.io/ target=_blank rel="noopener noreferrer">Substrait</a> IR and offloading execution to a native C++ backend (Velox, ClickHouse, etc.). This approach keeps Spark‚Äôs APIs and <a href=https://kubernetes.io/ target=_blank rel="noopener noreferrer">Kubernetes</a> deployment model while accelerating the CPU-bound SQL layer‚Äîthe focus of this deep dive and benchmark study on <a href=https://aws.amazon.com/eks/ target=_blank rel="noopener noreferrer">Amazon EKS</a>.</p>
<p>In this guide you will:</p>
<ul>
<li>Understand how the Spark + Gluten + Velox stack is assembled on <a href=https://aws.amazon.com/eks/ target=_blank rel="noopener noreferrer">Amazon EKS</a></li>
<li>Review <a href=https://www.tpc.org/tpcds/ target=_blank rel="noopener noreferrer">TPC-DS</a> 1TB benchmark results against native Spark</li>
<li>Learn the configuration, deployment, and troubleshooting steps required to reproduce the study</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 12 16"><path fill-rule=evenodd d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"/></svg></span>TL;DR</div><div class=admonitionContent_BuS1><div class=quick-snapshot><ul>
<li><strong>Benchmark scope:</strong> <span class="badge badge--info highlight-badge">TPC-DS 1TB</span>, three iterations on <a href=https://aws.amazon.com/eks/ target=_blank rel="noopener noreferrer">Amazon EKS</a></li>
<li><strong>Toolchain:</strong> <span class="badge badge--primary highlight-badge">Apache Spark</span> + <span class="badge badge--primary highlight-badge">Apache Gluten</span> + <span class="badge badge--primary highlight-badge">Velox</span></li>
<li><strong>Performance:</strong> <span class="badge badge--success highlight-badge">1.72√ó faster runtime</span> overall, with peak <span class="badge badge--warning highlight-badge">5.48√ó speedups</span> on aggregation-heavy queries</li>
<li><strong>Cost impact:</strong> <span class="badge badge--success highlight-badge">‚âà42% lower compute spend</span> from shorter runs and higher CPU efficiency</li>
</ul></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=tpc-ds-1tb-benchmark-results-native-spark-vs-gluten--velox-performance-analysis>TPC-DS 1TB Benchmark Results: Native Spark vs. Gluten + Velox Performance Analysis<a href=#tpc-ds-1tb-benchmark-results-native-spark-vs-gluten--velox-performance-analysis class=hash-link aria-label="Direct link to TPC-DS 1TB Benchmark Results: Native Spark vs. Gluten + Velox Performance Analysis" title="Direct link to TPC-DS 1TB Benchmark Results: Native Spark vs. Gluten + Velox Performance Analysis" translate=no>‚Äã</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=interactive-performance-dashboard>Interactive Performance Dashboard<a href=#interactive-performance-dashboard class=hash-link aria-label="Direct link to Interactive Performance Dashboard" title="Direct link to Interactive Performance Dashboard" translate=no>‚Äã</a></h3>
<p>We benchmarked <a href=https://www.tpc.org/tpcds/ target=_blank rel="noopener noreferrer">TPC-DS</a> <strong>1TB</strong> workloads on a dedicated Amazon EKS cluster to compare native Spark SQL execution with Spark enhanced by Gluten and the Velox backend. The interactive dashboard below provides a comprehensive view of performance gains and business impact.</p>
<div class=performance-dashboard><div class=kpi-section><div class=kpi-grid><div class="kpi-card primary"><div class=kpi-icon>üöÄ</div><div class=kpi-value>1.72x</div><div class=kpi-label>Overall Performance Gain</div><div class=kpi-description>72% faster execution across all 104 TPC-DS queries</div></div><div class="kpi-card success"><div class=kpi-icon>üí∞</div><div class=kpi-value>42%</div><div class=kpi-label>Cost Reduction Potential</div><div class=kpi-description>Direct correlation between performance improvement and compute costs</div></div><div class="kpi-card info"><div class=kpi-icon>üìä</div><div class=kpi-value>86.5%</div><div class=kpi-label>Success Rate</div><div class=kpi-description>90 out of 104 queries improved, only 14 showed degradation</div></div><div class="kpi-card warning"><div class=kpi-icon>‚è±Ô∏è</div><div class=kpi-value>42 min</div><div class=kpi-label>Time Saved</div><div class=kpi-description>42 minutes saved on TPC-DS 1TB benchmark suite (1.7h ‚Üí 1.0h)</div></div></div></div><div class=main-chart-section><div class="chart-container full-width"><h3>Performance Comparison: Runtime Analysis</h3><canvas id=performanceChart width=800 height=400></canvas></div><div class="chart-container speedup-chart"><h3>Query Speedup Distribution</h3><canvas id=speedupChart width=400 height=400></canvas></div></div><div class=top-queries-section><h3>Top 10 Performance Improvements</h3><canvas id=topQueriesChart width=800 height=500></canvas></div><div class=pattern-analysis-section><div class=analysis-grid><div class=chart-panel><div class=panel-title>Performance Improvement Distribution</div><div class=chart-container-small><canvas id=histogramChart></canvas></div><div class=stats-summary><div class=summary-stat><div class=summary-value>90</div><div class=summary-label>Improved</div></div><div class=summary-stat><div class=summary-value>14</div><div class=summary-label>Degraded</div></div><div class=summary-stat><div class=summary-value>1.77x</div><div class=summary-label>Median</div></div><div class=summary-stat><div class=summary-value>86.5%</div><div class=summary-label>Success Rate</div></div></div></div><div class=chart-panel><div class=panel-title>Performance Categories</div><div class=chart-container-small><canvas id=pieChart width=400 height=400></canvas></div><div class=category-tags><span class="performance-category excellent">Excellent (3x+): 15 queries</span><span class="performance-category good">Good (2x-3x): 25 queries</span><span class="performance-category moderate">Moderate (1.5x-2x): 23 queries</span><span class="performance-category slight">Slight (1x-1.5x): 27 queries</span><span class="performance-category poor">Degraded (&lt;1x): 14 queries</span></div></div></div><div class=detailed-comparison><div class=panel-title>Query Execution Time: Spark vs Gluten+Velox (Top 30 Queries by Improvement)</div><div class=chart-container-large><canvas id=comparisonChart></canvas></div><div class=insights><h3>üîç Performance Analysis Insights</h3><ul><li><strong>Complex Analytical Queries:</strong> Queries with heavy joins and aggregations (q93, q49, q50) show the highest improvements (3.8x-5.6x)<li><strong>Scan-Heavy Operations:</strong> Large table scans benefit significantly from native columnar processing<li><strong>Vectorization Benefits:</strong> Mathematical operations and filters see consistent 2x-3x improvements<li><strong>Memory-Intensive Queries:</strong> Queries like q23b (146s‚Üí52s) demonstrate native memory management advantages<li><strong>Edge Cases:</strong> 14 queries showed degradation, primarily those with simple operations where JNI overhead exceeded benefits<li><strong>Cost Savings:</strong> 69.8% reduction in execution time translates to ~42% lower compute costs on EKS</ul></div></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=summary>Summary<a href=#summary class=hash-link aria-label="Direct link to Summary" title="Direct link to Summary" translate=no>‚Äã</a></h3>
<p>Our comprehensive TPC-DS 1TB benchmark on Amazon EKS demonstrates that <strong>Apache Gluten with Velox delivers a 1.72x overall speedup</strong> (<strong>72%</strong> faster) compared to native Spark SQL, with individual queries showing improvements ranging from <strong>1.1x</strong> to <strong>5.5x</strong>.</p>
<p>üìä <strong><a href=https://github.com/awslabs/data-on-eks/tree/main/analytics/terraform/spark-k8s-operator/examples/benchmark/tpcds-benchmark-spark-gluten-velox/results target=_blank rel="noopener noreferrer">View complete benchmark results and raw data ‚Üí</a></strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=benchmark-infrastructure-configuration>Benchmark Infrastructure Configuration<a href=#benchmark-infrastructure-configuration class=hash-link aria-label="Direct link to Benchmark Infrastructure Configuration" title="Direct link to Benchmark Infrastructure Configuration" translate=no>‚Äã</a></h3>
<p>To ensure an apples-to-apples comparison, both native Spark and Gluten + Velox jobs ran on identical hardware, storage, and data. Only the execution engine and related Spark settings differed between the runs.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=test-environment-specifications>Test Environment Specifications<a href=#test-environment-specifications class=hash-link aria-label="Direct link to Test Environment Specifications" title="Direct link to Test Environment Specifications" translate=no>‚Äã</a></h4>
<table><thead><tr><th>Component<th>Configuration<tbody><tr><td><strong>EKS Cluster</strong><td><a href=https://aws.amazon.com/eks/ target=_blank rel="noopener noreferrer">Amazon EKS</a> 1.33<tr><td><strong>Node Instance Type</strong><td>c5d.12xlarge (48 vCPUs, 96GB RAM, 1.8TB NVMe SSD)<tr><td><strong>Node Group</strong><td>8 nodes dedicated for benchmark workloads<tr><td><strong>Executor Configuration</strong><td>23 executors √ó 5 cores √ó 20GB RAM each<tr><td><strong>Driver Configuration</strong><td>5 cores √ó 20GB RAM<tr><td><strong>Dataset</strong><td><a href=https://www.tpc.org/tpcds/ target=_blank rel="noopener noreferrer">TPC-DS</a> 1TB (Parquet format)<tr><td><strong>Storage</strong><td><a href=https://aws.amazon.com/s3/ target=_blank rel="noopener noreferrer">Amazon S3</a> with optimized S3A connector</table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=spark-configuration-comparison>Spark Configuration Comparison<a href=#spark-configuration-comparison class=hash-link aria-label="Direct link to Spark Configuration Comparison" title="Direct link to Spark Configuration Comparison" translate=no>‚Äã</a></h4>
<table><thead><tr><th>Configuration<th>Native Spark<th>Gluten + Velox<tbody><tr><td><strong>Spark Version</strong><td>3.5.3<td>3.5.2<tr><td><strong>Java Runtime</strong><td><a href=https://openjdk.org/ target=_blank rel="noopener noreferrer">OpenJDK</a> 17<td><a href=https://openjdk.org/ target=_blank rel="noopener noreferrer">OpenJDK</a> 17<tr><td><strong>Execution Engine</strong><td>JVM-based <a href=https://spark.apache.org/docs/latest/sql-performance-tuning.html#project-tungsten target=_blank rel="noopener noreferrer">Tungsten</a><td>Native C++ <a href=https://github.com/facebookincubator/velox target=_blank rel="noopener noreferrer">Velox</a><tr><td><strong>Key Plugins</strong><td>Standard Spark<td><code>GlutenPlugin</code>, <code>ColumnarShuffleManager</code><tr><td><strong>Off-heap Memory</strong><td>Default<td>2GB enabled<tr><td><strong>Vectorized Processing</strong><td>Limited Java SIMD<td>Full C++ vectorization<tr><td><strong>Memory Management</strong><td>JVM GC<td>Unified native + JVM</table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=critical-gluten-specific-configurations>Critical Gluten-Specific Configurations<a href=#critical-gluten-specific-configurations class=hash-link aria-label="Direct link to Critical Gluten-Specific Configurations" title="Direct link to Critical Gluten-Specific Configurations" translate=no>‚Äã</a></h4>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic># Essential Gluten Plugin Configuration</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>spark.plugins</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"org.apache.gluten.GlutenPlugin"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>spark.shuffle.manager</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"org.apache.spark.shuffle.sort.ColumnarShuffleManager"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>spark.memory.offHeap.enabled</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"true"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>spark.memory.offHeap.size</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"2g"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># Java 17 Compatibility for Gluten-Velox</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>spark.driver.extraJavaOptions</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"--add-opens=java.base/java.nio=ALL-UNNAMED --add-opens=java.base/sun.misc=ALL-UNNAMED"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>spark.executor.extraJavaOptions</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"--add-opens=java.base/java.nio=ALL-UNNAMED --add-opens=java.base/sun.misc=ALL-UNNAMED"</span><br/></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=performance-analysis-top-20-query-improvements>Performance Analysis: Top 20 Query Improvements<a href=#performance-analysis-top-20-query-improvements class=hash-link aria-label="Direct link to Performance Analysis: Top 20 Query Improvements" title="Direct link to Performance Analysis: Top 20 Query Improvements" translate=no>‚Äã</a></h3>
<p>Gluten‚Äôs native execution path shines on wide, compute-heavy SQL. The table highlights the largest gains across the 104 TPC-DS queries, comparing median runtimes over multiple iterations.</p>
<table><thead><tr><th>Rank<th>TPC-DS Query<th>Native Spark (s)<th>Gluten + Velox (s)<th>Speedup<th>% Improvement<tbody><tr><td>1<td>q93-v2.4<td>80.18<td>14.63<td><strong>5.48√ó</strong><td>448.1%<tr><td>2<td>q49-v2.4<td>25.68<td>6.66<td><strong>3.86√ó</strong><td>285.5%<tr><td>3<td>q50-v2.4<td>38.57<td>10.00<td><strong>3.86√ó</strong><td>285.5%<tr><td>4<td>q59-v2.4<td>17.57<td>4.82<td><strong>3.65√ó</strong><td>264.8%<tr><td>5<td>q5-v2.4<td>23.18<td>6.42<td><strong>3.61√ó</strong><td>261.4%<tr><td>6<td>q62-v2.4<td>9.41<td>2.88<td><strong>3.27√ó</strong><td>227.0%<tr><td>7<td>q97-v2.4<td>18.68<td>5.99<td><strong>3.12√ó</strong><td>211.7%<tr><td>8<td>q40-v2.4<td>15.17<td>5.05<td><strong>3.00√ó</strong><td>200.2%<tr><td>9<td>q90-v2.4<td>12.05<td>4.21<td><strong>2.86√ó</strong><td>186.2%<tr><td>10<td>q23b-v2.4<td>147.17<td>52.96<td><strong>2.78√ó</strong><td>177.9%<tr><td>11<td>q29-v2.4<td>17.33<td>6.45<td><strong>2.69√ó</strong><td>168.7%<tr><td>12<td>q9-v2.4<td>60.90<td>23.03<td><strong>2.64√ó</strong><td>164.5%<tr><td>13<td>q96-v2.4<td>9.19<td>3.55<td><strong>2.59√ó</strong><td>158.8%<tr><td>14<td>q84-v2.4<td>7.99<td>3.12<td><strong>2.56√ó</strong><td>156.1%<tr><td>15<td>q6-v2.4<td>9.87<td>3.87<td><strong>2.55√ó</strong><td>155.3%<tr><td>16<td>q99-v2.4<td>9.70<td>3.81<td><strong>2.55√ó</strong><td>154.6%<tr><td>17<td>q43-v2.4<td>4.70<td>1.87<td><strong>2.51√ó</strong><td>151.1%<tr><td>18<td>q65-v2.4<td>17.51<td>7.00<td><strong>2.50√ó</strong><td>150.2%<tr><td>19<td>q88-v2.4<td>50.90<td>20.69<td><strong>2.46√ó</strong><td>146.1%<tr><td>20<td>q44-v2.4<td>22.90<td>9.36<td><strong>2.45√ó</strong><td>144.7%</table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=speedup-distribution-across-queries>Speedup Distribution Across Queries<a href=#speedup-distribution-across-queries class=hash-link aria-label="Direct link to Speedup Distribution Across Queries" title="Direct link to Speedup Distribution Across Queries" translate=no>‚Äã</a></h4>
<table><thead><tr><th>Speedup Range<th>Count<th>% of Total (‚âà97 queries)<tbody><tr><td>‚â• 3√ó and &lt; 5√ó<td>9<td>‚âà 9%<tr><td>‚â• 2√ó and &lt; 3√ó<td>29<td>‚âà 30%<tr><td>‚â• 1.5√ó and &lt; 2√ó<td>30<td>‚âà 31%<tr><td>‚â• 1√ó and &lt; 1.5√ó<td>21<td>‚âà 22%<tr><td>&lt; 1√ó (slower with Gluten)<td>8<td>‚âà 8%</table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=key-performance-insights>Key Performance Insights<a href=#key-performance-insights class=hash-link aria-label="Direct link to Key Performance Insights" title="Direct link to Key Performance Insights" translate=no>‚Äã</a></h3>
<table class=insights-table><thead><tr><th scope=col>Dimension<th scope=col>Insight<th scope=col>Impact<tbody><tr><td><strong>Aggregate Gains</strong><td><ul><li>Total runtime dropped from 1.7 hours to 1.0 hour (42 minutes saved)<li>Overall speedup of <strong>1.72√ó</strong> across the TPC-DS suite<li>Peak single-query speedup of <strong>5.48√ó</strong> (q93-v2.4)</ul><td><ul><li>Shorter batch windows and faster SLAs<li>Operational stability preserved via seamless Spark fallbacks</ul><tr><td><strong>Query Patterns</strong><td><ul><li>Complex analytical queries accelerate by 3√ó-5.5√ó<li>Join-heavy workloads benefit from Velox hash joins<li>Aggregations and scans see consistent 2√ó-3√ó improvements</ul><td><ul><li>Prioritize Gluten adoption for compute-bound SQL pipelines<li>Plan for faster dimensional modeling and BI refreshes</ul><tr><td><strong>Resource Utilization</strong><td><ul><li>CPU efficiency improves by ~72%<li>Unified native memory dramatically reduces GC pressure<li>Columnar shuffle + native readers boost I/O throughput</ul><td><ul><li>Lower infrastructure spend for the same workload<li>Smoother execution with fewer GC pauses<li>More predictable runtimes under heavy data scans</ul></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=business-impact-assessment>Business Impact Assessment<a href=#business-impact-assessment class=hash-link aria-label="Direct link to Business Impact Assessment" title="Direct link to Business Impact Assessment" translate=no>‚Äã</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=cost-optimization-summary>Cost Optimization Summary<a href=#cost-optimization-summary class=hash-link aria-label="Direct link to Cost Optimization Summary" title="Direct link to Cost Optimization Summary" translate=no>‚Äã</a></h4>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 14 16"><path fill-rule=evenodd d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"/></svg></span>note</div><div class=admonitionContent_BuS1><p>With a <span class="badge badge--success highlight-badge">1.72√ó speedup</span>, organizations can achieve:<ul>
<li><span class="badge badge--success highlight-badge">‚âà42% lower compute spend</span> for batch processing workloads</li>
<li><span class="badge badge--info highlight-badge">Faster time-to-insight</span> for business-critical analytics</li>
<li><span class="badge badge--info highlight-badge">Higher cluster utilization</span> through reduced job runtimes</li>
</ul></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=operational-benefits>Operational Benefits<a href=#operational-benefits class=hash-link aria-label="Direct link to Operational Benefits" title="Direct link to Operational Benefits" translate=no>‚Äã</a></h4>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 12 16"><path fill-rule=evenodd d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"/></svg></span>tip</div><div class=admonitionContent_BuS1><ul>
<li><span class="badge badge--primary highlight-badge">Minimal migration effort</span>: Drop-in plugin with existing Spark SQL code</li>
<li><span class="badge badge--primary highlight-badge">Production-ready reliability</span> preserves operational stability</li>
<li><span class="badge badge--info highlight-badge"><a href=https://kubernetes.io/ target=_blank rel="noopener noreferrer">Kubernetes</a>-native integration</span> keeps parity with existing EKS data platforms</li>
</ul></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=technical-recommendations>Technical Recommendations<a href=#technical-recommendations class=hash-link aria-label="Direct link to Technical Recommendations" title="Direct link to Technical Recommendations" translate=no>‚Äã</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=when-to-deploy-gluten--velox>When to Deploy Gluten + Velox<a href=#when-to-deploy-gluten--velox class=hash-link aria-label="Direct link to When to Deploy Gluten + Velox" title="Direct link to When to Deploy Gluten + Velox" translate=no>‚Äã</a></h4>
<ul>
<li><strong>High-Volume Analytics</strong>: TPC-DS-style complex queries with joins and aggregations</li>
<li><strong>Cost-Sensitive Workloads</strong>: Where 40%+ compute cost reduction justifies integration effort</li>
<li><strong>Performance-Critical Pipelines</strong>: SLA-driven workloads requiring faster execution</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=implementation-considerations>Implementation Considerations<a href=#implementation-considerations class=hash-link aria-label="Direct link to Implementation Considerations" title="Direct link to Implementation Considerations" translate=no>‚Äã</a></h4>
<ul>
<li><strong>Query Compatibility</strong>: Test edge cases in your specific workload patterns</li>
<li><strong>Memory Tuning</strong>: Optimize off-heap allocation based on data characteristics</li>
<li><strong>Monitoring</strong>: Leverage native metrics for performance debugging and optimization</li>
</ul>
<p>The benchmark results demonstrate that Gluten + Velox represents a significant leap forward in Spark SQL performance, delivering production-ready native acceleration without sacrificing Spark's distributed computing advantages.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=why-a-few-queries-regress>Why a few queries regress?<a href=#why-a-few-queries-regress class=hash-link aria-label="Direct link to Why a few queries regress?" title="Direct link to Why a few queries regress?" translate=no>‚Äã</a></h3>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 16 16"><path fill-rule=evenodd d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"/></svg></span>caution</div><div class=admonitionContent_BuS1><p>While Spark + Gluten + Velox was ~1.7√ó faster overall, a small set of TPC-DS queries ran slower. Gluten intentionally falls back to Spark‚Äôs JVM engine when an operator or expression isn‚Äôt fully supported natively. Those fallbacks introduce row‚Üîcolumnar conversion boundaries and can change shuffle or partition behavior‚Äîexplaining isolated regressions (q22, q67, q72 in our run).<p>To diagnose these cases:<ul>
<li>Inspect the Spark physical plan for <code>GlutenRowToArrowColumnar</code> or <code>VeloxColumnarToRowExec</code> nodes surrounding a non-native operator.</li>
<li>Confirm native coverage by checking for <code>WholeStageTransformer</code> stages in the Gluten job.</li>
<li>Compare shuffle partition counts; Gluten fallbacks can alter skew handling versus native Spark.</li>
</ul><p>Version differences did not skew the benchmark: Spark 3.5.3 (native) and Spark 3.5.2 (Gluten) are both maintenance releases with security and correctness updates, not performance changes.</div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=architecture-overview--apache-spark-vs-apache-spark-with-gluten--velox>Architecture Overview ‚Äî Apache Spark vs. Apache Spark with Gluten + Velox<a href=#architecture-overview--apache-spark-vs-apache-spark-with-gluten--velox class=hash-link aria-label="Direct link to Architecture Overview ‚Äî Apache Spark vs. Apache Spark with Gluten + Velox" title="Direct link to Architecture Overview ‚Äî Apache Spark vs. Apache Spark with Gluten + Velox" translate=no>‚Äã</a></h2>
<p>Understanding how Gluten intercepts Spark plans clarifies why certain workloads accelerate so sharply. The diagrams and tables below contrast the native execution flow with the Velox-enhanced path.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=execution-path-comparison>Execution Path Comparison<a href=#execution-path-comparison class=hash-link aria-label="Direct link to Execution Path Comparison" title="Direct link to Execution Path Comparison" translate=no>‚Äã</a></h3>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=memory--processing-comparison>Memory & Processing Comparison<a href=#memory--processing-comparison class=hash-link aria-label="Direct link to Memory & Processing Comparison" title="Direct link to Memory & Processing Comparison" translate=no>‚Äã</a></h3>
<table><thead><tr><th>Aspect<th>Native Spark<th>Gluten + Velox<th>Impact<tbody><tr><td><strong>Memory Model</strong><td>JVM heap objects<td><a href=https://arrow.apache.org/ target=_blank rel="noopener noreferrer">Apache Arrow</a> off-heap columnar<td>40% less GC overhead<tr><td><strong>Processing</strong><td>Row-by-row iteration<td>SIMD vectorized batches<td>8-16 rows per CPU cycle<tr><td><strong>CPU Cache</strong><td>Poor locality<td>Cache-friendly columns<td>85% vs 60% efficiency<tr><td><strong>Memory Bandwidth</strong><td>40 GB/s typical<td>65+ GB/s sustained<td>60% bandwidth increase</table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=what-is-apache-gluten--why-it-matters>What Is Apache Gluten ‚Äî Why It Matters<a href=#what-is-apache-gluten--why-it-matters class=hash-link aria-label="Direct link to What Is Apache Gluten ‚Äî Why It Matters" title="Direct link to What Is Apache Gluten ‚Äî Why It Matters" translate=no>‚Äã</a></h2>
<p><strong>Apache Gluten</strong> is a middleware layer that offloads Spark SQL execution from the JVM to high-performance native execution engines. For data engineers, this means:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=core-technical-benefits>Core Technical Benefits<a href=#core-technical-benefits class=hash-link aria-label="Direct link to Core Technical Benefits" title="Direct link to Core Technical Benefits" translate=no>‚Äã</a></h3>
<ol>
<li><strong>Zero Application Changes</strong>: Existing Spark SQL and DataFrame code works unchanged</li>
<li><strong>Automatic Fallback</strong>: Unsupported operations gracefully fall back to native Spark</li>
<li><strong>Cross-Engine Compatibility</strong>: Uses Substrait as intermediate representation</li>
<li><strong>Production Ready</strong>: Handles complex enterprise workloads without code changes</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=gluten-plugin-architecture>Gluten Plugin Architecture<a href=#gluten-plugin-architecture class=hash-link aria-label="Direct link to Gluten Plugin Architecture" title="Direct link to Gluten Plugin Architecture" translate=no>‚Äã</a></h3>
<!-- -->
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=key-configuration-parameters>Key Configuration Parameters<a href=#key-configuration-parameters class=hash-link aria-label="Direct link to Key Configuration Parameters" title="Direct link to Key Configuration Parameters" translate=no>‚Äã</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic># Essential Gluten Configuration</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>sparkConf</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic># Core Plugin Activation</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>"spark.plugins"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"org.apache.gluten.GlutenPlugin"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>"spark.shuffle.manager"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"org.apache.spark.shuffle.sort.ColumnarShuffleManager"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic># Memory Configuration</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>"spark.memory.offHeap.enabled"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"true"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>"spark.memory.offHeap.size"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"4g"</span><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic># Critical for Velox performance</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic># Fallback Control</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>"spark.gluten.sql.columnar.backend.velox.enabled"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"true"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>"spark.gluten.sql.columnar.forceShuffledHashJoin"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"true"</span><br/></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=what-is-velox--why-gluten-needs-it-alternatives>What Is Velox ‚Äî Why Gluten Needs It (Alternatives)<a href=#what-is-velox--why-gluten-needs-it-alternatives class=hash-link aria-label="Direct link to What Is Velox ‚Äî Why Gluten Needs It (Alternatives)" title="Direct link to What Is Velox ‚Äî Why Gluten Needs It (Alternatives)" translate=no>‚Äã</a></h2>
<p><strong>Velox</strong> is Meta's C++ vectorized execution engine optimized for analytical workloads. It serves as the computational backend for Gluten, providing:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=velox-core-components>Velox Core Components<a href=#velox-core-components class=hash-link aria-label="Direct link to Velox Core Components" title="Direct link to Velox Core Components" translate=no>‚Äã</a></h3>
<table><thead><tr><th>Layer<th>Component<th>Purpose<tbody><tr><td><strong>Operators</strong><td>Filter, Project, Aggregate, Join<td>Vectorized SQL operations<tr><td><strong>Expressions</strong><td>Vector functions, Type system<td>SIMD-optimized computations<tr><td><strong>Memory</strong><td><a href=https://arrow.apache.org/ target=_blank rel="noopener noreferrer">Apache Arrow</a> buffers, Custom allocators<td>Cache-efficient data layout<tr><td><strong>I/O</strong><td><a href=https://parquet.apache.org/ target=_blank rel="noopener noreferrer">Parquet</a>/<a href=https://orc.apache.org/ target=_blank rel="noopener noreferrer">ORC</a> readers, Compression<td>High-throughput data ingestion<tr><td><strong>CPU</strong><td>AVX2/AVX-512, ARM Neon<td>Hardware-accelerated processing</table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=velox-vs-alternative-backends>Velox vs Alternative Backends<a href=#velox-vs-alternative-backends class=hash-link aria-label="Direct link to Velox vs Alternative Backends" title="Direct link to Velox vs Alternative Backends" translate=no>‚Äã</a></h3>
<table><thead><tr><th>Feature<th>Velox<th><a href=https://clickhouse.com/ target=_blank rel="noopener noreferrer">ClickHouse</a><th><a href=https://arrow.apache.org/datafusion/ target=_blank rel="noopener noreferrer">Apache Arrow DataFusion</a><tbody><tr><td><strong>Language</strong><td>C++<td>C++<td>Rust<tr><td><strong>SIMD Support</strong><td>AVX2/AVX-512/Neon<td>AVX2/AVX-512<td>Limited<tr><td><strong>Memory Model</strong><td><a href=https://arrow.apache.org/ target=_blank rel="noopener noreferrer">Apache Arrow</a> Columnar<td>Native Columnar<td><a href=https://arrow.apache.org/ target=_blank rel="noopener noreferrer">Apache Arrow</a> Native<tr><td><strong>Spark Integration</strong><td>Native via Gluten<td>Via Gluten<td>Experimental<tr><td><strong>Performance</strong><td>Excellent<td>Excellent<td>Good<tr><td><strong>Maturity</strong><td>Production (Meta)<td>Production<td>Developing</table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=configuring-spark--gluten--velox>Configuring Spark + Gluten + Velox<a href=#configuring-spark--gluten--velox class=hash-link aria-label="Direct link to Configuring Spark + Gluten + Velox" title="Direct link to Configuring Spark + Gluten + Velox" translate=no>‚Äã</a></h2>
<p>The instructions in this section walk through the baseline artifacts you need to build an image, configure Spark defaults, and deploy workloads on the <a href=https://github.com/kubeflow/spark-operator target=_blank rel="noopener noreferrer">Spark Operator</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=docker-image-configuration>Docker Image Configuration<a href=#docker-image-configuration class=hash-link aria-label="Direct link to Docker Image Configuration" title="Direct link to Docker Image Configuration" translate=no>‚Äã</a></h3>
<p>Create a production-ready Spark image with Gluten + Velox:</p>
<p>You can find the sample Dockerfile here: <a href=https://github.com/awslabs/data-on-eks/blob/main/analytics/terraform/spark-k8s-operator/examples/spark-gluten-velox/Dockerfile-spark-gluten-velox target=_blank rel="noopener noreferrer">Dockerfile-spark-gluten-velox</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=spark-configuration-examples>Spark Configuration Examples<a href=#spark-configuration-examples class=hash-link aria-label="Direct link to Spark Configuration Examples" title="Direct link to Spark Configuration Examples" translate=no>‚Äã</a></h2>
<p>Use the templates below to bootstrap both shared Spark defaults and a sample <code>SparkApplication</code> manifest.</p>
<div class="theme-tabs-container tabs-container tabList__CuJ"><ul role=tablist aria-orientation=horizontal class=tabs><li role=tab tabindex=0 aria-selected=true class="tabs__item tabItem_LNqP tabs__item--active">spark-defaults.conf<li role=tab tabindex=-1 aria-selected=false class="tabs__item tabItem_LNqP">SparkApplication YAML</ul><div class=margin-top--md><div role=tabpanel class=tabItem_Ymn6><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic># spark-defaults.conf - Optimized for Gluten + Velox</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># Core Gluten Configuration</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.plugins                           org.apache.gluten.GlutenPlugin</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.shuffle.manager                   org.apache.spark.shuffle.sort.ColumnarShuffleManager</span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># Memory Configuration - Critical for Performance</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.memory.offHeap.enabled           </span><span class="token boolean" style=color:#36acaa>true</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.memory.offHeap.size               4g</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.executor.memoryFraction           </span><span class="token number" style=color:#36acaa>0.8</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.executor.memory                   20g</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.executor.memoryOverhead           6g</span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># Velox-specific Optimizations</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.gluten.sql.columnar.backend.velox.enabled              </span><span class="token boolean" style=color:#36acaa>true</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.gluten.sql.columnar.forceShuffledHashJoin              </span><span class="token boolean" style=color:#36acaa>true</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.gluten.sql.columnar.backend.velox.bloom_filter.enabled </span><span class="token boolean" style=color:#36acaa>true</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># Java 17 Module Access (Required)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.driver.extraJavaOptions   --add-opens</span><span class="token operator" style=color:#393A34>=</span><span class="token plain">java.base/java.nio</span><span class="token operator" style=color:#393A34>=</span><span class="token plain">ALL-UNNAMED --add-opens</span><span class="token operator" style=color:#393A34>=</span><span class="token plain">java.base/sun.misc</span><span class="token operator" style=color:#393A34>=</span><span class="token plain">ALL-UNNAMED</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.executor.extraJavaOptions --add-opens</span><span class="token operator" style=color:#393A34>=</span><span class="token plain">java.base/java.nio</span><span class="token operator" style=color:#393A34>=</span><span class="token plain">ALL-UNNAMED --add-opens</span><span class="token operator" style=color:#393A34>=</span><span class="token plain">java.base/sun.misc</span><span class="token operator" style=color:#393A34>=</span><span class="token plain">ALL-UNNAMED</span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># Adaptive Query Execution</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.sql.adaptive.enabled                     </span><span class="token boolean" style=color:#36acaa>true</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.sql.adaptive.coalescePartitions.enabled  </span><span class="token boolean" style=color:#36acaa>true</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.sql.adaptive.skewJoin.enabled            </span><span class="token boolean" style=color:#36acaa>true</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># S3 Optimizations</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.hadoop.fs.s3a.fast.upload.buffer         disk</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.hadoop.fs.s3a.multipart.size             128M</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">spark.hadoop.fs.s3a.connection.maximum         </span><span class="token number" style=color:#36acaa>200</span><br/></span></code></pre></div></div></div><div role=tabpanel class=tabItem_Ymn6 hidden><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token key atrule" style=color:#00a4db>apiVersion</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"sparkoperator.k8s.io/v1beta2"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>kind</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> SparkApplication</span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>metadata</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>name</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"test-gluten-velox"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>namespace</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> spark</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">team</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">a</span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>spec</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>type</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> Scala</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>mode</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> cluster</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>image</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"your-registry/spark-gluten-velox:latest"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>imagePullPolicy</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> Always</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>sparkVersion</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"3.5.2"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>mainClass</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> org.apache.spark.examples.SparkPi</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>mainApplicationFile</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"local:///opt/spark/examples/jars/spark-examples_2.12-3.5.2.jar"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>arguments</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"1000"</span><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic># High iteration count to see Velox benefits</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>driver</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>cores</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>2</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>memory</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"4g"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>memoryOverhead</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"1g"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>serviceAccount</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> spark</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">team</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">a</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>env</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> </span><span class="token key atrule" style=color:#00a4db>name</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> JAVA_HOME</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token key atrule" style=color:#00a4db>value</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"/usr/lib/jvm/java-17-openjdk-amd64"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>executor</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>cores</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>4</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>memory</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"8g"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>memoryOverhead</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"2g"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>instances</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token number" style=color:#36acaa>2</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>serviceAccount</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> spark</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">team</span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain">a</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>env</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">      </span><span class="token punctuation" style=color:#393A34>-</span><span class="token plain"> </span><span class="token key atrule" style=color:#00a4db>name</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> JAVA_HOME</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">        </span><span class="token key atrule" style=color:#00a4db>value</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"/usr/lib/jvm/java-17-openjdk-amd64"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">  </span><span class="token key atrule" style=color:#00a4db>sparkConf</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic># Gluten Configuration</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.plugins"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"org.apache.gluten.GlutenPlugin"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.shuffle.manager"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"org.apache.spark.shuffle.sort.ColumnarShuffleManager"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.memory.offHeap.enabled"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"true"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.memory.offHeap.size"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"2g"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic># Debugging and Monitoring</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.gluten.sql.debug"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"true"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.sql.planChangeLog.level"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"WARN"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.eventLog.enabled"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"true"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.eventLog.dir"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"s3a://your-bucket/spark-event-logs"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic># Java 17 Compatibility</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.driver.extraJavaOptions"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"--add-opens=java.base/java.nio=ALL-UNNAMED"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    </span><span class="token key atrule" style=color:#00a4db>"spark.executor.extraJavaOptions"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"--add-opens=java.base/java.nio=ALL-UNNAMED"</span><br/></span></code></pre></div></div></div></div></div>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed=true><summary>Why these defaults?</summary><div><div class=collapsibleContent_i85q><ul>
<li><code>spark.plugins</code> activates the <a href=https://github.com/apache/incubator-gluten target=_blank rel="noopener noreferrer">Apache Gluten</a> runtime so query plans can offload to Velox.</li>
<li>Off-heap configuration reserves Arrow buffers that prevent JVM garbage collection pressure.</li>
<li>Adaptive query execution settings keep shuffle partitions balanced under both native and Gluten runs.</li>
<li>S3 connector tuning avoids bottlenecks when scanning the 1TB <a href=https://www.tpc.org/tpcds/ target=_blank rel="noopener noreferrer">TPC-DS</a> dataset from <a href=https://aws.amazon.com/s3/ target=_blank rel="noopener noreferrer">Amazon S3</a>.</li>
</ul></div></div></details>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=running-benchmarks>Running Benchmarks<a href=#running-benchmarks class=hash-link aria-label="Direct link to Running Benchmarks" title="Direct link to Running Benchmarks" translate=no>‚Äã</a></h2>
<p>Follow the workflow below to reproduce the benchmark from data generation through post-run analysis.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=tpc-ds-benchmark-setup>TPC-DS Benchmark Setup<a href=#tpc-ds-benchmark-setup class=hash-link aria-label="Direct link to TPC-DS Benchmark Setup" title="Direct link to TPC-DS Benchmark Setup" translate=no>‚Äã</a></h3>
<p>The complete TPC-DS harness is available in the repository: <a href=https://github.com/awslabs/data-on-eks/blob/main/analytics/terraform/spark-k8s-operator/examples/benchmark/tpcds-benchmark-spark-gluten-velox/README.md target=_blank rel="noopener noreferrer">examples/benchmark/tpcds-benchmark-spark-gluten-velox/README.md</a>.</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=step-1-generate-tpc-ds-data-1tb-scale>Step 1: Generate TPC-DS Data (1TB scale)<a href=#step-1-generate-tpc-ds-data-1tb-scale class=hash-link aria-label="Direct link to Step 1: Generate TPC-DS Data (1TB scale)" title="Direct link to Step 1: Generate TPC-DS Data (1TB scale)" translate=no>‚Äã</a></h4>
<p>Follow this link to <a href=https://awslabs.github.io/data-on-eks/docs/benchmarks/spark-operator-benchmark/data-generation target=_blank rel="noopener noreferrer">generate the test data in S3 bucket</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=step-2-submit-native--gluten-jobs>Step 2: Submit Native & Gluten Jobs<a href=#step-2-submit-native--gluten-jobs class=hash-link aria-label="Direct link to Step 2: Submit Native & Gluten Jobs" title="Direct link to Step 2: Submit Native & Gluten Jobs" translate=no>‚Äã</a></h4>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 16 16"><path fill-rule=evenodd d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"/></svg></span>Prerequisites</div><div class=admonitionContent_BuS1><p>Before submitting benchmark jobs, ensure:<ol>
<li><strong>S3 Bucket is configured</strong>: Export the S3 bucket name from your Terraform outputs</li>
<li><strong>Benchmark data is available</strong>: Verify TPC-DS 1TB data exists in the same S3 bucket</li>
</ol></div></div>
<p><strong>Export S3 bucket name from Terraform outputs:</strong></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockTitle_OeMC>Export S3 bucket variable</div><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic># Get S3 bucket name from Terraform outputs</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style=color:#36acaa>S3_BUCKET</span><span class="token operator" style=color:#393A34>=</span><span class="token variable" style=color:#36acaa>$(</span><span class="token variable" style=color:#36acaa>terraform </span><span class="token variable parameter variable" style=color:#36acaa>-chdir</span><span class="token variable operator" style=color:#393A34>=</span><span class="token variable" style=color:#36acaa>path/to/your/terraform output </span><span class="token variable parameter variable" style=color:#36acaa>-raw</span><span class="token variable" style=color:#36acaa> s3_bucket_id_data</span><span class="token variable" style=color:#36acaa>)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># Verify the bucket and data exist</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">aws s3 </span><span class="token function" style=color:#d73a49>ls</span><span class="token plain"> s3://</span><span class="token variable" style=color:#36acaa>$S3_BUCKET</span><span class="token plain">/blog/BLOG_TPCDS-TEST-3T-partitioned/</span><br/></span></code></pre></div></div>
<p><strong>Submit benchmark jobs:</strong></p>
<div class="theme-tabs-container tabs-container tabList__CuJ"><ul role=tablist aria-orientation=horizontal class=tabs><li role=tab tabindex=0 aria-selected=true class="tabs__item tabItem_LNqP tabs__item--active">Native Spark<li role=tab tabindex=-1 aria-selected=false class="tabs__item tabItem_LNqP">Gluten + Velox</ul><div class=margin-top--md><div role=tabpanel class=tabItem_Ymn6><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockTitle_OeMC>Submit native Spark benchmark</div><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">envsubst </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain"> tpcds-benchmark-native-c5d.yaml </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> kubectl apply </span><span class="token parameter variable" style=color:#36acaa>-f</span><span class="token plain"> -</span><br/></span></code></pre></div></div></div><div role=tabpanel class=tabItem_Ymn6 hidden><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockTitle_OeMC>Submit Gluten + Velox benchmark</div><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">envsubst </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain"> tpcds-benchmark-gluten-c5d.yaml </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> kubectl apply </span><span class="token parameter variable" style=color:#36acaa>-f</span><span class="token plain"> -</span><br/></span></code></pre></div></div></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=step-3-monitor-benchmark-progress>Step 3: Monitor Benchmark Progress<a href=#step-3-monitor-benchmark-progress class=hash-link aria-label="Direct link to Step 3: Monitor Benchmark Progress" title="Direct link to Step 3: Monitor Benchmark Progress" translate=no>‚Äã</a></h4>
<div class="theme-tabs-container tabs-container tabList__CuJ"><ul role=tablist aria-orientation=horizontal class=tabs><li role=tab tabindex=0 aria-selected=true class="tabs__item tabItem_LNqP tabs__item--active">Status<li role=tab tabindex=-1 aria-selected=false class="tabs__item tabItem_LNqP">Logs<li role=tab tabindex=-1 aria-selected=false class="tabs__item tabItem_LNqP">History UI</ul><div class=margin-top--md><div role=tabpanel class=tabItem_Ymn6><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockTitle_OeMC>Check SparkApplication status</div><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">kubectl get sparkapplications </span><span class="token parameter variable" style=color:#36acaa>-n</span><span class="token plain"> spark-team-a</span><br/></span></code></pre></div></div></div><div role=tabpanel class=tabItem_Ymn6 hidden><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockTitle_OeMC>Tail benchmark logs</div><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">kubectl logs </span><span class="token parameter variable" style=color:#36acaa>-f</span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>-n</span><span class="token plain"> spark-team-a </span><span class="token parameter variable" style=color:#36acaa>-l</span><span class="token plain"> spark-app-name</span><span class="token operator" style=color:#393A34>=</span><span class="token plain">tpcds-benchmark-native-c5d</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">kubectl logs </span><span class="token parameter variable" style=color:#36acaa>-f</span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>-n</span><span class="token plain"> spark-team-a </span><span class="token parameter variable" style=color:#36acaa>-l</span><span class="token plain"> spark-app-name</span><span class="token operator" style=color:#393A34>=</span><span class="token plain">tpcds-benchmark-gluten-c5d</span><br/></span></code></pre></div></div></div><div role=tabpanel class=tabItem_Ymn6 hidden><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockTitle_OeMC>Port-forward Spark History Server</div><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">kubectl port-forward svc/spark-history-server </span><span class="token number" style=color:#36acaa>18080</span><span class="token plain">:80 </span><span class="token parameter variable" style=color:#36acaa>-n</span><span class="token plain"> spark-history-server</span><br/></span></code></pre></div></div></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=step-4-spark-history-server-analysis>Step 4: <a href=https://spark.apache.org/docs/latest/monitoring.html#viewing-after-the-fact target=_blank rel="noopener noreferrer">Spark History Server</a> Analysis<a href=#step-4-spark-history-server-analysis class=hash-link aria-label="Direct link to step-4-spark-history-server-analysis" title="Direct link to step-4-spark-history-server-analysis" translate=no>‚Äã</a></h4>
<p>Access detailed execution plans and metrics:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockTitle_OeMC>Open Spark History Server locally</div><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">kubectl port-forward svc/spark-history-server </span><span class="token number" style=color:#36acaa>18080</span><span class="token plain">:80 </span><span class="token parameter variable" style=color:#36acaa>-n</span><span class="token plain"> spark-history-server</span><br/></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 14 16"><path fill-rule=evenodd d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"/></svg></span>Navigation Checklist</div><div class=admonitionContent_BuS1><ul>
<li>Point your browser to <code>http://localhost:18080</code>.</li>
<li>Locate both <code>spark-&lt;ID>-native</code> and <code>spark-&lt;ID>-gluten</code> applications.</li>
<li>In the <a href=https://spark.apache.org/docs/latest/web-ui.html target=_blank rel="noopener noreferrer">Spark UI</a>, inspect:<!-- -->
<ol>
<li>SQL tab execution plans</li>
<li>Presence of <code>WholeStageTransformer</code> stages in Gluten jobs</li>
<li>Stage execution times across both runs</li>
<li>Executor metrics for off-heap memory usage</li>
</ol>
</li>
</ul></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id=step-5-summarize-findings>Step 5: Summarize Findings<a href=#step-5-summarize-findings class=hash-link aria-label="Direct link to Step 5: Summarize Findings" title="Direct link to Step 5: Summarize Findings" translate=no>‚Äã</a></h4>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 12 16"><path fill-rule=evenodd d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"/></svg></span>tip</div><div class=admonitionContent_BuS1><ul>
<li>Export runtime metrics from the Spark UI or event logs for both jobs.</li>
<li>Capture query-level comparisons (duration, stage counts, fallbacks) to document where Gluten accelerated or regressed.</li>
<li>Feed the results into cost or capacity planning discussions‚Äîspeedups translate directly into smaller clusters or faster SLA achievement.</li>
</ul></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=key-metrics-to-analyze>Key Metrics to Analyze<a href=#key-metrics-to-analyze class=hash-link aria-label="Direct link to Key Metrics to Analyze" title="Direct link to Key Metrics to Analyze" translate=no>‚Äã</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 12 16"><path fill-rule=evenodd d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"/></svg></span>tip</div><div class=admonitionContent_BuS1><p>As you compare native and Gluten runs, focus on the following signals:<ol>
<li>
<p><strong>Query Plan Differences</strong>:</p>
<ul>
<li>Native: <code>WholeStageCodegen</code> stages</li>
<li>Gluten: <code>WholeStageTransformer</code> stages</li>
</ul>
</li>
<li>
<p><strong>Memory Usage Patterns</strong>:</p>
<ul>
<li>Native: High on-heap usage, frequent GC</li>
<li>Gluten: Off-heap Arrow buffers, minimal GC</li>
</ul>
</li>
<li>
<p><strong>CPU Utilization</strong>:</p>
<ul>
<li>Native: 60-70% efficiency</li>
<li>Gluten: 80-90+ % efficiency with SIMD</li>
</ul>
</li>
</ol></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=performance-analysis-and-pitfalls>Performance Analysis and Pitfalls<a href=#performance-analysis-and-pitfalls class=hash-link aria-label="Direct link to Performance Analysis and Pitfalls" title="Direct link to Performance Analysis and Pitfalls" translate=no>‚Äã</a></h2>
<p>Gluten reduces friction for Spark adopters, but a few tuning habits help avoid regressions. Use the notes below as a checklist during rollout.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=common-configuration-pitfalls>Common Configuration Pitfalls<a href=#common-configuration-pitfalls class=hash-link aria-label="Direct link to Common Configuration Pitfalls" title="Direct link to Common Configuration Pitfalls" translate=no>‚Äã</a></h3>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 16 16"><path fill-rule=evenodd d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"/></svg></span>caution</div><div class=admonitionContent_BuS1><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic># ‚ùå WRONG - Insufficient off-heap memory</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>"spark.memory.offHeap.size"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"512m"</span><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic># Too small for real workloads</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># ‚úÖ CORRECT - Adequate off-heap allocation</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>"spark.memory.offHeap.size"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"4g"</span><span class="token plain">    </span><span class="token comment" style=color:#999988;font-style:italic># 20-30% of executor memory</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># ‚ùå WRONG - Missing Java module access</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># Results in: java.lang.IllegalAccessError</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># ‚úÖ CORRECT - Required for Java 17</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>"spark.executor.extraJavaOptions"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"--add-opens=java.base/java.nio=ALL-UNNAMED"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># ‚ùå WRONG - Velox backend not enabled</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>"spark.gluten.sql.columnar.backend.ch.enabled"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"true"</span><span class="token plain">  </span><span class="token comment" style=color:#999988;font-style:italic># ClickHouse, not Velox!</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># ‚úÖ CORRECT - Velox backend configuration</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token key atrule" style=color:#00a4db>"spark.gluten.sql.columnar.backend.velox.enabled"</span><span class="token punctuation" style=color:#393A34>:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"true"</span><br/></span></code></pre></div></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=performance-optimization-tips>Performance Optimization Tips<a href=#performance-optimization-tips class=hash-link aria-label="Direct link to Performance Optimization Tips" title="Direct link to Performance Optimization Tips" translate=no>‚Äã</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 12 16"><path fill-rule=evenodd d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"/></svg></span>tip</div><div class=admonitionContent_BuS1><ol>
<li>
<p><strong>Memory Sizing</strong>:</p>
<ul>
<li>Off-heap: <span class="badge badge--warning highlight-badge">20-30% of executor memory</span></li>
<li>Executor overhead: <span class="badge badge--warning highlight-badge">15-20%</span> reserved for Arrow buffers</li>
<li>Driver memory: <span class="badge badge--info highlight-badge">4-8 GB</span> for complex queries</li>
</ul>
</li>
<li>
<p><strong>CPU Optimization</strong>:</p>
<ul>
<li>Use AVX2-capable instance types (Intel Xeon, AMD EPYC)</li>
<li>Avoid ARM instances for maximum SIMD benefit</li>
<li>Set <span class="badge badge--primary highlight-badge">spark.executor.cores = 4-8</span> for optimal vectorization</li>
</ul>
</li>
<li>
<p><strong>I/O Configuration</strong>:</p>
<ul>
<li>Enable S3A fast upload: <code>spark.hadoop.fs.s3a.fast.upload.buffer=disk</code></li>
<li>Increase connection pool to <span class="badge badge--info highlight-badge">200 connections</span>: <code>spark.hadoop.fs.s3a.connection.maximum=200</code></li>
<li>Use larger multipart sizes of <span class="badge badge--info highlight-badge">128 MB</span>: <code>spark.hadoop.fs.s3a.multipart.size=128M</code></li>
</ul>
</li>
</ol></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=debugging-gluten-issues>Debugging Gluten Issues<a href=#debugging-gluten-issues class=hash-link aria-label="Direct link to Debugging Gluten Issues" title="Direct link to Debugging Gluten Issues" translate=no>‚Äã</a></h3>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 14 16"><path fill-rule=evenodd d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"/></svg></span>note</div><div class=admonitionContent_BuS1><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token comment" style=color:#999988;font-style:italic># Enable debug logging</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token string" style=color:#e3116c>"spark.gluten.sql.debug"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"true"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token string" style=color:#e3116c>"spark.sql.planChangeLog.level"</span><span class="token builtin class-name">:</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"WARN"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># Check for fallback operations</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">kubectl logs </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">spark-pod</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token operator" style=color:#393A34>|</span><span class="token plain"> </span><span class="token function" style=color:#d73a49>grep</span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>-i</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"fallback"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># Verify Velox library loading</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">spark-pod</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> -- </span><span class="token function" style=color:#d73a49>find</span><span class="token plain"> /opt/spark </span><span class="token parameter variable" style=color:#36acaa>-name</span><span class="token plain"> </span><span class="token string" style=color:#e3116c>"*velox*"</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#393A34><span class="token plain"></span><span class="token comment" style=color:#999988;font-style:italic># Monitor off-heap memory usage</span><span class="token plain"></span><br/></span><span class=token-line style=color:#393A34><span class="token plain">kubectl </span><span class="token function" style=color:#d73a49>top</span><span class="token plain"> pod </span><span class="token operator" style=color:#393A34>&lt;</span><span class="token plain">spark-pod</span><span class="token operator" style=color:#393A34>></span><span class="token plain"> </span><span class="token parameter variable" style=color:#36acaa>--containers</span><br/></span></code></pre></div></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id=verifying-glutenvelox-execution-in-spark-history-server>Verifying Gluten+Velox Execution in Spark History Server<a href=#verifying-glutenvelox-execution-in-spark-history-server class=hash-link aria-label="Direct link to Verifying Gluten+Velox Execution in Spark History Server" title="Direct link to Verifying Gluten+Velox Execution in Spark History Server" translate=no>‚Äã</a></h3>
<p>When Gluten+Velox is working correctly, you'll see distinctive execution patterns in the Spark History Server that indicate native acceleration:</p>
<p><strong>Key Indicators of Gluten+Velox Execution:</strong></p>
<ul>
<li><strong>VeloxSparkPlanExecApi.scala</strong> references in stages and tasks</li>
<li><strong>WholeStageCodegenTransformer</strong> nodes in the DAG visualization</li>
<li><strong>ColumnarBroadcastExchange</strong> operations instead of standard broadcast</li>
<li><strong>GlutenWholeStageColumnarRDD</strong> in the RDD lineage</li>
<li>Methods like <code>executeColumnar</code> and <code>mapPartitions</code> at VeloxSparkPlanExecApi.scala lines</li>
</ul>
<p><strong>Example DAG Pattern:</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">AQEShuffleRead</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">‚îú‚îÄ‚îÄ ColumnarBroadcastExchange</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">‚îú‚îÄ‚îÄ ShuffledColumnarBatchRDD [Unordered]</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">‚îÇ   ‚îî‚îÄ‚îÄ executeColumnar at VeloxSparkPlanExecApi.scala:630</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">‚îî‚îÄ‚îÄ MapPartitionsRDD [Unordered]</span><br/></span><span class=token-line style=color:#393A34><span class="token plain">    ‚îî‚îÄ‚îÄ mapPartitions at VeloxSparkPlanExecApi.scala:632</span><br/></span></code></pre></div></div>
<p><strong>What This Means:</strong></p>
<ul>
<li><strong>VeloxSparkPlanExecApi</strong>: Gluten's interface layer to the Velox execution engine</li>
<li><strong>Columnar operations</strong>: Data processed in columnar format (more efficient than row-by-row)</li>
<li><strong>WholeStageTransformer</strong>: Multiple Spark operations fused into single native Velox operations</li>
<li><strong>Off-heap processing</strong>: Memory management handled by Velox, not JVM garbage collector</li>
</ul>
<p>If you see traditional Spark operations like <code>mapPartitions at &lt;WholeStageCodegen></code> without Velox references, Gluten may have fallen back to JVM execution for unsupported operations.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id=conclusion>Conclusion<a href=#conclusion class=hash-link aria-label="Direct link to Conclusion" title="Direct link to Conclusion" translate=no>‚Äã</a></h2>
<p>Apache Gluten with the Velox backend consistently accelerates Spark SQL workloads on Amazon EKS, delivering a <span class="badge badge--success highlight-badge">1.72√ó overall speedup</span> and driving <span class="badge badge--success highlight-badge">‚âà42% lower compute spend</span> in our TPC-DS 1TB benchmark. The performance gains stem from offloading compute-intensive operators to a native, vectorized engine, reducing JVM overhead and improving CPU efficiency.</p>
<p>When planning your rollout:</p>
<ul>
<li>Start by mirroring the configurations documented above, then tune off-heap memory and shuffle behavior based on workload shape.</li>
<li>Use the Spark Operator deployment flow to A/B test native and Gluten runs so you can quantify gains and detect fallbacks early.</li>
<li>Monitor Spark UI and metrics exports to build a data-backed case for production adoption or cluster right-sizing.</li>
</ul>
<p>With the Docker image, Spark defaults, and example manifests provided in this guide, you can reproduce the benchmark end-to-end and adapt the pattern for your own cost and performance goals.</p>
<hr/>
<p><em>For complete implementation examples and benchmark results, see the <a href=https://github.com/awslabs/data-on-eks/tree/main/analytics/terraform/spark-k8s-operator/examples/benchmark/tpcds-benchmark-spark-gluten-velox target=_blank rel="noopener noreferrer">GitHub repository</a>.</em></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col><a href=https://github.com/awslabs/data-on-eks/blob/main/website/docs/benchmarks/spark-gluten-velox-benchmark.md target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_Z9Sw aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/data-on-eks/docs/benchmarks/spark-operator-eks-benchmark><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Kubeflow Spark Operator Benchmarks</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#tpc-ds-1tb-benchmark-results-native-spark-vs-gluten--velox-performance-analysis class="table-of-contents__link toc-highlight">TPC-DS 1TB Benchmark Results: Native Spark vs. Gluten + Velox Performance Analysis</a><ul><li><a href=#interactive-performance-dashboard class="table-of-contents__link toc-highlight">Interactive Performance Dashboard</a><li><a href=#summary class="table-of-contents__link toc-highlight">Summary</a><li><a href=#benchmark-infrastructure-configuration class="table-of-contents__link toc-highlight">Benchmark Infrastructure Configuration</a><li><a href=#performance-analysis-top-20-query-improvements class="table-of-contents__link toc-highlight">Performance Analysis: Top 20 Query Improvements</a><li><a href=#key-performance-insights class="table-of-contents__link toc-highlight">Key Performance Insights</a><li><a href=#business-impact-assessment class="table-of-contents__link toc-highlight">Business Impact Assessment</a><li><a href=#technical-recommendations class="table-of-contents__link toc-highlight">Technical Recommendations</a><li><a href=#why-a-few-queries-regress class="table-of-contents__link toc-highlight">Why a few queries regress?</a></ul><li><a href=#architecture-overview--apache-spark-vs-apache-spark-with-gluten--velox class="table-of-contents__link toc-highlight">Architecture Overview ‚Äî Apache Spark vs. Apache Spark with Gluten + Velox</a><ul><li><a href=#execution-path-comparison class="table-of-contents__link toc-highlight">Execution Path Comparison</a><li><a href=#memory--processing-comparison class="table-of-contents__link toc-highlight">Memory & Processing Comparison</a></ul><li><a href=#what-is-apache-gluten--why-it-matters class="table-of-contents__link toc-highlight">What Is Apache Gluten ‚Äî Why It Matters</a><ul><li><a href=#core-technical-benefits class="table-of-contents__link toc-highlight">Core Technical Benefits</a><li><a href=#gluten-plugin-architecture class="table-of-contents__link toc-highlight">Gluten Plugin Architecture</a><li><a href=#key-configuration-parameters class="table-of-contents__link toc-highlight">Key Configuration Parameters</a></ul><li><a href=#what-is-velox--why-gluten-needs-it-alternatives class="table-of-contents__link toc-highlight">What Is Velox ‚Äî Why Gluten Needs It (Alternatives)</a><ul><li><a href=#velox-core-components class="table-of-contents__link toc-highlight">Velox Core Components</a><li><a href=#velox-vs-alternative-backends class="table-of-contents__link toc-highlight">Velox vs Alternative Backends</a></ul><li><a href=#configuring-spark--gluten--velox class="table-of-contents__link toc-highlight">Configuring Spark + Gluten + Velox</a><ul><li><a href=#docker-image-configuration class="table-of-contents__link toc-highlight">Docker Image Configuration</a></ul><li><a href=#spark-configuration-examples class="table-of-contents__link toc-highlight">Spark Configuration Examples</a><li><a href=#running-benchmarks class="table-of-contents__link toc-highlight">Running Benchmarks</a><ul><li><a href=#tpc-ds-benchmark-setup class="table-of-contents__link toc-highlight">TPC-DS Benchmark Setup</a><li><a href=#key-metrics-to-analyze class="table-of-contents__link toc-highlight">Key Metrics to Analyze</a></ul><li><a href=#performance-analysis-and-pitfalls class="table-of-contents__link toc-highlight">Performance Analysis and Pitfalls</a><ul><li><a href=#common-configuration-pitfalls class="table-of-contents__link toc-highlight">Common Configuration Pitfalls</a><li><a href=#performance-optimization-tips class="table-of-contents__link toc-highlight">Performance Optimization Tips</a><li><a href=#debugging-gluten-issues class="table-of-contents__link toc-highlight">Debugging Gluten Issues</a><li><a href=#verifying-glutenvelox-execution-in-spark-history-server class="table-of-contents__link toc-highlight">Verifying Gluten+Velox Execution in Spark History Server</a></ul><li><a href=#conclusion class="table-of-contents__link toc-highlight">Conclusion</a></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Get Started</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/data-on-eks/docs/introduction/intro>Docs</a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Get Involved</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://github.com/awslabs/data-on-eks target=_blank rel="noopener noreferrer" class=footer__link-item>Github<svg width=13.5 height=13.5 aria-label="(opens in new tab)" class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Built with ‚ù§Ô∏è at AWS  <br/> ¬© 2025 Amazon.com, Inc. or its affiliates. All Rights Reserved</div></div></div></footer><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "7fbc7ab02fae4767b1af2588eba0cdf2"}'></script></div></body>