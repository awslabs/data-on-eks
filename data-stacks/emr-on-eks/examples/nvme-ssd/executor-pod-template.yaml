# EMR on EKS Executor Pod Template - NVMe SSD Storage (Graviton ONLY)
# Uses Graviton instances WITH NVMe SSDs for high-performance shuffle
# Karpenter automatically configures RAID0 for NVMe drives under /mnt/k8s-disks/0
apiVersion: v1
kind: Pod
metadata:
  name: emr-executor
  namespace: emr-data-team-a
spec:
  volumes:
    # EBS storage on root volume
    - name: spark-local-dir-1
      hostPath:
        path: /mnt/k8s-disks/0
        type: DirectoryOrCreate

  nodeSelector:
    # Use memory-optimized Graviton nodepool
    NodeGroupType: SparkGravitonMemoryOptimized
    node.kubernetes.io/arch: arm64

  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          # Only Graviton memory-optimized instance families (r6gd, r7gd, r8gd )
          - key: karpenter.k8s.aws/instance-family
            operator: In
            values: ["r6gd", "r7gd", "r8gd"]

  tolerations:
    - key: spark-executor
      operator: Equal
      value: "true"
      effect: NoSchedule

  initContainers:
    - name: volume-permission
      image: public.ecr.aws/docker/library/busybox
      # Grant volume access to hadoop user (UID 999, GID 1000)
      command: ['sh', '-c', 'mkdir -p /data1; chown -R 999:1000 /data1']
      volumeMounts:
        - name: spark-local-dir-1
          mountPath: /data1

  containers:
    - name: spark-kubernetes-executor # Don't change this name - EMR on EKS requires it
      volumeMounts:
        - name: spark-local-dir-1
          mountPath: /data1
          readOnly: false
